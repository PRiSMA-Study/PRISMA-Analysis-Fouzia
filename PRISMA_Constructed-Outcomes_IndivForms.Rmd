---
title: "PRISMA_ Maternal-Infant-Constructed-Outcomes - Individual Forms"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output: pdf_document
---
Constructed variables: 
https://docs.google.com/spreadsheets/d/1dfOWoZNm0RipnIRIucHt3kAFiPl3nISD3U2jA3btKXo/edit#gid=252197818

Data dictionary: 
https://docs.google.com/spreadsheets/d/1Q9MMoQP9_Ldhzi6R0mxE8LBzsLQ92djw/edit?pli=1#gid=1356168077

CRFs: 
https://www.dropbox.com/home/PRiSMA/PRISMA%20CRFs%20and%20Data%20Dictionary/CRFs%20Active%20(MAR272023)


#TODO: 
# 1. Need to look at Visit=13 and forms MNH19 (hospitalization) coding and MNH20-23 also.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
library(ThemePark)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
```
The varname structure for the newly integrated forms (hospitalizations, adverse events, and protocol deviation) are as follows:
“M[xx]_varname_VISIT[y], where [xx] is the form number and [y] is the visit sequence number (i.e. if first hospitalization, this will be 1, second hospitalization will be 2…..)

```{r}
# path_to_data <- 'Z:/SynapseCSVs/Kenya/2023-07-28/' # If MNH*.xlsx files are located elsewhere, set this to, for example, 'data/' or '//TNT/...'
# path_to_data <- 'Z:/Processed Data/2023-07-28/'

path_to_data <- 'Z:/Stacked Data/2023-08-11' 
```

```{r}
########################################################################################
recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################

if(recreate_mnh_list == TRUE){
  mnh_list <- list() # create an empty list first.
  list_mnh <- dir(path = path_to_data, pattern = "*csv", full.names = TRUE) #creates a list of all the csv files in the directory
  for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
    form_num <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
    #basename() pulls out just the name of the file from the entire directory/path. 
    print(paste("Reading", form_num))
    mnh_list[[form_num]] <- read.csv(data_file)
  }
  saveRDS(mnh_list, file = paste0("MNH_list_", basename(path_to_data), ".RDS")) 
}

mnh_list <- readRDS("MNH_list_2023-08-11.RDS")  #read in the RDS objects with all the MNH files as a massive list.  
```

Hard code TYPE_VISIT for M00=1, M02=1, M03=1,  M09=6, M10=6, M11=6, M17=6, M18=12
```{r}
if("mnh00" %in% names(mnh_list)){
  mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% 
    mutate(M00_TYPE_VISIT = 1) 
} else{
  "MNH00 doesn't exist in the list"
}

if("mnh02" %in% names(mnh_list)){
  mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>% 
    mutate(M02_TYPE_VISIT = 1) 
} else{
  "MNH02 doesn't exist in the list"
}

if("mnh03" %in% names(mnh_list)){
  mnh_list[["mnh03"]] <- mnh_list[["mnh03"]] %>% 
    mutate(M03_TYPE_VISIT = 1) 
} else{
  "MNH03 doesn't exist in the list"
}

if("mnh09" %in% names(mnh_list)){
  mnh_list[["mnh09"]] <- mnh_list[["mnh09"]] %>% 
    mutate(M09_TYPE_VISIT = 6) 
} else{
  "MNH09 doesn't exist in the list"
}

if("mnh10" %in% names(mnh_list)){
  mnh_list[["mnh10"]] <- mnh_list[["mnh10"]] %>% 
    mutate(M10_TYPE_VISIT = 6) 
} else{
  "MNH10 doesn't exist in the list"
}

if("mnh11" %in% names(mnh_list)){
  mnh_list[["mnh11"]] <- mnh_list[["mnh11"]] %>% 
    mutate(M11_TYPE_VISIT = 6) 
} else{
  "MNH11 doesn't exist in the list"
}

if("mnh17" %in% names(mnh_list)){
  mnh_list[["mnh17"]] <- mnh_list[["mnh17"]] %>% 
    mutate(M17_TYPE_VISIT = 6) 
} else{
  "MNH17 doesn't exist in the list"
}

if("mnh16" %in% names(mnh_list)){
  mnh_list[["mnh16"]] <- mnh_list[["mnh16"]] %>% 
    mutate(M16_TYPE_VISIT = 5) 
} else{
  "MNH16 doesn't exist in the list"
}

if("mnh18" %in% names(mnh_list)){
  mnh_list[["mnh18"]] <- mnh_list[["mnh18"]] %>% 
    mutate(M18_TYPE_VISIT = 12) 
} else{
  "MNH18 doesn't exist in the list"
}

```

Change wrong values for MNH01 TYPE_VISIT (value was 36 but SL mentioned it probably is week 36 so visit 5)
```{r}
   
mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% 
   mutate(M01_TYPE_VISIT = ifelse(M01_TYPE_VISIT == 36, 5, M01_TYPE_VISIT))
```


```{r}
mnh_list_wide <- list()

#Once I run through this code, I will no longer have TYPE_VISIT variable in my mnh_list_wide datasets. 
for (form_name in names(mnh_list)) {
    print(form_name)
    var_prefix <- paste0('M',substr(form_name, 4, 5))
    if(!(paste0(var_prefix, "_TYPE_VISIT") %in% names(mnh_list[[form_name]]))){ #if type_visit variable doesn't exist then skip it, but still copy the data frame to the list of wide frames (otherwise that MNH data will not be included).
      mnh_list_wide[[form_name]] <- mnh_list[[form_name]]
      next
    }
    mnh_list_wide[[form_name]] <- mnh_list[[form_name]] %>% # do the pivot here
      filter(MOMID!="") %>%
      filter(!is.na(MOMID)) %>%
      distinct (MOMID, PREGID, paste0(var_prefix, '_TYPE_VISIT'), .keep_all = TRUE) %>% #keeps a single row of duplicate rows based on MOMID, _TYPE_VISIT, and PREGID.
      filter(get(paste0(var_prefix, '_TYPE_VISIT'))!=13) %>%
      pivot_wider(id_cols = c('SITE', 'MOMID', 'PREGID'),
              names_from = paste0(var_prefix, '_TYPE_VISIT'),
              values_from = starts_with(var_prefix) & !ends_with('_TYPE_VISIT'),
              values_fill = NA)
}

#temp.df <- mnh_list[['mnh01']] %>% select(SITE, M01_TYPE_VISIT, MOMID, PREGID, SCRNID) %>%
 # group_by(SITE, M01_TYPE_VISIT, MOMID, PREGID, SCRNID) %>%
  #summarise(n = n())
```

 
```{r}
# mnh_list[["mnh01"]]$SCRNID # how to access a variable in a particular form list. This works in dplyr also

#########
# MNH00 #
#########
mnh00_df <- mnh_list_wide[["mnh00"]] %>% dplyr::select(SITE, MOMID, PREGID, 
                                                  M00_KNOWN_DOBYN_SCORRES_1, 
                                                  M00_BRTHDAT_1, M00_ESTIMATED_AGE_1)

#########
# MNH01 #
#########
mnh01_df <- mnh_list_wide[["mnh01"]] %>% dplyr::select(SITE, MOMID, PREGID, M01_US_OHOLOC_1, 
                                                       M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
                                                       M01_US_GA_WKS_AGE_FTS1_1,
                                                       M01_US_GA_WKS_AGE_FTS2_1, M01_US_GA_WKS_AGE_FTS2_1,
                                                       M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_WKS_AGE_FTS4_1,
                                                       M01_US_GA_DAYS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS2_1,
                                                       M01_US_GA_DAYS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS4_1,
                                                       M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
                                                       starts_with(c("M01_US_OHOSTDAT")))

#########
# MNH04 #
#########
mnh04_df <- mnh_list_wide[["mnh04"]] %>% dplyr::select(SITE, MOMID, PREGID, M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2,
                                                M04_FETAL_LOSS_DSSTDAT_3,
                                                M04_FETAL_LOSS_DSSTDAT_4, M04_FETAL_LOSS_DSSTDAT_5,
                                                 M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
                                                M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4,
                                                M04_FETAL_LOSS_DSSTDAT_5,
                                                M04_FETAL_LOSS_DSDECOD_1, M04_FETAL_LOSS_DSDECOD_2, 
                                                M04_FETAL_LOSS_DSDECOD_3, M04_FETAL_LOSS_DSDECOD_4,
                                                M04_FETAL_LOSS_DSDECOD_5,  M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
                                                M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4, 
                                                M04_FETAL_LOSS_DSSTDAT_5, M04_FETAL_LOSS_DSDECOD_1,
                                                M04_FETAL_LOSS_DSDECOD_2,M04_FETAL_LOSS_DSDECOD_3,
                                                M04_FETAL_LOSS_DSDECOD_4, M04_FETAL_LOSS_DSDECOD_5)

#########
# MNH06 #
#########
mnh06_df <- mnh_list_wide[["mnh06"]] %>% dplyr::select(SITE, MOMID, PREGID,   
                                                       # Maternal anemia:
                                                       starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_")))

#########
# MNH08 #
#########
mnh08_df <- mnh_list_wide[["mnh08"]] %>% dplyr::select(SITE, MOMID, PREGID,  
                                                       starts_with(c("M08_LBSTDAT_", "M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES")))

#################################
# MNH09 - Maternal L&D Outcomes #
#################################
mnh09_df <- mnh_list_wide[["mnh09"]] %>% dplyr::select(SITE, MOMID, PREGID,                                              
                                                       M09_CRY_CEOCCUR_INF1_6, M09_FHR_VSTAT_INF1_6, 
                                                       M09_MACER_CEOCCUR_INF1_6,M09_CORD_PULS_CEOCCUR_INF1_6,
                                                       M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, 
                                                       M09_BIRTH_DSTERM_INF3_6, M09_BIRTH_DSTERM_INF4_6,
                                                       starts_with(c("M09_DELIV_DSSTDAT_INF", "M09_BIRTH_DSTERM_INF")))
#########
# MNH10 #
#########
mnh10_df <- mnh_list_wide[["mnh10"]] %>% dplyr::select(SITE, MOMID, PREGID,
                                                M10_MAT_DSTERM_6)

###############
# MNH11 - PNC #
###############
mnh11_df <- mnh_list_wide[["mnh11"]] %>% dplyr::select(SITE, MOMID, PREGID,
                                                M11_DTHDAT_6)


#########
# MNH19 #
#########
#M19_PREG_FAORES (try: the variable is there but called M19_PREG_FAORRES_VISIT{x} where {x} 
# is the visit number based on total number of visits or To see the total number of MNH19 
#forms filled out by an individual, refer to M19_VISITS_TOT)
if("mnh19" %in% names(mnh_list_wide)){
mnh19_df <- mnh_list_wide[["mnh19"]] %>% dplyr::select(SITE, MOMID, PREGID,
                                                starts_with(c("M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", 
                                                              "M19_CBC_HB_LBORRES_VISIT",
                                                              "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT")))
} else{
  "MNH19 does not exist in the wide format"
}
                                                              

#############################
# MNH23 - Maternal Closeout #
#############################
if("mnh23" %in% names(mnh_list_wide)){
mnh23_df <- mnh_list_wide[["mnh23"]] %>% dplyr::select(SITE, MOMID, PREGID,
                                                M23_CLOSE_DSDECOD, M23_ACC_DDORRES, M23_DTHDAT,
                                                M23_CLOSE_DSDECOD, M23_DTHDAT)
} else{
  "MNH23 does not exist in the wide format"
}


###########################
# MNH24 - Infant Closeout #
###########################
if("mnh24" %in% names(mnh_list_wide)){
mnh24_df <- mnh_list_wide[["mnh24"]] %>% dplyr::select(SITE, MOMID, PREGID,
                                                M24_DTHDAT)
} else{
  "MNH24 does not exist in the wide format"
}

```

# Merge together all the forms.
```{r}
mnh_merged_df <- mnh00_df
for(i in 1:26) {
  form_name <- paste0("mnh", sprintf(fmt="%02d", i), "_df") #sprintf adds a leading 0 to digits below 10.
  if(exists(form_name)) {
    mnh_merged_df <- left_join(mnh_merged_df, get(form_name), by = c("SITE", "MOMID", "PREGID"))
  }
}
```

# Convert "1907-07-07" to NA:
```{r}
mnh_merged_df <- mnh_merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
  mutate_all(function(d) {
              if_else(d=="1907-07-07", NA, d)
            })

typeof(mnh_merged_df$M00_BRTHDAT_1)
```

Fetal/Infant outcomes
1. GA_BOE: use US_GA_DAYS_AGE_FTS1,2,3,4 and US_GA_WKS_AGE_FTS1,2,3,4 to calculate the biggest fetus.  Use the biggest fetus to do the calculations for GA_DIFF_WKS and GA_DIFF_DAYS.  In the constructed outcomes sheets, it is not listed correctly (b/c only asking to use first fetus)
2. Use the biggest infant using US and GA_LMP_WEEKS_SCORRES and GA_LMP_DAYS to calc. variable GA_DIFF_WKS and GA_DIFF_DAYS 
```{r}
# STEP 1:
mnh_merged_df <- mnh_merged_df %>% 
  rowwise() %>% mutate(biggest_M01_US_GA_DAYS_FTS = max(((M01_US_GA_WKS_AGE_FTS1_1*7) + M01_US_GA_DAYS_AGE_FTS1_1),
                                     ((M01_US_GA_WKS_AGE_FTS2_1*7) + M01_US_GA_DAYS_AGE_FTS2_1),
                                     ((M01_US_GA_WKS_AGE_FTS3_1*7) + M01_US_GA_DAYS_AGE_FTS3_1),
                                     ((M01_US_GA_WKS_AGE_FTS4_1*7) + M01_US_GA_DAYS_AGE_FTS4_1), na.rm = TRUE)) %>%
  mutate(biggest_M01_US_GA_DAYS_FTS = if_else(biggest_M01_US_GA_DAYS_FTS<0, NA, biggest_M01_US_GA_DAYS_FTS)) # <0 covers '-Inf' cases and where it's only -7.

# STEP 2: 
mnh_merged_df <- mnh_merged_df %>% 
  rowwise() %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = (M01_GA_LMP_WEEKS_SCORRES_1*7)+ M01_GA_LMP_DAYS_SCORRES_1) %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = if_else(M01_GA_LMP_DAYS_CALC_1<0, NA, M01_GA_LMP_DAYS_CALC_1))

# STEP 3: 
mnh_merged_df <- mnh_merged_df %>%
  dplyr::mutate(GA_DIFF_WKS = (M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS) %/% 7, # Floor of the number of weeks used here. 
                GA_DIFF_DAYS = M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS)

table(mnh_merged_df$GA_DIFF_WKS, mnh_merged_df$GA_DIFF_DAYS, useNA = "always")
```

If the GA by LMP is less than 9 weeks 0 days:
- If discrepancy between LMP and US ≤5 days = GA by LMP
- If LMP unknown or discrepancy between LMP and US ≥5 days = GA by US

If the GA by LMP is between 9 weeks 0 days and 15 weeks 6 days:
- If discrepancy between LMP and US ≤7 days → BOE = GA by LMP
- If LMP is unknown OR discrepancy between LMP and US ≥7 days = GA by US

If GA by LMP is greater than 16 weeks 0 days:
- If discrepancy between LMP and US ≤10 days = GA by LMP
- If LMP is unknown or discrepancy between LMP and US ≥10 days = GA by US

```{r}
mnh_merged_df <- mnh_merged_df %>%
  mutate(GA_BOE = case_when(M01_GA_LMP_DAYS_CALC_1 %/% 7 < 9 ~ 
                              if_else(abs(GA_DIFF_DAYS) <= 5, 
                                      M01_GA_LMP_DAYS_CALC_1, 
                                      biggest_M01_US_GA_DAYS_FTS),
                            M01_GA_LMP_DAYS_CALC_1 %/% 7 < 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=7, 
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                             M01_GA_LMP_DAYS_CALC_1 %/% 7 >= 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=10,
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                            TRUE ~ biggest_M01_US_GA_DAYS_FTS)) %>% 
  mutate(GA_BOE_WKS = GA_BOE %/% 7,
         GA_BOE_DAYS = GA_BOE %% 7)

mnh_merged_df <- mnh_merged_df %>% 
  mutate(diff_GA = abs(M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS))

# table(diff_LMP_US = temp.df$diff_GA, temp.df$SITE, useNA = "always")

table(GA_BOE = mnh_merged_df$GA_BOE_WKS, mnh_merged_df$SITE,  useNA = "always")

table(mnh_merged_df$M01_GA_LMP_DAYS_CALC_1, mnh_merged_df$SITE, useNA = "always")
```

Neonatal mortality (Death of a live born baby during the first 28 days of life from any cause. )

L&D: M09_DELIV_DSSTDAT_INF1	Date of delivery:
L&D: M09_BIRTH_DSTERM_INF1	Birth outcome
PNC: M11_DTHDAT	Specify date of death
Inf Close-out: M24_DTHDAT	Record date of death
Do this for all 4 infants:
If (birth outcome == fetal death) --> NEO_DTH==0
If (birth outcome == live & date of death <= (date of birth + 28 days)) --> NEO_DTH==1
***WHY DO WE NEED M11_DTHDAT --> MATERNAL DEATH DATE - DOES IT HAVE ANYTHING TO DO WITH NEONATAL MORTALITY?***
***HOW COME M24_DTHDAT DOESN'T BLONG TO EACH OF THE MULTIPLE GESTATIONS -->***
     ***Stacie said: mnh24 is filled out for each infant so if there is a multiples birth and you have inf 1 and inf 2,     then they will each have their own MNH24 form***
     ***Stacie said to just do different merges for mom's forms and for infant forms***
     
```{r}
mnh_merged_df <- mnh_merged_df %>% 
  mutate(NEO_DTH_1 = case_when(M09_BIRTH_DSTERM_INF1_6 ==2 ~ 0,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF1_6, units="days")<=28 ~1,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF1_6, units="days")>28 ~0,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 is.na(M24_DTHDAT) ~0,
                               TRUE ~ as.integer(NA))) 

mnh_merged_df <- mnh_merged_df %>% 
  mutate(NEO_DTH_2 = case_when(M09_BIRTH_DSTERM_INF2_6 ==2 ~ 0,
                               M09_BIRTH_DSTERM_INF2_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF2_6, units="days")<=28 ~1,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF2_6, units="days")>28 ~0,
                               M09_BIRTH_DSTERM_INF2_6 == 1 & 
                                 is.na(M24_DTHDAT) ~0,
                               TRUE ~ as.integer(NA))) 

mnh_merged_df <- mnh_merged_df %>% 
  mutate(NEO_DTH_3 = case_when(M09_BIRTH_DSTERM_INF3_6 ==2 ~ 0,
                               M09_BIRTH_DSTERM_INF3_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF3_6, units="days")<=28 ~1,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF3_6, units="days")>28 ~0,
                               M09_BIRTH_DSTERM_INF3_6 == 1 & 
                                 is.na(M24_DTHDAT) ~0,
                               TRUE ~ as.integer(NA)))

mnh_merged_df <- mnh_merged_df %>% 
  mutate(NEO_DTH_4 = case_when(M09_BIRTH_DSTERM_INF4_6 ==2 ~ 0,
                               M09_BIRTH_DSTERM_INF4_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF4_6, units="days")<=28 ~1,
                               M09_BIRTH_DSTERM_INF1_6 == 1 & 
                                 difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF4_6, units="days")>28 ~0,
                               M09_BIRTH_DSTERM_INF4_6 == 1 & 
                                 is.na(M24_DTHDAT) ~0,
                               TRUE ~ as.integer(NA))) 
temp.df <- mnh_merged_df %>% 
  select(M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, M09_BIRTH_DSTERM_INF3_6,
         M09_DELIV_DSSTDAT_INF4_6, M24_DTHDAT, NEO_DTH_4)

temp.df <- mnh_merged_df %>% select(NEO_DTH_1, NEO_DTH_2, NEO_DTH_3, NEO_DTH_4)
  
mnh_merged_df <- mnh_merged_df %>% 
  mutate(NEO_DTH = case_when((NEO_DTH_1 == 1 | NEO_DTH_2 == 1 | NEO_DTH_3 == 1 | NEO_DTH_4) == 1 ~ 1,
                             (is.na(NEO_DTH_1) & is.na(NEO_DTH_2) & is.na(NEO_DTH_3) & is.na(NEO_DTH_4) ~ as.integer(NA)),
                             TRUE ~ 0))
  
```
####################
#MATERNAL OUTCOMES:
####################

*Pregnancy-related death:*
"Death from any cause during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

M09_DELIV_DSSTDAT_INF1,2,3,4
M10_MAT_DSTERM
M23_CLOSE_DSDECOD
M23_DTHDAT

CLOSE_DSDECOD==1 | 2 then MAT_DEATH=1 (1=Alive)
CLOSE_DSDECOD==2 (2=Alive)
CLOSE_DSDECOD==4 | 5 | 6 then MAT_DEATH=9

```{r}
temp.df <- mnh_merged_df %>%
  # mutate_if(is.Date, #is.Date is asking the variable (entire col) is a date type or not.
  #           function(d) {
  #             if_else(d == as.Date("1907-07-07"), as.Date(NA), as.Date(d))
  #           }) %>%
  mutate(var_w_deliverydate = any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6, #'any' is checking if anything in these columns by row(dplyr is doing the by-row part) is NA.
  M09_DELIV_DSSTDAT_INF2_6,
  M09_DELIV_DSSTDAT_INF3_6,
  M09_DELIV_DSSTDAT_INF4_6)))) %>% 
  rowwise() %>%
  mutate(PREG_DEATH = if_else(M23_CLOSE_DSDECOD == 3 | !is.na(M23_DTHDAT), 
                              if_else(var_w_deliverydate,
                                      as.numeric(as.Date(M23_DTHDAT) - as.Date(max(M09_DELIV_DSSTDAT_INF1_6,
                                                                          M09_DELIV_DSSTDAT_INF2_6, 
                                                                          M09_DELIV_DSSTDAT_INF3_6,
                                                                          M09_DELIV_DSSTDAT_INF4_6, 
                                                                          na.rm = TRUE))<
                                                   as.difftime(42, units = "days")),
                                      1), 
                              0)) %>% 
  mutate(PREG_DEATH = if_else(M23_CLOSE_DSDECOD==4 | M23_CLOSE_DSDECOD==5, 9, PREG_DEATH))

table(PREG_DEATH=temp.df$PREG_DEATH, SITE=temp.df$SITE, useNA = "always")
```

*Maternal Anemia*
Definition: Low hemoglobin levels and/or diagnosis of anemia in pregnancy, at labor and delivery, and through 6 months postpartum. 
Variable: MAT_ANEMIA_ANY

Create: MAT_ANEMIA_MEAS
"1, Mild
2, Moderate
3, Severe
0, None

using: 
"ANC
L&D
PNC
Hospitalization"

MNH06	DIAG_VSDAT
MNH06	TYPE_VISIT
MNH06	HB_POC_LBORRES
MNH08	LBSTDAT
MNH08	TYPE_VISIT
MNH08	CBC_HB_LBORRES
MNH09	DELIV_DSSTDAT_INF1
MNH19	TIMING_OHOCAT
MNH19	CBC_LBDAT
MNH19	CBC_HB_LBORRES
MNH19	HB_POC_LBTSTDAT
MNH19	HB_POC_LBORRES

//Maternal anemia in pregnancy
mutate(MAT_ANEMIA_MEAS = 1
if ((MNH06_TYPE_VISIT==1 | MNH06_TYPE_VISIT==2 | MNH06_TYPE_VISIT==3 | MNH06_TYPE_VISIT==4) & (MNH06_SPHB_LBORRES, 10, 10.9) | (MNH06_HB_POC_LBORRES,10,10.9))) | ((MNH08_TYPE_VISIT==1 | MNH08_TYPE_VISIT==2 | MNH08_TYPE_VISIT==3 | MNH08_TYPE_VISIT==4) & (MNH08_CBC_HB_LBORRES,10,10.9)) | (MNH19_TIMING_OHOCAT==1 & (M19_HB_POC_LBORRES,10,10.9) | (M19_CBC_HB_LBORRES,10,10.9))

mutate(MAT_ANEMIA_MEAS = 1
if ((M06_TYPE_VISIT_1 ==1 | M06_TYPE_VISIT_2==2 | M06_TYPE_VISIT_3==3 | M06_TYPE_VISIT_==4) & between(MNH06_HB_POC_LBORRES,10,10.9))) | ((M08_TYPE_VISIT_1==1 | M08_TYPE_VISIT_2==2 | M08_TYPE_VISIT_3==3 | M08_TYPE_VISIT_4==4) & (M08_CBC_HB_LBORRES,10,10.9)) | (M19_TIMING_OHOCAT==1 & (MNH19_HB_POC_LBORRES,10,10.9) | (MNH19_CBC_HB_LBORRES,10,10.9)) #TODO Are we ignoring SpHb measurements for this var?

Another idea:
Create anemia levels for each ANC Visit
WHO Hb thresholds g/dl:
Mild: 10.0-10.9
Moderate: 7.0-9.9
Severe: <7
Normal: <=11.0
Excess Hb: >13

Create: MAT_ANEMIA_DIAG

***WHAT IF POC IS 11.3 SAY AND CBC IS 8.0? WHICH ONE SHOULD BE USED TO CLASSIFY***
***MNH08_CBC_HB_LBORRES_3 (VISIT 3) variable is not present***
```{r}
##############
# ANC VISITS # 
##############
# Visit 3 doesn't have M08_CBC_HB_LBORRES_3:
mnh_merged_df$M08_CBC_HB_LBORRES_3 <- ifelse("M08_CBC_HB_LBORRES_3" %in% names(mnh_merged_df),
                                             mnh_merged_df$M08_CBC_HB_LBORRES_3, NA)

mnh_merged_df$M08_CBC_HB_LBORRES_4 <- ifelse("M08_CBC_HB_LBORRES_4" %in% names(mnh_merged_df),
                                             mnh_merged_df$M08_CBC_HB_LBORRES_4, NA)

mnh_merged_df$M08_CBC_HB_LBORRES_5 <- ifelse("M08_CBC_HB_LBORRES_5" %in% names(mnh_merged_df),
                                             mnh_merged_df$M08_CBC_HB_LBORRES_5, NA)

# VISIT 6 doesn't have M06_HB_POC_LBORRES_6:it's optional at L&D to do MNH08 and MNH06:
mnh_merged_df$M06_HB_POC_LBORRES_6 <- ifelse("M06_HB_POC_LBORRES_6" %in% names(mnh_merged_df),
                                             mnh_merged_df$M06_HB_POC_LBORRES_6, NA) 

mnh_merged_df$M08_CBC_HB_LBORRES_6 <- ifelse("M08_CBC_HB_LBORRES_6" %in% names(mnh_merged_df),
                                             mnh_merged_df$M08_CBC_HB_LBORRES_6, NA)

# VISIT 10 doesn't have M08_CBC_HB_LBORRES_10: 
mnh_merged_df$M08_CBC_HB_LBORRES_10 <- ifelse("M08_CBC_HB_LBORRES_10" %in% names(mnh_merged_df),
                                             mnh_merged_df$M08_CBC_HB_LBORRES_10, NA) 


#if(!("M08_CBC_HB_LBORRES_3" %in% names(mnh_merged_df))){
 # mnh_merged_df$M08_CBC_HB_LBORRES_3 <- NA
#}

mnh_merged_df <- mnh_merged_df %>% #[1:200, ] %>%
  select(SITE, MOMID, PREGID, (starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT")))  %>%
  
  #SETTING UP VISIT 1 - enrollment.
  mutate(MAT_ANEMIA_MEAS1 = case_when(between(M06_HB_POC_LBORRES_1, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_1, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_1, 7.0, 9.9) | 
                                        between(M08_CBC_HB_LBORRES_1, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_1, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_1, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_1, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_1, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_1 > 12.9) |
                                        (M08_CBC_HB_LBORRES_1 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>%

# temp.df2 <- temp.df %>% select(SITE, M06_HB_POC_LBORRES_1, M08_CBC_HB_LBORRES_1, MAT_ANEMIA_MEAS1)
  
  #SETTING UP VISIT 2 - ANC20.
  mutate(MAT_ANEMIA_MEAS2 = case_when(between(M06_HB_POC_LBORRES_2, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_2, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_2, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_2, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_2, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_2, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_2, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_2, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_2 > 12.9) |
                                        (M08_CBC_HB_LBORRES_2 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>% 
  
    #SETTING UP VISIT 3 - ANC28.
  mutate(MAT_ANEMIA_MEAS3 = case_when(between(M06_HB_POC_LBORRES_3, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_3, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_3, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_3, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_3, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_3, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_3, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_3, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_3 > 12.9) |
                                        (M08_CBC_HB_LBORRES_3 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>% 
  
      #SETTING UP VISIT 4 - ANC32.
  mutate(MAT_ANEMIA_MEAS4 = case_when(between(M06_HB_POC_LBORRES_4, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_4, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_4, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_4, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_4, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_4, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_4, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_4, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_4 > 12.9) |
                                        (M08_CBC_HB_LBORRES_4 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>% 
    
      #SETTING UP VISIT 5 - ANC36.
  mutate(MAT_ANEMIA_MEAS5 = case_when(between(M06_HB_POC_LBORRES_5, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_5, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_5, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_5, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_5, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_5, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_5, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_5, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_5 > 12.9) |
                                        (M08_CBC_HB_LBORRES_5 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>% 
  
        #SETTING UP VISIT 6 - IPC (L&D).
  mutate(MAT_ANEMIA_MEAS6 = case_when(between(M06_HB_POC_LBORRES_6, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_6, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_6, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_6, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_6, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_6, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_6, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_6, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_6 > 12.9) |
                                        (M08_CBC_HB_LBORRES_6 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA))) %>% 
  
################################# NOTE ##################################################
# PNC 0, 1, 4, 52 (VISITS 7,8,9, 12) DON'T HAVE LAB VISITS; ONLY HAVE POC DIAGNOSTICS TP)
#########################################################################################  
        #SETTING UP VISIT 10 - PNC 6.
  mutate(MAT_ANEMIA_MEAS10 = case_when(between(M06_HB_POC_LBORRES_10, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_10, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_10, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_10, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_10, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_10, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_10, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_10, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_10 > 12.9) |
                                        (M08_CBC_HB_LBORRES_10 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA)))# 
  
          #SETTING UP VISIT 11 - PNC 26.
  mutate(MAT_ANEMIA_MEAS11 = case_when(between(M06_HB_POC_LBORRES_11, 10, 10.9)|
                                        between(M08_CBC_HB_LBORRES_11, 10, 10.9)~"mild",
                                      between(M06_HB_POC_LBORRES_11, 7.0, 9.9) |
                                        between(M08_CBC_HB_LBORRES_11, 7.0, 9.9)~"moderate",
                                      between(M06_HB_POC_LBORRES_11, 6.9, 0) |
                                        between(M08_CBC_HB_LBORRES_11, 6.9, 0)~"severe",
                                      between(M06_HB_POC_LBORRES_11, 11, 12.9) |
                                        between(M08_CBC_HB_LBORRES_11, 11, 12.9)~"normal",
                                      (M06_HB_POC_LBORRES_11 > 12.9) |
                                        (M08_CBC_HB_LBORRES_11 > 12.9)~"excess_hb",
                                      TRUE ~ as.character(NA)))



temp.df2 <- mnh_merged_df %>% select(SITE, M06_HB_POC_LBORRES_1, M08_CBC_HB_LBORRES_1, MAT_ANEMIA_MEAS1, 
                               M06_HB_POC_LBORRES_2, M08_CBC_HB_LBORRES_2, MAT_ANEMIA_MEAS2)

table(mnh_merged_df$MAT_ANEMIA_MEAS3, mnh_merged_df$SITE, useNA = "always")                                      
table(mnh_merged_df$MAT_ANEMIA_MEAS4, mnh_merged_df$SITE, useNA = "always")
table(mnh_merged_df$MAT_ANEMIA_MEAS6, mnh_merged_df$SITE, useNA = "always")
```

***ANEMIA DURING L&D - use IPD TP - VISIT 6***

```{r}

```

*DONT NEED THIS CHUNCK FOR NOW. WAS WORKING TO SEE IF AT ANY VISIT HEMOGLOBIN LEVELS ARE AS NEEDED - THIS WAY EVERYONE TURNS OUT TO BE ANEMIC B/C AT LEAST ONE VISIT, IT'S LOW*
```{r}
  mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & #at least 1 visit is non-missing 
                                        if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))  ~ 1,
                                     TRUE ~ 2)) %>% select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4,
                                                           M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2, 
                                                           M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, MAT_ANEMIA_MEAS)
```


```{r}

temp.df <- mat_inf_subset_df[1:20, ] %>%
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & #at least 1 visit is non-missing 
                                        if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))  ~ 1,
                                     TRUE ~ 2)) %>% select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4,
                                                           M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2, 
                                                           M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, MAT_ANEMIA_MEAS)

temp.df <- mat_inf_subset_df[1:20, ] %>%
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES_", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  
  mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                          if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))   ~ 1,
                                     TRUE ~ 2)) %>% select(M08_TYPE_VISIT_1, M08_TYPE_VISIT_2, M08_TYPE_VISIT_3, M08_TYPE_VISIT_4,
                                                           M08_CBC_HB_LBORRES_1, M08_CBC_HB_LBORRES_2, 
                                                           M08_CBC_HB_LBORRES_3, M08_CBC_HB_LBORRES_4, MAT_ANEMIA_MEAS1)

```



```{r}
#TODO Pull out these columns and see what they look like. Atm all are 1. 
temp.df <- mat_inf_subset_df %>% 
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  
  mutate(MAT_ANEMIA_MEAS = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                        if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
                                       
                                       (if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                          if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
                                       
                                       (if_any(num_range('M19_TIMING_OHOCAT_VISIT_', 1:3), ~ .==1) &
                                          (if_any(num_range('M19_HB_POC_LBORRES_', 1:4), ~ between(.x,10,10.9)) |
                                             
                                             if_any(num_range('M19_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))) ~ 1,
                                     TRUE ~ 2)) %>% 
  select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4, 
         M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2,M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, 
         MAT_ANEMIA_MEAS)

# Using library Purrr here
# .x placeholder for each of the variable inside if_any. Can use just "." if it's not inside a function.
# Lambda function used here = it's a little expression inside of something. It's not a function that's defined outside. 

table(mat_inf_subset_df$M19_TIMING_OHOCAT_VISIT3, useNA = "always")

```


```{r}


```


# May not need what's below: 
```{r}
mnh01_df <- mnh_list[["mnh01"]] %>% 
  select(SITE, MOMID, PREGID,
         M01_GA_LMP_WEEKS_SCORRES, M01_GA_LMP_DAYS_SCORRES,
         M01_US_GA_WKS_AGE_FTS1,M01_US_GA_WKS_AGE_FTS2, 
         M01_US_GA_WKS_AGE_FTS3, M01_US_GA_WKS_AGE_FTS4,
         M01_US_GA_DAYS_AGE_FTS1, M01_US_GA_DAYS_AGE_FTS2,
         M01_US_GA_DAYS_AGE_FTS3, M01_US_GA_DAYS_AGE_FTS4)

sort(colnames(mnh_list[["mnh04"]]))
mnh_df <- left_join(mnh01_df, 
                 (mnh_list[["mnh04"]] %>% select(SITE, MOMID, PREGID,  
                                                 M04_FETAL_LOSS_DSSTDAT,M04_FETAL_LOSS_DSSTDAT_2,
                                                 M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4, 
                                                 M04_FETAL_LOSS_DSSTDAT_5,)), 
                 by = c("SITE", "MOMID", "PREGID"))
  
  
  # Create a data subset from maternal and infant files:

inf_subset_df <- InfData_Wide %>% dplyr::select(SITE, MOMID, PREGID, INFANTID, 
                                                M11_INF_DSTERM,
                                                M11_BW_FAORRES, M11_BW_EST_FAORRES,
                                                M11_BREATH_FAIL_CEOCCUR,
                                                M11_INF_DSTERM, M11_BW_FAORRES, M11_BW_EST_FAORRES) %>%
  dplyr::filter(!is.na(MOMID)) %>%
  dplyr::filter(!is.na(PREGID)) %>%
  dplyr::filter(!is.na(INFANTID))

mat_subset_df <- MatData_Wide %>% dplyr::select(SITE, MOMID, PREGID, SCRNID, DOB, M01_US_OHOLOC_1, 
                                                M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2,
                                                M04_FETAL_LOSS_DSSTDAT_3,
                                                M04_FETAL_LOSS_DSSTDAT_4, M04_FETAL_LOSS_DSSTDAT_5,
                                                M09_DELIV_DSSTDAT_INF1_6, M09_BIRTH_DSTERM_INF1_6,
                                                M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
                                                M01_US_GA_WKS_AGE_FTS1_1,
                                                M01_US_GA_WKS_AGE_FTS2_1, M01_US_GA_WKS_AGE_FTS2_1,
                                                M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_WKS_AGE_FTS4_1,
                                                M01_US_GA_DAYS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS2_1,
                                                M01_US_GA_DAYS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS4_1,
                                                M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
                                                M09_CRY_CEOCCUR_INF1_6, M09_FHR_VSTAT_INF1_6, M09_MACER_CEOCCUR_INF1_6,
                                                M09_CORD_PULS_CEOCCUR_INF1_6,
                                                M01_US_OHOSTDAT_1, M01_US_OHOSTDAT_2, M01_US_OHOSTDAT_3, 
                                                M01_US_OHOSTDAT_4, M01_US_OHOSTDAT_5,
                                                M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
                                                M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4,
                                                M04_FETAL_LOSS_DSSTDAT_5,
                                                M04_FETAL_LOSS_DSDECOD_1, M04_FETAL_LOSS_DSDECOD_2, 
                                                M04_FETAL_LOSS_DSDECOD_3, M04_FETAL_LOSS_DSDECOD_4,
                                                M04_FETAL_LOSS_DSDECOD_5,
                                                M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
                                                M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6,
                                                M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, 
                                                M09_BIRTH_DSTERM_INF3_6, M09_BIRTH_DSTERM_INF4_6,
                                                M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
                                                M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6,
                                                M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, 
                                                M09_BIRTH_DSTERM_INF3_6, M09_BIRTH_DSTERM_INF4_6, 
                                                M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
                                                M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4, 
                                                M04_FETAL_LOSS_DSSTDAT_5, M04_FETAL_LOSS_DSDECOD_1,
                                                M04_FETAL_LOSS_DSDECOD_2,M04_FETAL_LOSS_DSDECOD_3,
                                                M04_FETAL_LOSS_DSDECOD_4, M04_FETAL_LOSS_DSDECOD_5,
                                                M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
                                                M09_DELIV_DSSTDAT_INF3_6,  M09_DELIV_DSSTDAT_INF4_6,
                                                M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, 
                                                M09_BIRTH_DSTERM_INF3_6, M09_BIRTH_DSTERM_INF4_6,
                                                M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6,
                                                M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6,
                                                M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_ACC_DDORRES, M23_DTHDAT,
                                                M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_DTHDAT, 
                                                #M19_PREG_FAORES (try: the variable is there but called M19_PREG_FAORRES_VISIT{x} where {x} 
                                                # is the visit number based on total number of visits or To see the total number of MNH19 
                                                #forms filled out by an individual, refer to M19_VISITS_TOT)
                                                # Maternal anemia:
                                                starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_")), 
                                                starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                                                              "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                                                              "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  
  
  dplyr::filter(!is.na(MOMID)) %>%
  dplyr::filter(!is.na(PREGID)) %>%
  dplyr::filter(MOMID != "")

temp.df <- mat_subset_df %>% group_by(SITE, MOMID) %>%
  filter(n()>1) %>% ungroup()

temp.df <- inf_subset_df %>% group_by(SITE, MOMID, PREGID) %>%
  filter(n()>1) %>% ungroup() # Shows 25 IDs that are b/c of 12 twins and 1 INFANT ID that is 'n/a' and has the same PREGID as the twins. Will remove this row. Dataset will have n=12 twin pregnancies.

mat_inf_subset_df <- left_join(mat_subset_df, inf_subset_df, by = c("SITE", "MOMID", "PREGID"))

mat_inf_subset_df <- mat_inf_subset_df %>% dplyr::filter(if_else(is.na(INFANTID), TRUE,
                                                                  INFANTID != "n/a")) # Have to be very careful with NA in a logical expression.  Dplyr filter only includes rows where the expression is TRUE but not where it's FALSE or NA.

# mat_inf_subset: 3360 makes sense b/c n=12 twin pregnancies so 12 extra rows in the mat_subset_df of 3348.  


# Stacie: 2543 enrolled and we have 3015 have an MNH02 (Screened but not enrolled.).
# B/c there is no enrollment yes/no variable, Stacie has been doing a variable from: Enrolled when age requirement, viable pregnancy with GA>= weeks by US, Outside catchment area, did not consent.

```

Fetal/Infant outcomes
1. GA_BOE: use US_GA_DAYS_AGE_FTS1,2,3,4 and US_GA_WKS_AGE_FTS1,2,3,4 to calculate the biggest fetus.  Use the biggest fetus to do the calculations for GA_DIFF_WKS and GA_DIFF_DAYS.  In the constructed outcomes sheets, it is not listed correctly (b/c only asking to use first fetus)
2. Use the biggest infant using US and GA_LMP_WEEKS_SCORRES and GA_LMP_DAYS to calc. variable GA_DIFF_WKS and GA_DIFF_DAYS 
```{r}
# STEP 1:
mat_inf_subset_df <- mat_inf_subset_df %>% 
  rowwise() %>% mutate(biggest_M01_US_GA_DAYS_FTS = max(((M01_US_GA_WKS_AGE_FTS1_1*7) + M01_US_GA_DAYS_AGE_FTS1_1),
                                     ((M01_US_GA_WKS_AGE_FTS2_1*7) + M01_US_GA_DAYS_AGE_FTS2_1),
                                     ((M01_US_GA_WKS_AGE_FTS3_1*7) + M01_US_GA_DAYS_AGE_FTS3_1),
                                     ((M01_US_GA_WKS_AGE_FTS4_1*7) + M01_US_GA_DAYS_AGE_FTS4_1), na.rm = TRUE)) %>%
  mutate(biggest_M01_US_GA_DAYS_FTS = if_else(biggest_M01_US_GA_DAYS_FTS<0, NA, biggest_M01_US_GA_DAYS_FTS)) # <0 covers '-Inf' cases and where it's only -7.

# STEP 2: 
mat_inf_subset_df <- mat_inf_subset_df %>% 
  rowwise() %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = (M01_GA_LMP_WEEKS_SCORRES_1*7)+ M01_GA_LMP_DAYS_SCORRES_1) %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = if_else(M01_GA_LMP_DAYS_CALC_1<0, NA, M01_GA_LMP_DAYS_CALC_1))

# STEP 3: 
mat_inf_subset_df <- mat_inf_subset_df %>%
  dplyr::mutate(GA_DIFF_WKS = (M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS) %/% 7, # Floor of the number of weeks used here. 
                GA_DIFF_DAYS = M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS)
```

If the GA by LMP is less than 9 weeks 0 days:
- If discrepancy between LMP and US ≤5 days = GA by LMP
- If LMP unknown or discrepancy between LMP and US ≥5 days = GA by US

If the GA by LMP is between 9 weeks 0 days and 15 weeks 6 days:
- If discrepancy between LMP and US ≤7 days → BOE = GA by LMP
- If LMP is unknown OR discrepancy between LMP and US ≥7 days = GA by US

If GA by LMP is greater than 16 weeks 0 days:
- If discrepancy between LMP and US ≤10 days = GA by LMP
- If LMP is unknown or discrepancy between LMP and US ≥10 days = GA by US

```{r}
mat_inf_subset_df <- mat_inf_subset_df %>%
  mutate(GA_BOE = case_when(M01_GA_LMP_DAYS_CALC_1 %/% 7 < 9 ~ 
                              if_else(abs(GA_DIFF_DAYS) <= 5, 
                                      M01_GA_LMP_DAYS_CALC_1, 
                                      biggest_M01_US_GA_DAYS_FTS),
                            M01_GA_LMP_DAYS_CALC_1 %/% 7 < 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=7, 
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                             M01_GA_LMP_DAYS_CALC_1 %/% 7 >= 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=10,
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                            TRUE ~ biggest_M01_US_GA_DAYS_FTS)) %>% 
  mutate(GA_BOE_WKS = GA_BOE %/% 7,
         GA_BOE_DAYS = GA_BOE %% 7)
temp.df <- mat_inf_subset_df %>% select(SITE, M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS, GA_BOE, GA_BOE_WKS, GA_BOE_DAYS) %>% 
  mutate(diff_GA = abs(M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS))

table(diff_LMP_US = temp.df$diff_GA, temp.df$SITE, useNA = "always")

table(GA_BOE = mat_inf_subset_df$GA_BOE_WKS, mat_inf_subset_df$SITE,  useNA = "always")

table(mat_inf_subset_df$M01_GA_LMP_DAYS_CALC_1, mat_inf_subset_df$SITE, useNA = "always")
```

Neonatal mortality (Death of a live born baby during the first 28 days of life from any cause. )

DELIV_DSSTDAT_INF1	Date of delivery:
BIRTH_DSTERM_INF1	Birth outcome
DTHDAT	Specify date of death:
DTHDAT	Record date of death:
```{r}
temp.df <- mat_inf_subset_df %>% 
  mutate(NEO_DTH = case_when(is.na(M11_DTH)))
  
```
####################
#MATERNAL OUTCOMES:
####################

*Pregnancy-related death:*
"Death from any cause during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

M09_DELIV_DSSTDAT_INF1,2,3,4
M10_MAT_DSTERM
M23_CLOSE_DSDECOD
M23_DTHDAT

CLOSE_DSDECOD==1 | 2 then MAT_DEATH=1 (1=Alive)
CLOSE_DSDECOD==2 (2=Alive)
CLOSE_DSDECOD==4 | 5 | 6 then MAT_DEATH=9

```{r}
mat_inf_subset_df <- mat_inf_subset_df %>%
  mutate_if(is.Date, #is.Date is asking the variable (entire col) is a date type or not.
            function(d) {
              if_else(d == as.Date("1907-07-07"), as.Date(NA), as.Date(d))
            }) %>%
  mutate(var_w_deliverydate = any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6, #'any' is checking if anything in these columns by row(dplyr is doing the by-row part) is NA.
  M09_DELIV_DSSTDAT_INF2_6,
  M09_DELIV_DSSTDAT_INF3_6,
  M09_DELIV_DSSTDAT_INF4_6)))) %>% 
  rowwise() %>%
  mutate(PREG_DEATH = if_else(M23_CLOSE_DSDECOD == 3 | !is.na(M23_DTHDAT), 
                              if_else(var_w_deliverydate,
                                      as.numeric(M23_DTHDAT - as.Date(max(M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
                                                                          M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6, 
                                                                          na.rm = TRUE)) < 
                                                   as.difftime(42, units = "days")),
                                      1), 
                              0)) %>% 
  mutate(PREG_DEATH = if_else(M23_CLOSE_DSDECOD==4 | M23_CLOSE_DSDECOD==5, 9, PREG_DEATH))

table(PREG_DEATH=mat_inf_subset_df$PREG_DEATH, SITE=mat_inf_subset_df$SITE, useNA = "always")
```

*Maternal Anemia*
Definition: Low hemoglobin levels and/or diagnosis of anemia in pregnancy, at labor and delivery, and through 6 months postpartum. 
Variable: MAT_ANEMIA_ANY

Create: MAT_ANEMIA_MEAS
"1, Mild
2, Moderate
3, Severe
0, None

using: 
"ANC
L&D
PNC
Hospitalization"

MNH06	DIAG_VSDAT
MNH06	TYPE_VISIT
MNH06	HB_POC_LBORRES
MNH08	LBSTDAT
MNH08	TYPE_VISIT
MNH08	CBC_HB_LBORRES
MNH09	DELIV_DSSTDAT_INF1
MNH19	TIMING_OHOCAT
MNH19	CBC_LBDAT
MNH19	CBC_HB_LBORRES
MNH19	HB_POC_LBTSTDAT
MNH19	HB_POC_LBORRES

//Maternal anemia in pregnancy
mutate(MAT_ANEMIA_MEAS = 1
if ((MNH06_TYPE_VISIT==1 | MNH06_TYPE_VISIT==2 | MNH06_TYPE_VISIT==3 | MNH06_TYPE_VISIT==4) & (MNH06_SPHB_LBORRES, 10, 10.9) | (MNH06_HB_POC_LBORRES,10,10.9))) | ((MNH08_TYPE_VISIT==1 | MNH08_TYPE_VISIT==2 | MNH08_TYPE_VISIT==3 | MNH08_TYPE_VISIT==4) & (MNH08_CBC_HB_LBORRES,10,10.9)) | (MNH19_TIMING_OHOCAT==1 & (M19_HB_POC_LBORRES,10,10.9) | (M19_CBC_HB_LBORRES,10,10.9))

mutate(MAT_ANEMIA_MEAS = 1
if ((M06_TYPE_VISIT_1 ==1 | M06_TYPE_VISIT_2==2 | M06_TYPE_VISIT_3==3 | M06_TYPE_VISIT_==4) & between(MNH06_HB_POC_LBORRES,10,10.9))) | ((M08_TYPE_VISIT_1==1 | M08_TYPE_VISIT_2==2 | M08_TYPE_VISIT_3==3 | M08_TYPE_VISIT_4==4) & (M08_CBC_HB_LBORRES,10,10.9)) | (M19_TIMING_OHOCAT==1 & (MNH19_HB_POC_LBORRES,10,10.9) | (MNH19_CBC_HB_LBORRES,10,10.9)) #TODO Are we ignoring SpHb measurements for this var?


Create: MAT_ANEMIA_DIAG
```{r}

temp.df <- mat_inf_subset_df[1:20, ] %>%
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & #at least 1 visit is non-missing 
                                        if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))  ~ 1,
                                     TRUE ~ 2)) %>% select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4,
                                                           M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2, 
                                                           M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, MAT_ANEMIA_MEAS)

temp.df <- mat_inf_subset_df[1:20, ] %>%
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES_", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  
  mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                          if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))   ~ 1,
                                     TRUE ~ 2)) %>% select(M08_TYPE_VISIT_1, M08_TYPE_VISIT_2, M08_TYPE_VISIT_3, M08_TYPE_VISIT_4,
                                                           M08_CBC_HB_LBORRES_1, M08_CBC_HB_LBORRES_2, 
                                                           M08_CBC_HB_LBORRES_3, M08_CBC_HB_LBORRES_4, MAT_ANEMIA_MEAS1)

```


```{r}
#TODO Pull out these columns and see what they look like. Atm all are 1. 
temp.df <- mat_inf_subset_df %>% 
  select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
  
  mutate(MAT_ANEMIA_MEAS = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                        if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
                                       
                                       (if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
                                          if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
                                       
                                       (if_any(num_range('M19_TIMING_OHOCAT_VISIT_', 1:3), ~ .==1) &
                                          (if_any(num_range('M19_HB_POC_LBORRES_', 1:4), ~ between(.x,10,10.9)) |
                                             
                                             if_any(num_range('M19_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))) ~ 1,
                                     TRUE ~ 2)) %>% 
  select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4, 
         M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2,M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, 
         MAT_ANEMIA_MEAS)

# Using library Purrr here
# .x placeholder for each of the variable inside if_any. Can use just "." if it's not inside a function.
# Lambda function used here = it's a little expression inside of something. It's not a function that's defined outside. 

table(mat_inf_subset_df$M19_TIMING_OHOCAT_VISIT3, useNA = "always")

```



