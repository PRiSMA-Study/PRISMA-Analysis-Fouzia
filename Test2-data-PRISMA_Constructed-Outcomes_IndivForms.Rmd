---
title: "PRISMA_ Maternal-Infant-Constructed-Outcomes - Individual Forms"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

README: 
File: Test-data-PRISMA_Constructed-Outcomes_IndivForms.Rmd (not Test2-data...Rmd) has NAs, in this file, I have converted all NAs to 0s like Emily requested. 

This file is created from PRISMA_Constructed-Outcomes_IndivForms.Rmd.  I will use test data from Kenya only here. 

Constructed variables: 
https://docs.google.com/spreadsheets/d/1dfOWoZNm0RipnIRIucHt3kAFiPl3nISD3U2jA3btKXo/edit#gid=252197818

Data dictionary: 
https://docs.google.com/spreadsheets/d/1Q9MMoQP9_Ldhzi6R0mxE8LBzsLQ92djw/edit?pli=1#gid=1356168077

CRFs: 
https://www.dropbox.com/home/PRiSMA/PRISMA%20CRFs%20and%20Data%20Dictionary/CRFs%20Active%20(MAR272023)

Outcomes Review Slides: 
https://docs.google.com/presentation/d/1fjJV85LYvmifsnKg8CGMiYW2rSzGBx9COSMG_rsY6U4/edit#slide=id.gfe0717f14d_0_42

Monitoring Report: https://github.com/PRiSMA-Study/Monitoring-Report-ACTIVE/tree/main

ReMAPP Protocol: https://www.dropbox.com/scl/fi/9rimh5a8rpkxe6a4qfdku/ReMAPP-Protocol-v1.8-JUN292023.docx.docx?dl=0&rlkey=uprxvk03drnpckcctbjct2j2r


#TODO: 
# - Need to look at Visit=13s and 14s (unscheduled ANC=13 and PNC=14) - this is not working currently in AWS dataset.
# - Include all the unscheduled visits and account by date. 
# - CRITICAL INTERVENTIONS var needs to have hospitalization vars included. DONE
# 5. UTERINE RUPTURE = MAT_UTER_RUP --> need to add hospitalization - DONE
# 6. Fix is.na for all of anemia. It should be a !is.na statement & between () - DONE
# 7. Fix Anemia categories for trimesters and for PNC visits - make them specific. 
# 8. Add Add non-schedule PNC visits - TYPE_VISIT=14 to LATE_MAT_DEATH
# 9. Add MNH_19 13_1, 13_2 based on date (OBSSTDAT)
# - GESTATIONAL DIABETES: ALL OF MEASURED variables are NA - FASTING OGTT, HbA1c# 

NOTES:
- If a visit hasn't happened for even a single woman say PNC26 (VISIT11) then those variables won't be there when you create the wider version b/c the TYPE_VISIT=11 doesn't exist. This is the case for M08_CBC_HB_LBORRES_11 or M08_CBC_HB_LBORRES_12 let's say).
- PRISMA - no CBC after ENROLLMENT needed - so data is not missing in the table above. CBC IS A REMAPP REQUIREMENT.  
    - Keep CBC measurement over POC measurement for classifying ANEMIA.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
# library(ThemePark)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
library(haven)
library(kableExtra)
```
The varname structure for the newly integrated forms (hospitalizations, adverse events, and protocol deviation) are as follows:
“M[xx]_varname_VISIT[y], where [xx] is the form number and [y] is the visit sequence number (i.e. if first hospitalization, this will be 1, second hospitalization will be 2…..)

```{r echo=FALSE}
# path_to_data <- 'Z:/SynapseCSVs/Kenya/2023-07-28/' # If MNH*.xlsx files are located elsewhere, set this to, for example, 'data/' or '//TNT/...'
# path_to_data <- 'Z:/Processed Data/2023-07-28/'

# path_to_data <- 'Z:/Stacked Data/2023-09-15/' # - for AWS data

path_to_data <-  'D:/Users/fouziafarooq/Documents/PRISMA_constructed-outcomes/data/2023-09-15/'# - for AWS data

# path_to_data <- 'data' # for Mac R.
```

For CSV files in **AWS**:
```{r echo=FALSE}
########################################################################################
recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
tic <- Sys.time()
if(recreate_mnh_list == TRUE){
  mnh_list <- list() # create an empty list first.
  list_mnh <- dir(path = path_to_data, pattern = "*.csv", full.names = TRUE) #creates a list of all the csv files in the directory
  for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
    form_num <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
    #basename() pulls out just the name of the file from the entire directory/path.
    print(paste("Reading", form_num))
    mnh_list[[form_num]] <- read.csv(data_file)
  }
  saveRDS(mnh_list, file = paste0("MNH_list_", basename(path_to_data), ".RDS"))
}
toc <- Sys.time()
print(toc - tic)

mnh_list <- readRDS(paste0("MNH_list_", basename(path_to_data), ".RDS"))  #read in the RDS objects with all the MNH files as a massive list.

```

For SAS files from **Test data**.
```{r echo=FALSE}
########################################################################################
 # recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
# 
# if(recreate_mnh_list == TRUE){
#   mnh_list <- list() # create an empty list first.
#   list_mnh <- dir(path = path_to_data, pattern = "*.sas7bdat", full.names = TRUE) #creates a list of all the csv files in the directory
#   for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
#     form_num <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
#     #basename() pulls out just the name of the file from the entire directory/path.
#     print(paste("Reading", form_num))
#     mnh_list[[form_num]] <- read_sas(data_file, )
#   }
#   saveRDS(mnh_list, file = paste0("MNH_list_", basename(path_to_data), ".RDS"))
# }
# 
# mnh_list <- readRDS("MNH_list_data.RDS")  #read in the RDS objects with all the MNH files as a massive list.

```

***Hard code TYPE_VISIT for M00=1, M02=1, M03=1,  M09=6, M10=6, M11=6, M17=6, M18=12***
```{r echo=FALSE}
if("mnh00" %in% names(mnh_list)){
  mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% 
    mutate(M00_TYPE_VISIT = 1) 
} else{
  "MNH00 doesn't exist in the list"
}

if("mnh02" %in% names(mnh_list)){
  mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>% 
    mutate(M02_TYPE_VISIT = 1) 
} else{
  "MNH02 doesn't exist in the list"
}

if("mnh03" %in% names(mnh_list)){
  mnh_list[["mnh03"]] <- mnh_list[["mnh03"]] %>% 
    mutate(M03_TYPE_VISIT = 1) 
} else{
  "MNH03 doesn't exist in the list"
}

if("mnh09" %in% names(mnh_list)){
  mnh_list[["mnh09"]] <- mnh_list[["mnh09"]] %>% 
    mutate(M09_TYPE_VISIT = 6) 
} else{
  "MNH09 doesn't exist in the list"
}

if("mnh10" %in% names(mnh_list)){
  mnh_list[["mnh10"]] <- mnh_list[["mnh10"]] %>% 
    mutate(M10_TYPE_VISIT = 6) 
} else{
  "MNH10 doesn't exist in the list"
}

if("mnh11" %in% names(mnh_list)){
  mnh_list[["mnh11"]] <- mnh_list[["mnh11"]] %>% 
    mutate(M11_TYPE_VISIT = 6) 
} else{
  "MNH11 doesn't exist in the list"
}

if("mnh17" %in% names(mnh_list)){
  mnh_list[["mnh17"]] <- mnh_list[["mnh17"]] %>% 
    mutate(M17_TYPE_VISIT = 6) 
} else{
  "MNH17 doesn't exist in the list"
}

if("mnh16" %in% names(mnh_list)){
  mnh_list[["mnh16"]] <- mnh_list[["mnh16"]] %>% 
    mutate(M16_TYPE_VISIT = 5) 
} else{
  "MNH16 doesn't exist in the list"
}

if("mnh18" %in% names(mnh_list)){
  mnh_list[["mnh18"]] <- mnh_list[["mnh18"]] %>% 
    mutate(M18_TYPE_VISIT = 12) 
} else{
  "MNH18 doesn't exist in the list"
}

if("mnh19" %in% names(mnh_list)){
  mnh_list[["mnh19"]] <- mnh_list[["mnh19"]] %>% 
    mutate(M19_TYPE_VISIT = 13) 
} else{
  "MNH19 doesn't exist in the list"
}

```


Create a SITE variable for Test data only on Mac - can let it run in AWS.***FOR TEST DATA ONLY***
```{r echo=FALSE}
# for(form_name in names(mnh_list)) { 
#   if(!('SITE' %in% names(form_name))) {
#     mnh_list[[form_name]]$SITE <- NA
#   }
# }
```

Change wrong values for MNH01 TYPE_VISIT (value was 36 but SL mentioned it probably is week 36 so visit 5)
```{r echo=FALSE}
   
# mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% 
 # mutate(M01_TYPE_VISIT = ifelse(M01_TYPE_VISIT == 36, 5, M01_TYPE_VISIT))
```

ONLY FOR TEST KENYA DATA:
MNH01 doesn't have MOMID and PREGID in Kenya data. Merge it in from MNH02. 
Keep an eye on SITE variable. 
```{r echo=FALSE}
# mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% select(-PREGID, -MOMID , -SITE) # Only need to run this line outside of AWS when I need to add Mxx prefix.
# 
# # mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% filter(!is.na(SCRN_OBSSTDAT)) # had to remove 2 rows of garbage. 
# #mnh_list[["mnh00"]]$SCRNID <- as.double(mnh_list[["mnh00"]]$SCRNID) # Just for Test Kenya data on Mac
# 
# mnh_list[["mnh00"]]$SCRNID <- as.character(mnh_list[["mnh00"]]$SCRNID)
# mnh_list[["mnh00"]] <- left_join(mnh_list[["mnh00"]], 
#                                  mnh_list[["mnh02"]] %>% select(SCRNID, MOMID, PREGID, SITE),
#                                  by = "SCRNID")
# 
# mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% select(-PREGID, -MOMID, -SITE)
# mnh_list[["mnh01"]] <- left_join(mnh_list[["mnh01"]], 
#                                  mnh_list[["mnh02"]] %>% select(SCRNID, MOMID, PREGID, SITE),
#                                  by = "SCRNID")

```

Adding a prefix of M_XX: *Just for Test Kenya data on mac*
Using modify() from Purrr library and a lambda function.
```{r echo=FALSE}
#############################################################################################################################################
# THIS DOESN'T NOT NEED TO BE RUN WHEN RUNNING IN AWS DATA - THIS IS ONLY NEEDED FOR TEST DATA OUTSIDE B/C THOSE VARS DIDN'T HAVE PREFIX Mxx
#############################################################################################################################################
# dont_fix <- c("SCRNID", "MOMID", "PREGID", "SITE") 
# 
# for (form_name in names(mnh_list)) {
#   col_names_vec <- names(mnh_list[[form_name]])
#   var_prefix <- paste0('M',substr(form_name, 4, 5))
#   names(mnh_list[[form_name]]) <- modify(col_names_vec,
#                                          function(x) {
#     ifelse(x %in% dont_fix | startsWith(x, var_prefix), #second part is checking if variable already has M_XX.
#            x,
#            paste0(var_prefix, "_", x))}) #x is whatever name is passed in.
# }
```

```{r echo=FALSE}

mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>% #try using 'drop_na (variables)
  distinct (MOMID, PREGID, SITE, M00_TYPE_VISIT, .keep_all = TRUE) # keep_all keeps the first row rather than dropping both duplicates. 


mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M01_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M02_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh04"]] <- mnh_list[["mnh04"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M04_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh05"]] <- mnh_list[["mnh05"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M05_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh11"]] <- mnh_list[["mnh11"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M11_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh13"]] <- mnh_list[["mnh13"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M13_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh14"]] <- mnh_list[["mnh14"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M14_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh15"]] <- mnh_list[["mnh15"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M15_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh19"]] <- mnh_list[["mnh19"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M19_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh25"]] <- mnh_list[["mnh25"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M25_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh26"]] <- mnh_list[["mnh26"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M26_TYPE_VISIT, .keep_all = TRUE)
```

```{r echo=FALSE}
mnh_list_wide <- list()

#Once I run through this code, I will no longer have TYPE_VISIT variable in my mnh_list_wide datasets. 
for (form_name in names(mnh_list)) {
  var_prefix <- paste0('M',substr(form_name, 4, 5))
  if(!(paste0(var_prefix, "_TYPE_VISIT") %in% names(mnh_list[[form_name]]))){ #if type_visit variable doesn't exist then skip it, but still copy the data frame to the list of wide frames (otherwise that MNH data will not be included).
    mnh_list_wide[[form_name]] <- mnh_list[[form_name]]
    next
  }
  if(form_name!="mnh19"){
    mnh_list_wide[[form_name]] <- mnh_list[[form_name]] %>% # do the pivot here
      filter(get(paste0(var_prefix, '_TYPE_VISIT'))!=13)
  }

    #keeps a single row of duplicate rows based on MOMID, _TYPE_VISIT, and PREGID.
   # mnh_list_wide[!duplicated(mnh_list_wide)] %>%
  # distinct (MOMID, PREGID, paste0(var_prefix, '_TYPE_VISIT'), .keep_all = TRUE) %>%
  mnh_list_wide[[form_name]] <- mnh_list[[form_name]] %>% # do the pivot here
    pivot_wider(id_cols = c('MOMID', 'PREGID', 'SITE'),
                names_from = paste0(var_prefix, '_TYPE_VISIT'),
                values_from = starts_with(var_prefix) & !ends_with('_TYPE_VISIT'),
                values_fill = NA)
   # filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
   # filter(!is.na(MOMID)) 
}
# distinct (MOMID, PREGID, paste0(var_prefix, '_TYPE_VISIT'), .keep_all = TRUE) %>%
```


CONVERT LISTS INTO DATAFRAMES. 
```{r echo=FALSE}
for(form_name in names(mnh_list)){
assign(paste0(form_name, "_df"), mnh_list_wide[[form_name]]) # assign is the opposite of get()
}
```


```{r}
# 
# MERGE - ADD VARIABLES HERE
# ```{r}
# #########
# # MNH00 #
# #########
# mnh00_df <- mnh_list_wide[["mnh00"]] %>% dplyr::select(MOMID, PREGID,# SITE, #TODO: 
#                                                   M00_KNOWN_DOBYN_SCORRES_1, 
#                                                   M00_BRTHDAT_1, M00_ESTIMATED_AGE_1)
# 
# #########
# # MNH01 #
# #########
# mnh01_df <- mnh_list_wide[["mnh01"]] %>% dplyr::select(MOMID, PREGID, M01_US_OHOLOC_1, # SITE,
#                                                        M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
#                                                        M01_US_GA_WKS_AGE_FTS1_1,
#                                                        M01_US_GA_WKS_AGE_FTS2_1, M01_US_GA_WKS_AGE_FTS2_1,
#                                                        M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_WKS_AGE_FTS4_1,
#                                                        M01_US_GA_DAYS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS2_1,
#                                                        M01_US_GA_DAYS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS4_1,
#                                                        M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1,
#                                                        starts_with(c("M01_US_OHOSTDAT")),
#                                                        M01_US_GA_WKS_AGE_FTS1_1)
# 
# #########
# # MNH04 #
# #########
# mnh04_df <- mnh_list_wide[["mnh04"]] %>% 
#   dplyr::select(MOMID, PREGID, # SITE,
#                 M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2,
#                 M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4, 
#                 M04_FETAL_LOSS_DSSTDAT_5,
#                 M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
#                 M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4,
#                 M04_FETAL_LOSS_DSSTDAT_5,
#                 M04_FETAL_LOSS_DSDECOD_1, M04_FETAL_LOSS_DSDECOD_2, 
#                 M04_FETAL_LOSS_DSDECOD_3, M04_FETAL_LOSS_DSDECOD_4,
#                 M04_FETAL_LOSS_DSDECOD_5, 
#                 M04_FETAL_LOSS_DSSTDAT_1, M04_FETAL_LOSS_DSSTDAT_2, 
#                 M04_FETAL_LOSS_DSSTDAT_3, M04_FETAL_LOSS_DSSTDAT_4, 
#                 M04_FETAL_LOSS_DSSTDAT_5, 
#                 M04_FETAL_LOSS_DSDECOD_1, M04_FETAL_LOSS_DSDECOD_2,
#                 M04_FETAL_LOSS_DSDECOD_3, M04_FETAL_LOSS_DSDECOD_4,
#                 M04_FETAL_LOSS_DSDECOD_5,
#                 starts_with(c("M04_HTN_EVER_MHOCCUR")),
#                 starts_with("M04_HTN_CMTRT_"))
# 
# #########
# # MNH06 #
# #########
# mnh06_df <- mnh_list_wide[["mnh06"]] %>% dplyr::select(MOMID, PREGID, # SITE,  
#                                                        # Maternal anemia:
#                                                        starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_")),
#                                                        starts_with("M06_BP_SYS_VSORRES_"),
#                                                        starts_with("M06_BP_DIA_VSORRES_"))
# 
# #########
# # MNH08 #
# #########
# mnh08_df <- mnh_list_wide[["mnh08"]] %>% dplyr::select(MOMID, PREGID, # SITE, 
#                                                        starts_with(c("M08_LBSTDAT_", "M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES")))
# 
# #################################
# # MNH09 - Maternal L&D Outcomes #
# #################################
# mnh09_df <- mnh_list_wide[["mnh09"]] %>% dplyr::select(MOMID, PREGID, # SITE,                                        
#                                                        M09_CRY_CEOCCUR_INF1_6, M09_FHR_VSTAT_INF1_6, 
#                                                        M09_MACER_CEOCCUR_INF1_6,M09_CORD_PULS_CEOCCUR_INF1_6,
#                                                        M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, 
#                                                        M09_BIRTH_DSTERM_INF3_6, M09_BIRTH_DSTERM_INF4_6,
#                                                        M09_PPH_TRNSFSN_PROCCUR_6, M09_PPH_TRNSFSN_PROCCUR_6, 
#                                                        M09_PPH_FAORRES_5_6, M09_RUPT_UTERUS_CEOCCUR_6, M09_PPH_COMP_3_6,
#                                                        starts_with(c("M09_DELIV_DSSTDAT_INF",
#                                                                      "M09_BIRTH_DSTERM_INF")),
#                                                        M09_HDP_HTN_MHOCCUR_3_6)
# #########
# # MNH10 #
# #########
# mnh10_df <- mnh_list_wide[["mnh10"]] %>% dplyr::select(MOMID, PREGID, # SITE,
#                                                 M10_MAT_DSTERM_6, M10_TRANSFER_OHOLOC_6)
# 
# ###############
# # MNH11 - PNC #
# ###############
# mnh11_df <- mnh_list_wide[["mnh11"]] %>% dplyr::select(MOMID, PREGID, # SITE,
#                                                 M11_DTHDAT_6)
# 
# ###############
# # MNH 12- PNC #
# # This dataset has no MNH12 yet# 
# ###############
# mnh12_df <- mnh_list_wide[["mnh12"]] %>% dplyr::select(MOMID, PREGID,#  SITE,
#                                                       M12_MAT_VITAL_MNH12_7, M12_MAT_VITAL_MNH12_8, M12_MAT_VITAL_MNH12_9, 
#                                                       M12_MAT_VITAL_MNH12_10, M12_MAT_VITAL_MNH12_11)
# 
# #########
# # MNH19 #
# #########
# #M19_PREG_FAORES (try: the variable is there but called M19_PREG_FAORRES_VISIT{x} where {x} 
# # is the visit number based on total number of visits or To see the total number of MNH19 
# #forms filled out by an individual, refer to M19_VISITS_TOT)
# if("mnh19" %in% names(mnh_list_wide)){
# mnh19_df <- mnh_list_wide[["mnh19"]] %>% dplyr::select(MOMID, PREGID,#  SITE,
#                                                        M19_OBSSTDAT_13, M19_TX_PROCCUR_1_13, M19_TX_PROCCUR_2_13,
#                                                        M19_TX_PROCCUR_3_13, M19_TX_PROCCUR_4_13, M19_TX_PROCCUR_5_13, 
#                                                        M19_TX_PROCCUR_6_13, M19_TX_PROCCUR_77_13,
#                                                 starts_with(c("M19_TIMING_OHOCAT", "M19_CBC_LBDAT", 
#                                                               "M19_CBC_HB_LBORRES",
#                                                               "M19_HB_POC_LBTSTDAT", "M19_HB_POC_LBORRES")),
#                                                 M19_HDP_HTN_MHOCCUR_3_13, M19_BP_SYS_VSORRES_13, M19_BP_DIA_VSORRES_13)
# } else{
#   "MNH19 does not exist in the wide format"
# }
#                                                               
# 
# #############################
# # MNH23 - Maternal Closeout #
# #############################
# if("mnh23" %in% names(mnh_list_wide)){
# mnh23_df <- mnh_list_wide[["mnh23"]] %>% dplyr::select(MOMID, PREGID, # SITE, 
#                                                 M23_CLOSE_DSDECOD, M23_ACC_DDORRES, M23_DTHDAT,
#                                                 M23_CLOSE_DSDECOD, M23_DTHDAT)
# } else{
#   "MNH23 does not exist in the wide format"
# }
# 
# 
# ###########################
# # MNH24 - Infant Closeout #
# ###########################
# if("mnh24" %in% names(mnh_list_wide)){
# mnh24_df <- mnh_list_wide[["mnh24"]] %>% dplyr::select(MOMID, PREGID, # SITE, 
#                                                 M24_DTHDAT)
# } else{
#   "MNH24 does not exist in the wide format"
# }

```


# MERGE together all the forms.
```{r echo=FALSE}
merged_df <- mnh02_df 
merged_df <- merged_df %>% 
  mutate(ENROLLED_FF = ifelse(M02_AGE_IEORRES_1 ==1 & M02_PC_IEORRES_1==1 & 
                                M02_CATCHMENT_IEORRES_1==1 & M02_CATCH_REMAIN_IEORRES_1==1 & 
                                M02_CONSENT_IEORRES_1==1, 1,0)) %>% filter(ENROLLED_FF ==1)

# merged_df <- left_join(merged_df, mnh00_df, by = c("MOMID", "PREGID", "SITE"))
# merged_df <- left_join(merged_df, mnh01_df, by = c("MOMID", "PREGID", "SITE"))


duplicate_df <- merged_df %>% group_by(MOMID, PREGID) %>%  filter(n()>1)
duplicate_df2 <- duplicate_df %>% distinct(MOMID, PREGID)

###############################
# FIGURE OUT WHERE DUPLICATES ARE 
DUPLICATE <- FALSE
################################
if(DUPLICATE==TRUE){
  for(i in 0:26) {
    form_name <- paste0("mnh", sprintf(fmt="%02d", i), "_df") #sprintf adds a leading 0 to digits below 10.
    dup_form_name <- paste0("dup_mnh", sprintf(fmt="%02d", i), "_df")
    #if(exists(form_name) & !form_name %in% dont_merge[]) {
    if(exists(form_name) & !form_name %in% c("mnh02", "mnh11", "mnh13", "mnh14", "mnh15", "mnh24")) { # taking out the infant forms from the maternal merge. 
      form_df <- get(form_name)
      duplicate_df <- form_df %>% group_by(MOMID, PREGID, SITE) %>%  filter(n()>1)
      assign(dup_form_name, duplicate_df)
    }
  }
}

dont_merge <- c("mnh02_df", "mnh11_df", "mnh13_df", "mnh14_df", "mnh15_df", "mnh24_df")
for(i in 0:26) {
  form_name <- paste0("mnh", sprintf(fmt="%02d", i), "_df") #sprintf adds a leading 0 to digits below 10.
 if(exists(form_name) & !(form_name %in% dont_merge)) { # taking out the infant forms from the maternal merge. 
 #if(exists(form_name) & !form_name %in% c("mnh11", "mnh13", "mnh14", "mnh15", "mnh24")) { 
    form_df <- get(form_name) %>% distinct(MOMID, PREGID, SITE, .keep_all = TRUE) # THIS REMOVES DUPLICATE ROWS. 
    merged_df <- left_join(merged_df, form_df, by = c("MOMID", "PREGID", "SITE"))
  }
}
```


# Convert "1907-07-07" to NA:
```{r echo=FALSE}
merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
  mutate_all(function(d) {
              if_else(d=="1907-07-07", NA, d) 
            })

merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
  mutate_all(function(d) {
              if_else(d==-7, NA, d) 
            })

merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
  mutate_all(function(d) {
              if_else(d==77, NA, d) 
            })
```

*RUN CODE ABOVE*

***Fetal/Infant outcomes***
1. GA_BOE: use US_GA_DAYS_AGE_FTS1,2,3,4 and US_GA_WKS_AGE_FTS1,2,3,4 to calculate the biggest fetus.  Use the biggest fetus to do the calculations for GA_DIFF_WKS and GA_DIFF_DAYS.  In the constructed outcomes sheets, it is not listed correctly (b/c only asking to use first fetus)
2. Use the biggest infant using US and GA_LMP_WEEKS_SCORRES and GA_LMP_DAYS to calc. variable GA_DIFF_WKS and GA_DIFF_DAYS 
```{r echo=FALSE}
# STEP 1:
temp.df <- merged_df %>% select(PREGID, MOMID, SITE,
                                    M01_US_GA_WKS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS1_1, 
                                    M01_US_GA_WKS_AGE_FTS2_1, M01_US_GA_DAYS_AGE_FTS2_1,
                                    M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS3_1,
                                    M01_US_GA_WKS_AGE_FTS4_1, M01_US_GA_DAYS_AGE_FTS4_1, 
                                    M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1)
  
merged_df <- merged_df %>%  
  rowwise() %>% mutate(biggest_M01_US_GA_DAYS_FTS = max(((M01_US_GA_WKS_AGE_FTS1_1*7) +
                                                           M01_US_GA_DAYS_AGE_FTS1_1),
                                                        ((M01_US_GA_WKS_AGE_FTS2_1*7) +
                                                           M01_US_GA_DAYS_AGE_FTS2_1),
                                                        ((M01_US_GA_WKS_AGE_FTS3_1*7) +
                                                           M01_US_GA_DAYS_AGE_FTS3_1),
                                                        ((M01_US_GA_WKS_AGE_FTS4_1*7) +
                                                           M01_US_GA_DAYS_AGE_FTS4_1), na.rm = TRUE)) %>%
  mutate(biggest_M01_US_GA_DAYS_FTS = if_else(biggest_M01_US_GA_DAYS_FTS<0, NA, biggest_M01_US_GA_DAYS_FTS)) # <0 covers '-Inf' cases and where it's only -7.

# temp.df2 <- temp.df %>% select(M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1, 
# M01_GA_LMP_DAYS_CALC_1, M01_GA_LMP_DAYS_CALC_1)
# STEP 2: 
merged_df <- merged_df %>% 
  rowwise() %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = (M01_GA_LMP_WEEKS_SCORRES_1*7)+ M01_GA_LMP_DAYS_SCORRES_1) %>%
  mutate(M01_GA_LMP_DAYS_CALC_1 = if_else(M01_GA_LMP_DAYS_CALC_1<0, NA, M01_GA_LMP_DAYS_CALC_1))

# STEP 3: 
merged_df<- merged_df %>%
  dplyr::mutate(GA_DIFF_WKS = (M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS) %/% 7, # Floor of the number of weeks used here. 
                GA_DIFF_DAYS = M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS)

# table(merged_df$GA_DIFF_WKS)
# table(merged_df$GA_DIFF_WKS, merged_df$GA_DIFF_DAYS, useNA = "always")
```

If the GA by LMP is less than 9 weeks 0 days:
- If discrepancy between LMP and US ≤5 days = GA by LMP
- If LMP unknown or discrepancy between LMP and US ≥5 days = GA by US

If the GA by LMP is between 9 weeks 0 days and 15 weeks 6 days:
- If discrepancy between LMP and US ≤7 days → BOE = GA by LMP
- If LMP is unknown OR discrepancy between LMP and US ≥7 days = GA by US

If GA by LMP is greater than 16 weeks 0 days:
- If discrepancy between LMP and US ≤10 days = GA by LMP
- If LMP is unknown or discrepancy between LMP and US ≥10 days = GA by US

```{r echo=FALSE}
merged_df <- merged_df %>%
  mutate(GA_BOE = case_when(M01_GA_LMP_DAYS_CALC_1 %/% 7 < 9 ~ 
                              if_else(abs(GA_DIFF_DAYS) <= 5, 
                                      M01_GA_LMP_DAYS_CALC_1, 
                                      biggest_M01_US_GA_DAYS_FTS),
                            M01_GA_LMP_DAYS_CALC_1 %/% 7 < 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=7, 
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                             M01_GA_LMP_DAYS_CALC_1 %/% 7 >= 16 ~
                              if_else(abs(GA_DIFF_DAYS) <=10,
                                      M01_GA_LMP_DAYS_CALC_1, biggest_M01_US_GA_DAYS_FTS),
                            TRUE ~ biggest_M01_US_GA_DAYS_FTS)) %>% 
  mutate(GA_BOE_WKS = GA_BOE %/% 7,
         GA_BOE_DAYS = GA_BOE %% 7)

merged_df <- merged_df %>% 
  mutate(diff_GA = abs(M01_GA_LMP_DAYS_CALC_1 - biggest_M01_US_GA_DAYS_FTS))

# table(diff_LMP_US = temp.df$diff_GA, temp.df$SITE, useNA = "always")

table(SITE = merged_df$SITE, GA_BOE = merged_df$GA_BOE_WKS, useNA = "always") #SITE taken out

table(SITE = merged_df$SITE, merged_df$M01_GA_LMP_DAYS_CALC_1, useNA = "always") #SITE taken out
```


####################
#MATERNAL OUTCOMES:
####################

***PRIMARY: Pregnancy-related death - PREG_DEATH***
"Death from any cause during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

M09_DELIV_DSSTDAT_INF1,2,3,4
M10_MAT_DSTERM
M23_CLOSE_DSDECOD
M23_DTHDAT

label as 1=Alive, 2=Died, 9=Unknown

CLOSE_DSDECOD==1 | 2 (1 = Alive, 2 = Alive), then PREG_DEATH=0
CLOSE_DSDECOD==3 (3=Dead) then PREG_DEATH=1
CLOSE_DSDECOD==4 | 5 | 6 then PREG_DEATH=9 b/c 4,5, 6 is lost to follow up.

M10_MAT_DSTERM = 1 (stable)
M10_MAT_DSTERM = 2 (Complication requiring higher level of care)
M10_MAT_DSTERM = 3 (Died after admission for labor and delivery)

```{r echo=FALSE}
##################################################################################
#TODO 
# NOTES: 
# - TURN ALL NA TO 0
# - THIS VARIABLE IS GOOD TO GO OTHERWISE - 09/19/2023
##################################################################################

# temp.df <- merged_df %>% select(MOMID, PREGID, M09_DELIV_DSSTDAT_INF1_6,M09_DELIV_DSSTDAT_INF2_6,
  # M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6, M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_DTHDAT)

#temp.df$M23_DTHDAT[1] <- '2023-06-12'
# temp.df$M23_DTHDAT[2] <- '2023-08-05'

merged_df <- merged_df %>% 
  mutate(var_w_deliverydate = any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6, #'any' is checking if anything in these columns by row dplyr is doing the by-row part is NA.
  M09_DELIV_DSSTDAT_INF2_6,
  M09_DELIV_DSSTDAT_INF3_6,
  M09_DELIV_DSSTDAT_INF4_6))))

# JUST CREATING DAYS DIFF HERE FIRST
merged_df <- merged_df %>% 
  mutate(PREG_DEATH_DIFF_DAYS = as.numeric(as.Date(M23_DTHDAT, na.rm = TRUE) - as.Date(max(M09_DELIV_DSSTDAT_INF1_6,
                                                                          M09_DELIV_DSSTDAT_INF2_6, 
                                                                          M09_DELIV_DSSTDAT_INF3_6,
                                                                          M09_DELIV_DSSTDAT_INF4_6, 
                                                                          na.rm = TRUE))))



merged_df <- merged_df %>% 
  #rowwise() %>%
  mutate(PREG_DEATH = if_else((!is.na(M23_CLOSE_DSDECOD) & M23_CLOSE_DSDECOD == 3) | 
                                !is.na(M23_DTHDAT) | 
                                (!is.na(M10_MAT_DSTERM_6) & M10_MAT_DSTERM_6==3), 
                              if_else(var_w_deliverydate,
                                      PREG_DEATH_DIFF_DAYS < as.difftime(43, units = "days"),
                                      1), 
                              0)) %>% 
  mutate(PREG_DEATH = if_else((!is.na(M23_CLOSE_DSDECOD) & M23_CLOSE_DSDECOD==4) | (!is.na(M23_CLOSE_DSDECOD) & M23_CLOSE_DSDECOD==5), 9, PREG_DEATH))

  temp.df <- merged_df %>% select(MOMID, PREGID, PREG_DEATH, PREG_DEATH_DIFF_DAYS, 
                                      M09_DELIV_DSSTDAT_INF1_6,
                                      M09_DELIV_DSSTDAT_INF2_6,
                                      M09_DELIV_DSSTDAT_INF3_6, 
                                      M09_DELIV_DSSTDAT_INF4_6, 
                                      M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_DTHDAT)
  
table(PREG_DEATH=merged_df$PREG_DEATH, SITE = merged_df$SITE, useNA = "always") # data is molsty 2=Alive or 4 = loss to follow up or NA. 
round(prop.table(table(PREG_DEATH=merged_df$PREG_DEATH, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 3)

```

***SECONDARY: LATE PREGNANCY-RELATED DEATH: LATE_PREG_DEATH***
Death from any cause related to or aggravated by pregnancy or its management, irrespective of the duration and site of the pregnancy, from 42 days postpartum up to one year.

MNH09	DELIV_DSSTDAT_INF1
MNH10	MAT_DSTERM
MNH23	CLOSE_DSDECOD
MNH23	DTHDAT

```{r}
##################################################################################
#TODO 
# NOTES: 
# - NEED TO FIX THIS - HAVE TO CALCULATE BETWEEN 42 DAYS AND 1 YEAR. 
##################################################################################

# temp.df <- merged_df %>% select(MOMID, PREGID, M09_DELIV_DSSTDAT_INF1_6,M09_DELIV_DSSTDAT_INF2_6,
  # M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6, M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_DTHDAT)

# temp.df$M23_DTHDAT[1] <- '2023-07-12'
# temp.df$M23_DTHDAT[2] <- '2023-08-05'

merged_df <- merged_df %>% 
  mutate(var_w_deliverydate = any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6, #'any' is checking if anything in these columns by row dplyr is doing the by-row part is NA.
  M09_DELIV_DSSTDAT_INF2_6,
  M09_DELIV_DSSTDAT_INF3_6,
  M09_DELIV_DSSTDAT_INF4_6))))

# JUST CREATING DAYS DIFF HERE FIRST
merged_df <- merged_df %>% 
  mutate(PREG_DEATH_DIFF_DAYS = as.numeric(as.Date(M23_DTHDAT, na.rm = TRUE) - as.Date(max(M09_DELIV_DSSTDAT_INF1_6,
                                                                          M09_DELIV_DSSTDAT_INF2_6, 
                                                                          M09_DELIV_DSSTDAT_INF3_6,
                                                                          M09_DELIV_DSSTDAT_INF4_6, 
                                                                          na.rm = TRUE))))

merged_df <- merged_df %>% 
  #rowwise() %>%
  mutate(LATE_PREG_DEATH = if_else(M23_CLOSE_DSDECOD == 3 | !is.na(M23_DTHDAT) | M10_MAT_DSTERM_6==3, 
                              if_else(var_w_deliverydate,
                                      between(as.numeric(PREG_DEATH_DIFF_DAYS), 43, 365),
                                      1), 
                              0)) %>% 
  mutate(LATE_PREG_DEATH = if_else((!is.na(M23_CLOSE_DSDECOD) & M23_CLOSE_DSDECOD==4) | (!is.na(M23_CLOSE_DSDECOD) & M23_CLOSE_DSDECOD==5), 9, LATE_PREG_DEATH))

round(prop.table(table(LATE_PREG_DEATH=merged_df$LATE_PREG_DEATH, SITE = merged_df$SITE, useNA = "always"))*100, 3) # data is molsty 2=Alive or 4 = loss to follow up or NA. 
```



*Maternal Anemia*
Definition: Low hemoglobin levels and/or diagnosis of anemia in pregnancy, at labor and delivery, and through 6 months postpartum. 
Variable: MAT_ANEMIA_ANY

Create: MAT_ANEMIA_MEAS
"1, Mild
2, Moderate
3, Severe
0, None

using: 
"ANC
L&D
PNC
Hospitalization"

MNH06	DIAG_VSDAT
MNH06	TYPE_VISIT
MNH06	HB_POC_LBORRES
MNH08	LBSTDAT
MNH08	TYPE_VISIT
MNH08	CBC_HB_LBORRES
MNH09	DELIV_DSSTDAT_INF1
MNH19	TIMING_OHOCAT
MNH19	CBC_LBDAT
MNH19	CBC_HB_LBORRES
MNH19	HB_POC_LBTSTDAT
MNH19	HB_POC_LBORRES

//Maternal anemia in pregnancy
mutate(MAT_ANEMIA_MEAS = 1
if ((MNH06_TYPE_VISIT==1 | MNH06_TYPE_VISIT==2 | MNH06_TYPE_VISIT==3 | MNH06_TYPE_VISIT==4) & (MNH06_SPHB_LBORRES, 10, 10.9) | (MNH06_HB_POC_LBORRES,10,10.9))) | ((MNH08_TYPE_VISIT==1 | MNH08_TYPE_VISIT==2 | MNH08_TYPE_VISIT==3 | MNH08_TYPE_VISIT==4) & (MNH08_CBC_HB_LBORRES,10,10.9)) | (MNH19_TIMING_OHOCAT==1 & (M19_HB_POC_LBORRES,10,10.9) | (M19_CBC_HB_LBORRES,10,10.9))

mutate(MAT_ANEMIA_MEAS = 1
if ((M06_TYPE_VISIT_1 ==1 | M06_TYPE_VISIT_2==2 | M06_TYPE_VISIT_3==3 | M06_TYPE_VISIT_==4) & between(MNH06_HB_POC_LBORRES,10,10.9))) | ((M08_TYPE_VISIT_1==1 | M08_TYPE_VISIT_2==2 | M08_TYPE_VISIT_3==3 | M08_TYPE_VISIT_4==4) & (M08_CBC_HB_LBORRES,10,10.9)) | (M19_TIMING_OHOCAT==1 & (MNH19_HB_POC_LBORRES,10,10.9) | (MNH19_CBC_HB_LBORRES,10,10.9)) #TODO Are we ignoring SpHb measurements for this var?

Another idea:
Create anemia levels for each ANC Visit
WHO Hb thresholds g/dl:
Mild: 10.0-10.9
Moderate: 7.0-9.9
Severe: <7
Normal: >=11.0
Excess Hb: >13

Create: MAT_ANEMIA_DIAG

***WHAT IF POC IS 11.3 SAY AND CBC IS 8.0? WHICH ONE SHOULD BE USED TO CLASSIFY***
***MNH08_CBC_HB_LBORRES_3 (VISIT 3) variable is not present***

ADD VARIABLES THAT DON'T EXIST HERE
```{r echo=FALSE}
##############
# ANC VISITS # 
##############

# # Visit 3 doesn't have M08_CBC_HB_LBORRES_3:
# merged_df$M08_CBC_HB_LBORRES_3 <- ifelse("M08_CBC_HB_LBORRES_3" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_3, NA)
# 
# merged_df$M08_CBC_HB_LBORRES_4 <- ifelse("M08_CBC_HB_LBORRES_4" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_4, NA)
# 
# merged_df$M08_CBC_HB_LBORRES_5 <- ifelse("M08_CBC_HB_LBORRES_5" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_5, NA)
# 
# # VISIT 6 doesn't have M06_HB_POC_LBORRES_6:it's optional at L&D to do MNH08 and MNH06:
# merged_df$M06_HB_POC_LBORRES_6 <- ifelse("M06_HB_POC_LBORRES_6" %in% names(merged_df),
#                                              merged_df$M06_HB_POC_LBORRES_6, NA) 
# 
# merged_df$M08_CBC_HB_LBORRES_6 <- ifelse("M08_CBC_HB_LBORRES_6" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_6, NA)
# 
# # VISIT 10 doesn't have M08_CBC_HB_LBORRES_10: 
# merged_df$M08_CBC_HB_LBORRES_10 <- ifelse("M08_CBC_HB_LBORRES_10" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_10, NA) 


# VISIT 11 and 12 hans't happened for anyone (PNC26 and PNC52) so variable M08_CBC_HB_LBORRES_11 or _12 don't exist:
merged_df$M08_CBC_HB_LBORRES_11 <- ifelse("M08_CBC_HB_LBORRES_11" %in% names(merged_df),
                                            merged_df$M08_CBC_HB_LBORRES_11, NA) 

merged_df$M08_CBC_HB_LBORRES_12 <- ifelse("M08_CBC_HB_LBORRES_12" %in% names(merged_df),
                                            merged_df$M08_CBC_HB_LBORRES_12, NA)

merged_df$M06_HB_POC_LBORRES_12 <- ifelse("M06_HB_POC_LBORRES_12" %in% names(merged_df),
                                            merged_df$M06_HB_POC_LBORRES_12, NA)

merged_df$M12_MAT_VITAL_MNH12_12 <- ifelse("M12_MAT_VITAL_MNH12_12" %in% names(merged_df),
                                            merged_df$M12_MAT_VITAL_MNH12_12, NA)

merged_df$M12_MAT_VITAL_MNH12_12 <- ifelse("M12_MAT_VITAL_MNH12_12" %in% names(merged_df),
                                            merged_df$M12_MAT_VITAL_MNH12_12, NA)

# PNC-52 BP measures 
merged_df$M06_BP_SYS_VSORRES_1_12 <- ifelse("M06_BP_SYS_VSORRES_1_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_1_12, NA)

merged_df$M06_BP_SYS_VSORRES_2_12 <- ifelse("M06_BP_SYS_VSORRES_2_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_2_12, NA)

merged_df$M06_BP_SYS_VSORRES_3_12 <- ifelse("M06_BP_SYS_VSORRES_3_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_3_12, NA)

merged_df$M06_BP_DIA_VSORRES_1_12 <- ifelse("M06_BP_DIA_VSORRES_1_12" %in% names(merged_df),
                                            merged_df$M06_BP_DIA_VSORRES_1_12, NA)

merged_df$M06_BP_DIA_VSORRES_2_12 <- ifelse("M06_BP_DIA_VSORRES_2_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_2_12, NA)

merged_df$M06_BP_DIA_VSORRES_3_12 <- ifelse("M06_BP_DIA_VSORRES_3_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_3_12, NA)


merged_df$M19_BP_SYS_VSORRES_14 <- ifelse("M19_BP_SYS_VSORRES_14" %in% names(merged_df),
                                            merged_df$M19_BP_SYS_VSORRES_14, NA)

merged_df$M19_BP_DIA_VSORRES_14 <- ifelse("M19_BP_DIA_VSORRES_14" %in% names(merged_df),
                                            merged_df$M19_BP_DIA_VSORRES_14, NA)

# PROTEINURIA VARS
merged_df$M08_UA_PROT_LBORRES_8 <- ifelse("M08_UA_PROT_LBORRES_8" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_8, NA)

merged_df$M08_UA_PROT_LBORRES_9 <- ifelse("M08_UA_PROT_LBORRES_9" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_9, NA)


merged_df$M08_UA_PROT_LBORRES_13 <- ifelse("M08_UA_PROT_LBORRES_13" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_13, NA)

merged_df$M08_UA_PROT_LBORRES_14 <- ifelse("M08_UA_PROT_LBORRES_14" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_14, NA)

# INFECTION TEST VARS - SITES HAVEN'T STARTED USING THESE TESTS YETS - 09/20/2023
M08_SYPH_TITER_LBPERF_1_1 <- ifelse("M08_SYPH_TITER_LBPERF_1_1" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_1, NA)

M08_SYPH_TITER_LBPERF_1_2 <- ifelse("M08_SYPH_TITER_LBPERF_1_2" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_2, NA)

M08_SYPH_TITER_LBPERF_1_3 <- ifelse("M08_SYPH_TITER_LBPERF_1_3" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_3, NA)

M08_SYPH_TITER_LBPERF_1_4 <- ifelse("M08_SYPH_TITER_LBPERF_1_4" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_4, NA)

M08_SYPH_TITER_LBPERF_1_5 <- ifelse("M08_SYPH_TITER_LBPERF_1_5" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_5, NA)

M08_SYPH_TITER_LBPERF_1_10 <- ifelse("M08_SYPH_TITER_LBPERF_1_10" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_10, NA)

M08_HEV_IGM_LBORRES_1 <- ifelse("M08_HEV_IGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_1, NA)

M08_HEV_IGM_LBORRES_2 <- ifelse("M08_HEV_IGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_2, NA)

M08_HEV_IGM_LBORRES_3 <- ifelse("M08_HEV_IGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_3, NA)

M08_HEV_IGM_LBORRES_4 <- ifelse("M08_HEV_IGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_4, NA)

M08_HEV_IGM_LBORRES_5 <- ifelse("M08_HEV_IGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_5, NA)

M08_HEV_IGM_LBORRES_10 <- ifelse("M08_HEV_IGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_10, NA)

M08_CTNG_CT_LBORRES_1 <- ifelse("M08_CTNG_CT_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_1, NA)

M08_CTNG_CT_LBORRES_2 <- ifelse("M08_CTNG_CT_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_2, NA)

M08_CTNG_CT_LBORRES_3 <- ifelse("M08_CTNG_CT_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_3, NA)

M08_CTNG_CT_LBORRES_4 <- ifelse("M08_CTNG_CT_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_4, NA)

M08_CTNG_CT_LBORRES_5 <- ifelse("M08_CTNG_CT_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_5, NA)

M08_CTNG_CT_LBORRES_10 <- ifelse("M08_CTNG_CT_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_10, NA)

M08_CTNG_NG_LBORRES_1 <- ifelse("M08_CTNG_NG_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_1, NA)

M08_CTNG_NG_LBORRES_2 <- ifelse("M08_CTNG_NG_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_2, NA)

M08_CTNG_NG_LBORRES_3 <- ifelse("M08_CTNG_NG_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_3, NA)

M08_CTNG_NG_LBORRES_4 <- ifelse("M08_CTNG_NG_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_4, NA)

M08_CTNG_NG_LBORRES_5 <- ifelse("M08_CTNG_NG_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_5, NA)

M08_CTNG_NG_LBORRES_10 <- ifelse("M08_CTNG_NG_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_10, NA)

M08_ZCD_ZIKIGM_LBORRES_1 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_1, NA)

M08_ZCD_ZIKIGM_LBORRES_2 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_2, NA)

M08_ZCD_ZIKIGM_LBORRES_3 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_3, NA)

M08_ZCD_ZIKIGM_LBORRES_4 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_4, NA)

M08_ZCD_ZIKIGM_LBORRES_5 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_5, NA)

M08_ZCD_ZIKIGM_LBORRES_10 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_10, NA)

M08_ZCD_CHKIGM_LBORRES_1 <- ifelse("M08_ZCD_CHKIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_1, NA)

M08_ZCD_CHKIGM_LBORRES_2 <- ifelse("M08_ZCD_CHKIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_2, NA)

M08_ZCD_CHKIGM_LBORRES_3 <- ifelse("M08_ZCD_CHKIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_3, NA)

M08_ZCD_CHKIGM_LBORRES_4 <- ifelse("M08_ZCD_CHKIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_4, NA)

M08_ZCD_CHKIGM_LBORRES_5 <- ifelse("M08_ZCD_CHKIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_5, NA)

M08_ZCD_CHKIGM_LBORRES_10 <- ifelse("M08_ZCD_CHKIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_10, NA)

M08_ZCD_DENIGM_LBORRES_1 <- ifelse("M08_ZCD_DENIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_1, NA)

M08_ZCD_DENIGM_LBORRES_2 <- ifelse("M08_ZCD_DENIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_2, NA)

M08_ZCD_DENIGM_LBORRES_3 <- ifelse("M08_ZCD_DENIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_3, NA)

M08_ZCD_DENIGM_LBORRES_4 <- ifelse("M08_ZCD_DENIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_4, NA)

M08_ZCD_DENIGM_LBORRES_5 <- ifelse("M08_ZCD_DENIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_5, NA)

M08_ZCD_DENIGM_LBORRES_10 <- ifelse("M08_ZCD_DENIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_10, NA)

M08_LEPT_IGM_LBORRES_1 <- ifelse("M08_LEPT_IGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_1, NA)

M08_LEPT_IGM_LBORRES_2 <- ifelse("M08_LEPT_IGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_2, NA)

M08_LEPT_IGM_LBORRES_3 <- ifelse("M08_LEPT_IGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_3, NA)

M08_LEPT_IGM_LBORRES_4 <- ifelse("M08_LEPT_IGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_4, NA)

M08_LEPT_IGM_LBORRES_5 <- ifelse("M08_LEPT_IGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_5, NA)

M08_LEPT_IGM_LBORRES_10 <- ifelse("M08_LEPT_IGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_10, NA)
```

```{r}

temp.df<- merged_df %>% #[1:200, ] %>%
  select(MOMID, PREGID, SITE,
         (starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
         starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
                       "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
                       "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT")))

  
merged_df <- merged_df %>%
  #SETTING UP VISIT 1 - enrollment.
  # 1st trimester
  mutate(MAT_ANEMIA_MEAS1 = ifelse((!is.na(M08_CBC_HB_LBORRES_1) & between(M08_CBC_HB_LBORRES_1, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_1) & between(M06_HB_POC_LBORRES_1, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_1) & between(M08_CBC_HB_LBORRES_1, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_1) & between(M06_HB_POC_LBORRES_1, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_1) & between(M08_CBC_HB_LBORRES_1, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_1) & between(M06_HB_POC_LBORRES_1, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_1) & between(M08_CBC_HB_LBORRES_1, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_1) & between(M06_HB_POC_LBORRES_1, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_1) & M08_CBC_HB_LBORRES_1 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_1) & M06_HB_POC_LBORRES_1 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_1) & between(M08_CBC_HB_LBORRES_1, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_1) & between(M06_HB_POC_LBORRES_1, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 

temp.df <- merged_df %>%
  select(SITE, MOMID, PREGID, M08_CBC_HB_LBORRES_1, M06_HB_POC_LBORRES_1, MAT_ANEMIA_MEAS1)

table(MAT_ANEMIA_MEAS1 = merged_df$MAT_ANEMIA_MEAS1, useNA = "always", SITE = merged_df$SITE)

merged_df <- merged_df %>% 
  #SETTING UP VISIT 2 - ANC20.
  # 2ND TRIMESTER
  mutate(MAT_ANEMIA_MEAS2 = ifelse((!is.na(M08_CBC_HB_LBORRES_2) & between(M08_CBC_HB_LBORRES_2, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_2) & between(M06_HB_POC_LBORRES_2, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_2) & between(M08_CBC_HB_LBORRES_2, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_2) & between(M06_HB_POC_LBORRES_2, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_2) & between(M08_CBC_HB_LBORRES_2, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_2) & between(M06_HB_POC_LBORRES_2, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_2) & between(M08_CBC_HB_LBORRES_2, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_2) & between(M06_HB_POC_LBORRES_2, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_2) & M08_CBC_HB_LBORRES_2 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_2) & M06_HB_POC_LBORRES_2 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_2) & between(M08_CBC_HB_LBORRES_2, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_2) & between(M06_HB_POC_LBORRES_2, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 

table(merged_df$MAT_ANEMIA_MEAS2, useNA = "always", merged_df$SITE)
  
  
  
  #SETTING UP VISIT 3 - ANC28.
# 3RD trimester
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS3 = ifelse((!is.na(M08_CBC_HB_LBORRES_3) & between(M08_CBC_HB_LBORRES_3, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_3) & between(M06_HB_POC_LBORRES_3, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_3) & between(M08_CBC_HB_LBORRES_3, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_3) & between(M06_HB_POC_LBORRES_3, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_3) & between(M08_CBC_HB_LBORRES_3, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_3) & between(M06_HB_POC_LBORRES_3, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_3) & between(M08_CBC_HB_LBORRES_3, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_3) & between(M06_HB_POC_LBORRES_3, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_3) & M08_CBC_HB_LBORRES_3 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_3) & M06_HB_POC_LBORRES_3 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_3) & between(M08_CBC_HB_LBORRES_3, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_3) & between(M06_HB_POC_LBORRES_3, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 

table(merged_df$MAT_ANEMIA_MEAS3, useNA = "always", merged_df$SITE)
  
  #SETTING UP VISIT 4 - ANC32.
# 3RD TRIMESTER
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS4 = ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_4) & M08_CBC_HB_LBORRES_4 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_4) & M06_HB_POC_LBORRES_4 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 
  

table(merged_df$MAT_ANEMIA_MEAS4, useNA = "always", merged_df$SITE)

  #SETTING UP VISIT 5 - ANC36.
# 3RD TRIMESTER
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS5 = ifelse((!is.na(M08_CBC_HB_LBORRES_5) & between(M08_CBC_HB_LBORRES_5, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_5) & between(M06_HB_POC_LBORRES_5, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_5) & between(M08_CBC_HB_LBORRES_5, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_5) & between(M06_HB_POC_LBORRES_5, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_5) & between(M08_CBC_HB_LBORRES_5, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_5) & between(M06_HB_POC_LBORRES_5, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_5) & between(M08_CBC_HB_LBORRES_5, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_5) & between(M06_HB_POC_LBORRES_5, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_5) & M08_CBC_HB_LBORRES_5 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_5) & M06_HB_POC_LBORRES_5 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_5) & between(M08_CBC_HB_LBORRES_5, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_5) & between(M06_HB_POC_LBORRES_5, 11, 13.0)), "normal", 

                                                                                                                as.character(NA)))))))))))))) 
  

table(merged_df$MAT_ANEMIA_MEAS5, useNA = "always", merged_df$SITE)

# ANEMIA MEASURED PREGNANCY ONLY # 
merged_df <- merged_df %>%
  mutate(MAT_ANEMIA_MEAS_ANC = case_when(MAT_ANEMIA_MEAS1 %in% c("severe", "mild", "moderate") ~ 1, 
                                         MAT_ANEMIA_MEAS2 %in% c("severe", "mild", "moderate") ~ 1,
                                         MAT_ANEMIA_MEAS3 %in% c("severe", "mild", "moderate") ~ 1,
                                         MAT_ANEMIA_MEAS4 %in% c("severe", "mild", "moderate") ~ 1,
                                         MAT_ANEMIA_MEAS5 %in% c("severe", "mild", "moderate") ~ 1,
                                         TRUE ~ as.numeric(0)))

table(merged_df$MAT_ANEMIA_MEAS_ANC, useNA = "always", merged_df$SITE)
round(prop.table(table(merged_df$MAT_ANEMIA_MEAS_ANC, useNA = "always", merged_df$SITE), margin = 2)*100, 3)
  
#SETTING UP VISIT 6 - IPC (L&D).
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS6 = ifelse((!is.na(M08_CBC_HB_LBORRES_6) & between(M08_CBC_HB_LBORRES_6, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_6) & between(M06_HB_POC_LBORRES_6, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_6) & between(M08_CBC_HB_LBORRES_6, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_6) & between(M06_HB_POC_LBORRES_6, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_6) & between(M08_CBC_HB_LBORRES_6, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_6) & between(M06_HB_POC_LBORRES_6, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_6) & between(M08_CBC_HB_LBORRES_6, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_6) & between(M06_HB_POC_LBORRES_6, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_6) & M08_CBC_HB_LBORRES_6 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_6) & M06_HB_POC_LBORRES_6 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_6) & between(M08_CBC_HB_LBORRES_6, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_6) & between(M06_HB_POC_LBORRES_6, 11, 13.0)), "normal",# "normal")))))))))))))


                                                                                                                as.character(NA)))))))))))))) 

table(merged_df$MAT_ANEMIA_MEAS6, useNA = "always", merged_df$SITE)
round(prop.table(table(merged_df$MAT_ANEMIA_MEAS6, useNA = "always", merged_df$SITE), margin = 2)*100, 2)
################################# NOTE ##################################################
# PNC 0, 1, 4, 52 (VISITS 7,8,9, 12) DON'T HAVE LAB VISITS; ONLY HAVE POC DIAGNOSTICS TP)
#########################################################################################  
#SETTING UP VISIT 10 - PNC 6.
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS10 = ifelse((!is.na(M08_CBC_HB_LBORRES_10) & between(M08_CBC_HB_LBORRES_10, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_10) & between(M06_HB_POC_LBORRES_10, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_10) & between(M08_CBC_HB_LBORRES_10, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_10) & between(M06_HB_POC_LBORRES_10, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_10) & between(M08_CBC_HB_LBORRES_10, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_10) & between(M06_HB_POC_LBORRES_10, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_10) & between(M08_CBC_HB_LBORRES_10, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_10) & between(M06_HB_POC_LBORRES_10, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_10) & M08_CBC_HB_LBORRES_10 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_10) & M06_HB_POC_LBORRES_10 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_10) & between(M08_CBC_HB_LBORRES_10, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_10) & between(M06_HB_POC_LBORRES_10, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 
  

table(merged_df$MAT_ANEMIA_MEAS10, useNA = "always", merged_df$SITE)
round(prop.table(table(merged_df$MAT_ANEMIA_MEAS10, useNA = "always", merged_df$SITE), margin = 2)*100, 2)
  #SETTING UP VISIT 11 - PNC 26.
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS11 = ifelse((!is.na(M08_CBC_HB_LBORRES_11) & between(M08_CBC_HB_LBORRES_11, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_11) & between(M06_HB_POC_LBORRES_11, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_11) & between(M08_CBC_HB_LBORRES_11, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_11) & between(M06_HB_POC_LBORRES_11, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_11) & between(M08_CBC_HB_LBORRES_11, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_11) & between(M06_HB_POC_LBORRES_11, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_11) & between(M08_CBC_HB_LBORRES_11, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_11) & between(M06_HB_POC_LBORRES_11, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_11) & M08_CBC_HB_LBORRES_11 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_11) & M06_HB_POC_LBORRES_11 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_11) & between(M08_CBC_HB_LBORRES_11, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_11) & between(M06_HB_POC_LBORRES_11, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 


  table(merged_df$MAT_ANEMIA_MEAS11, useNA = "always", merged_df$SITE)
round(prop.table(table(merged_df$MAT_ANEMIA_MEAS11, useNA = "always", merged_df$SITE), margin = 2)*100, 2)
    # SETTING UP VISIT 12 - PNC 56.
#TODO - these thresholds will change. anything after 42 days of birth, thresholds change to non-pregnant.  
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS12 = ifelse((!is.na(M08_CBC_HB_LBORRES_12) & between(M08_CBC_HB_LBORRES_12, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_12) & between(M06_HB_POC_LBORRES_12, 10, 10.9)), "mild",
                                          ifelse((!is.na(M08_CBC_HB_LBORRES_12) & between(M08_CBC_HB_LBORRES_12, 7.0, 9.9)), "moderate",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_12) & between(M06_HB_POC_LBORRES_12, 7.0, 9.9)), "moderate",
                                                        ifelse((!is.na(M08_CBC_HB_LBORRES_12) & between(M08_CBC_HB_LBORRES_12, 0.0, 6.9)), "severe",
                                                               ifelse((!is.na(M06_HB_POC_LBORRES_12) & between(M06_HB_POC_LBORRES_12, 0.0, 6.9)), "severe",
                                                                      ifelse((!is.na(M08_CBC_HB_LBORRES_12) & between(M08_CBC_HB_LBORRES_12, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_12) & between(M06_HB_POC_LBORRES_12, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_12) & M08_CBC_HB_LBORRES_12 > 14.9), "high hb >=15g/dl",
                                                                                           ifelse((!is.na(M06_HB_POC_LBORRES_12) & M06_HB_POC_LBORRES_12 > 14.9), "high hb >=15g/dl",
                                                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_12) & between(M08_CBC_HB_LBORRES_12, 11, 13.0)), "normal",
                                                                                                         ifelse((!is.na(M06_HB_POC_LBORRES_12) & between(M06_HB_POC_LBORRES_12, 11, 13.0)), "normal",
                                                                                                                as.character(NA)))))))))))))) 

table(merged_df$MAT_ANEMIA_MEAS12, useNA = "always", merged_df$SITE)


temp.df2 <- merged_df %>% select(M06_HB_POC_LBORRES_1, M08_CBC_HB_LBORRES_1, MAT_ANEMIA_MEAS1, 
                                     M06_HB_POC_LBORRES_2, M08_CBC_HB_LBORRES_2, MAT_ANEMIA_MEAS2, 
                                     M06_HB_POC_LBORRES_3, M08_CBC_HB_LBORRES_3, MAT_ANEMIA_MEAS3,
                                     M06_HB_POC_LBORRES_4, M08_CBC_HB_LBORRES_4, MAT_ANEMIA_MEAS4,
                                     M06_HB_POC_LBORRES_5, M08_CBC_HB_LBORRES_5, MAT_ANEMIA_MEAS5,
                                     M06_HB_POC_LBORRES_6, M08_CBC_HB_LBORRES_6, MAT_ANEMIA_MEAS6,)

table(ANEMIA_1=merged_df$MAT_ANEMIA_MEAS1, useNA = "always") 
table(ANEMIA_2=merged_df$MAT_ANEMIA_MEAS2, useNA = "always") 
table(ANEMIA_3=merged_df$MAT_ANEMIA_MEAS3, useNA = "always") 
table(ANEMIA_4=merged_df$MAT_ANEMIA_MEAS4, useNA = "always") 
table(ANEMIA_5=merged_df$MAT_ANEMIA_MEAS5, useNA = "always") 
table(ANEMIA_LD=merged_df$MAT_ANEMIA_MEAS6, useNA = "always")
table(ANEMIA_PNC1=merged_df$MAT_ANEMIA_MEAS10, useNA = "always") 
table(ANEMIA_PNC26=merged_df$MAT_ANEMIA_MEAS11, useNA = "always")
table(ANEMIA_PNC56=merged_df$MAT_ANEMIA_MEAS12, useNA = "always")

table(merged_df$M06_HB_POC_LBORRES_5, useNA = "always")
table(merged_df$M08_CBC_HB_LBORRES_5, useNA = "always")
```

***ANEMIA DURING PNC0 (VISIT 7), PNC1 (VISIT 8), PNC4 (VISIT 9) - ONLY POC Diagnostics (MNH06) is done, not Lab results (MNH08)***

```{r echo=FALSE}
merged_df <- merged_df %>%
  # VISIT 7 - PNC 0
  mutate(MAT_ANEMIA_MEAS7 = ifelse((!is.na(M06_HB_POC_LBORRES_7) & between(M06_HB_POC_LBORRES_7, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_7) & between(M06_HB_POC_LBORRES_7, 7.0, 9.9)), "moderate",
                                          ifelse((!is.na(M06_HB_POC_LBORRES_7) & between(M06_HB_POC_LBORRES_7, 0.0, 6.9)), "severe",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_7) & between(M06_HB_POC_LBORRES_7, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_7) & M06_HB_POC_LBORRES_7 > 14.9), "high hb >=15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_7) & between(M06_HB_POC_LBORRES_7, 11, 13.0)), "normal",
                                                               as.character(NA))))))))


table(merged_df$MAT_ANEMIA_MEAS7, useNA = "always", merged_df$SITE)

  # VISIT 8 - PNC 1
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS8 = ifelse((!is.na(M06_HB_POC_LBORRES_8) & between(M06_HB_POC_LBORRES_8, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_8) & between(M06_HB_POC_LBORRES_8, 7.0, 9.9)), "moderate",
                                          ifelse((!is.na(M06_HB_POC_LBORRES_8) & between(M06_HB_POC_LBORRES_8, 0.0, 6.9)), "severe",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_8) & between(M06_HB_POC_LBORRES_8, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_8) & M06_HB_POC_LBORRES_8 > 14.9), "high hb >=15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_8) & between(M06_HB_POC_LBORRES_8, 11, 13.0)), "normal",
                                                               as.character(NA))))))))

table(merged_df$MAT_ANEMIA_MEAS8, useNA = "always", merged_df$SITE)

  # VISIT 9 - PNC 4
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS9 = ifelse((!is.na(M06_HB_POC_LBORRES_9) & between(M06_HB_POC_LBORRES_9, 10, 10.9)), "mild",
                                   ifelse((!is.na(M06_HB_POC_LBORRES_9) & between(M06_HB_POC_LBORRES_9, 7.0, 9.9)), "moderate",
                                          ifelse((!is.na(M06_HB_POC_LBORRES_9) & between(M06_HB_POC_LBORRES_9, 0.0, 6.9)), "severe",
                                                 ifelse((!is.na(M06_HB_POC_LBORRES_9) & between(M06_HB_POC_LBORRES_9, 13.1, 14.9)), "high hb 13-<15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_9) & M06_HB_POC_LBORRES_9 > 14.9), "high hb >=15g/dl",
                                                        ifelse((!is.na(M06_HB_POC_LBORRES_9) & between(M06_HB_POC_LBORRES_9, 11, 13.0)), "normal",
                                                               as.character(NA))))))))

table(merged_df$MAT_ANEMIA_MEAS9, useNA = "always", merged_df$SITE)

temp.df2 <- merged_df %>% select(M06_HB_POC_LBORRES_8,MAT_ANEMIA_MEAS7)
table(ANEMIA_PNC0=merged_df$MAT_ANEMIA_MEAS7, useNA = "always")
table(ANEMIA_PNC1=merged_df$MAT_ANEMIA_MEAS8, useNA = "always")
table(ANEMIA_PNC4=merged_df$MAT_ANEMIA_MEAS9, useNA = "always")
```

Email from ES and Gates on Sept 10, 2023: Anemia prevalence by GA: what percent of women are anemic for each visit window? Stratify by mild, moderate and severe. Also, calculate for any anemia (< 11 for pregnancy and PNC-1,2,3). 

Any anemia during pregnancy and PNC1,2,3 
```{r echo=FALSE}
merged_df <- merged_df %>% 
  mutate(MAT_ANEMIA_MEAS_ANY = ifelse((MAT_ANEMIA_MEAS1 == "mild" |  MAT_ANEMIA_MEAS2 == "mild" | MAT_ANEMIA_MEAS3 == "mild" |
                                         MAT_ANEMIA_MEAS4 == "mild" | MAT_ANEMIA_MEAS5 == "mild" | MAT_ANEMIA_MEAS6 == "mild" | 
                                         MAT_ANEMIA_MEAS7 == "mild" | MAT_ANEMIA_MEAS8 == "mild" | MAT_ANEMIA_MEAS9 == "mild"), "anemic",
                                      
                                      ifelse((MAT_ANEMIA_MEAS1 == "moderate" |  MAT_ANEMIA_MEAS2 == "moderate" | MAT_ANEMIA_MEAS3 == "moderate" |
                                                MAT_ANEMIA_MEAS4 == "moderate" | MAT_ANEMIA_MEAS5 == "moderate" | MAT_ANEMIA_MEAS6 == "moderate" | 
                                                MAT_ANEMIA_MEAS7 == "moderate" | MAT_ANEMIA_MEAS8 == "moderate" | MAT_ANEMIA_MEAS9 == "moderate"), "anemic",
                                             
                                             ifelse((MAT_ANEMIA_MEAS1 == "severe" |  MAT_ANEMIA_MEAS2 == "severe" | MAT_ANEMIA_MEAS3 == "severe" |
                                                       MAT_ANEMIA_MEAS4 == "severe" | MAT_ANEMIA_MEAS5 == "severe" | MAT_ANEMIA_MEAS6 == "severe" | 
                                                       MAT_ANEMIA_MEAS7 == "severe" | MAT_ANEMIA_MEAS8 == "severe" | MAT_ANEMIA_MEAS9 == "severe"), "anemic",
                                                    
                                                    ifelse((MAT_ANEMIA_MEAS1 == "normal" |  MAT_ANEMIA_MEAS2 == "normal" | MAT_ANEMIA_MEAS3 == "normal" |
                                                              MAT_ANEMIA_MEAS4 == "normal" | MAT_ANEMIA_MEAS5 == "normal" | MAT_ANEMIA_MEAS6 == "normal" | 
                                                              MAT_ANEMIA_MEAS7 == "normal" | MAT_ANEMIA_MEAS8 == "normal" | MAT_ANEMIA_MEAS9 == "normal"), "normal", NA)))))

table(merged_df$MAT_ANEMIA_MEAS_ANY, merged_df$SITE, useNA = "always")
round(prop.table(table(merged_df$MAT_ANEMIA_MEAS_ANY, merged_df$SITE, useNA = "always"), margin=2)*100, 3)
```

***MATERNAL DEATH***
Death from any cause related to or aggravated by pregnancy or its management (excluding accidental or incidental causes) during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

"Death from any cause during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

L&D: 
M09_DELIV_DSSTDAT_INF1
M10_MAT_DSTERM

Maternal closeout:
M23_CLOSE_DSDECOD
M23_ACC_DDORRES
M23_DTHDAT

Verbal autopsy:
M27 (all of these need to be 0=No): Id10077
Id10079
Id10083
Id10084
Id10085
Id10086
Id10087
Id10088
Id10089
Id10090
Id10091
Id10092
Id10093
Id10094
Id10095
Id10096

If maternal status after delivery ==3 (died) or CLOSE_DSDECOD == 3(died) and (M23_ACC_DDORRES==0 or 99 OR all VA ==0, then calculate delivery date and death date and if it is <42 days then MAT_DEATH==1. 
```{r echo=FALSE}
temp.df <- merged_df %>% select(MOMID, PREGID, SITE, M09_DELIV_DSSTDAT_INF1_6,M09_DELIV_DSSTDAT_INF2_6,
  M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6, M10_MAT_DSTERM_6, M23_CLOSE_DSDECOD, M23_DTHDAT, M23_ACC_DDORRES)

merged_df <- merged_df %>% #'any' is checking if anything in these columns by row(dplyr is doing the by-row part) is NA.
mutate(var_w_deliverydate = any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6,
                                         M09_DELIV_DSSTDAT_INF2_6,
                                         M09_DELIV_DSSTDAT_INF3_6,
                                         M09_DELIV_DSSTDAT_INF4_6)))) %>% 
  rowwise() %>%
  mutate(MAT_DEATH = if_else(M23_CLOSE_DSDECOD == 3 | 
                               !is.na(M23_DTHDAT) | 
                               M10_MAT_DSTERM_6==3 &
                               (M23_ACC_DDORRES==0 | M23_ACC_DDORRES==99), 
                             if_else(var_w_deliverydate,
                                     as.numeric(as.Date(M23_DTHDAT) - as.Date(max(M09_DELIV_DSSTDAT_INF1_6,
                                                                                  M09_DELIV_DSSTDAT_INF2_6, 
                                                                                  M09_DELIV_DSSTDAT_INF3_6,
                                                                                  M09_DELIV_DSSTDAT_INF4_6, 
                                                                                  na.rm = TRUE)) <
                                                  as.difftime(43, units = "days")),
                                     1), 
                             0)) %>% 
  mutate(MAT_DEATH = if_else(M23_CLOSE_DSDECOD==4 | M23_CLOSE_DSDECOD==5, 9, MAT_DEATH))

#table(merged_df$MAT_DEATH)
table(MAT_DEATH = merged_df$MAT_DEATH, SITE = merged_df$SITE) # data is molsty 2=Alive or 4 = loss to follow up or NA.
round(prop.table(table(MAT_DEATH = merged_df$MAT_DEATH, SITE = merged_df$SITE), margin=2)*100, 2) # data is molsty 2=Alive or 4 = loss to follow up or NA. 
```

***CRITICAL INTERVENTIONS***
Any of the following critical interventions that occurred during pregnancy, childbirth or within 42 days of termination of pregnancy: admission to intensive care unit, laparotomy (includes hysterectomy, excludes CS), and/or use of blood products.

L&D: 
M09_DELIV_DSSTDAT_INF1
M09_PPH_TRNSFSN_PROCCUR
M09_PPH_TRNSFSN_PROCCUR
M09_PPH_FAORRES_5
M10_TRANSFER_OHOLOC
M19_OBSSTDAT

Hospitalization:
M19_TX_PROCCUR_1
M19_TX_PROCCUR_2
M19_TX_PROCCUR_3
M19_TX_PROCCUR_5

```{r, echo=FALSE}
#######################################################
#TODO 
# - ADD HOPITALIZATION VARS
# - FIX NA TO 0
######################################################

temp.df <- merged_df %>%
  select(MOMID, PREGID, 
         M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
         M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6,
         M09_PPH_TRNSFSN_PROCCUR_6, M09_PPH_TRNSFSN_PROCCUR_6, 
         M09_PPH_FAORRES_5_6, M10_TRANSFER_OHOLOC_6, M19_OBSSTDAT_13,
         M19_TX_PROCCUR_1_13, M19_TX_PROCCUR_2_13, M19_TX_PROCCUR_3_13, M19_TX_PROCCUR_5_13,)

merged_df <- merged_df %>%  
  #'any' is checking if anything in these columns by row (dplyr is doing the by-row part) is not NA.
  mutate(var_w_deliverydate = 
           any(!is.na(c(M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6,
                        M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6)))) %>% 
  rowwise() %>%
  
  mutate(MAT_INTER_LnD = if_else(var_w_deliverydate==TRUE, 
                                 if_else((!is.na(M09_PPH_TRNSFSN_PROCCUR_6) & M09_PPH_TRNSFSN_PROCCUR_6==1) | 
                                           (!is.na(M09_PPH_FAORRES_5_6) & M09_PPH_FAORRES_5_6==1) |
                                           (!is.na(M10_TRANSFER_OHOLOC_6) & M10_TRANSFER_OHOLOC_6 %in% c(1,2))|
                                           (!is.na(M19_TX_PROCCUR_1_13) & M19_TX_PROCCUR_1_13==1) |
                                           (!is.na(M19_TX_PROCCUR_2_13) & M19_TX_PROCCUR_2_13==1) | 
                                           (!is.na(M19_TX_PROCCUR_3_13) & M19_TX_PROCCUR_3_13==1) | 
                                           (!is.na(M19_TX_PROCCUR_5_13) & M19_TX_PROCCUR_5_13==1),
                                         1, 0), 
                                 NA)) # NA means no delivery date. 
# NOTE: I don't need all of this below b/c if deliverydate==TRUE then we check whether there was an intervention or not, and when there is an intervention it is a 1, when there is no intervention (and delivery date = TRUE) then it's a 0, otherwise NA. 

                                         # if_else((is.na(M09_PPH_TRNSFSN_PROCCUR_6) |
                                         #            M09_PPH_TRNSFSN_PROCCUR_6== 0 |
                                         #            M09_PPH_TRNSFSN_PROCCUR_6==99) &
                                         #           (is.na(M09_PPH_FAORRES_5_6) |
                                         #              M09_PPH_FAORRES_5_6==0) &
                                         #           (is.na(M10_TRANSFER_OHOLOC_6)),


round(prop.table(table(CRITICAL_INTERVENTIONS = merged_df$MAT_INTER_LnD, SITE = merged_df$SITE, useNA = "always"), margin = 2)*100, 2)
#TODO Print out what is ==1 to discuss with sites. 
```


***PRETERM BIRTH SPONTANEIOUS = PRETERM_SPON, PRETERM_PROV, PPROM_OCCUR, PRETERM_ANY***
Spontaneous preterm: Defined as delivery <37 weeks that occurs either secondary to preterm labor or preterm premature rupture of membranes.
MNH01	US_GA_WKS_AGE_FTS1	1st fetus: GA by ultrasound at TODAY’s visit:  weeks
MNH01	TYPE_VISIT	Indicate study timepoint when the ultrasound was performed:
MNH04	PTL_MHOCCUR	Preterm labor/risk of preterm birth?
MNH09	PTB_MHOCCUR	Preterm labor/risk of preterm birth?
		Was labor induced?
		Primary reason for induction?
		Was Cesarean delivery emergent or planned?
		Specify indication for Cesarean delivery
MNH09	MEMBRANE_RUPT_MHTERM	Type of membrane rupture?
		Date of membrane rupture
MNH09	DELIV_DSSTDAT_INF1	Date of delivery: 


PPROM: Rupture of membranes before the onset of labor, occurring before <37 weeks of gestation OR clinical diagnosis of premature rupture of membranes.


```{r echo=FALSE}
##################################################################################
#TODO 
# NOTES: 
# - Should this be coded just based on GA at birth as well? #
# - Currently, all M09_PTB_MHSTDAT_6 have dates associated. 
# - Currently sPTB and iPTB both have n=19 if i say "&" between M09_PTB_MHOCCUR_6 and M09_INDUCED_PROCCUR_6==0 or 1.
     # There are only n=19 M09_PTB_MHOCCUR_6==1.
# - Date of delivery should be used to determine if <37 weeks GA. 
#TODO: FIX PTB ANY (VALUES CURRENTLY SAME AS iPTB)
##################################################################################


#***sPTB** #
merged_df <- merged_df %>% 
  mutate(PRETERM_SPON = ifelse((!is.na(M09_PTB_MHOCCUR_6) & M09_PTB_MHOCCUR_6==1 | !is.na(M09_PTB_MHSTDAT_6)) &
                                 ((!is.na(M09_INDUCED_PROCCUR_6) & M09_INDUCED_PROCCUR_6==0) | (!is.na(M09_MEMBRANE_RUPT_MHTERM_6) & M09_MEMBRANE_RUPT_MHTERM_6==1)), 
                               1,0))

table(PRETERM_SPON = merged_df$PRETERM_SPON, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(PRETERM_SPON = merged_df$PRETERM_SPON, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)

#***iPTB** #
merged_df <- merged_df %>% 
  mutate(PRETERM_PROV = ifelse((!is.na(M09_PTB_MHOCCUR_6) & M09_PTB_MHOCCUR_6==1 | !is.na(M09_PTB_MHSTDAT_6)) |
                                 ((!is.na(M09_INDUCED_PROCCUR_6) & M09_INDUCED_PROCCUR_6==1) | (!is.na(M09_MEMBRANE_RUPT_MHTERM_6) & M09_MEMBRANE_RUPT_MHTERM_6==2)), 
                               1,0))

table(PRETERM_PROV = merged_df$PRETERM_PROV, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(PRETERM_PROV = merged_df$PRETERM_PROV, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)

#***PPROM** #
merged_df <- merged_df %>% 
  mutate(PPROM_OCCUR = ifelse((!is.na(M09_INDUCED_PROCCUR_6) & (M09_INDUCED_PROCCUR_6==1 | M09_INDUCED_PROCCUR_6==0)) | # was labor induced or not?
                                (!is.na(M09_INDUCED_PRTRT_1_6) & M09_INDUCED_PRTRT_1_6==1) | # type of induction = artificial rupture membranes.
                                (!is.na(M09_MEMBRANE_RUPT_MHTERM_6) & 
                                   (M09_MEMBRANE_RUPT_MHTERM_6==1 | M09_MEMBRANE_RUPT_MHTERM_6==2)) | # type of rupt: sPTB or iPTB both will work. 
                                ((!is.na(M19_MEMBRANE_RUPT_CEOCCUR_13) & M19_MEMBRANE_RUPT_CEOCCUR_13==1) &
                                (!is.na(M19_LD_COMPL_MHTERM_1_13) & M19_LD_COMPL_MHTERM_1_13==1) |
                                (!is.na(M19_ANT_MEMBRANE_RUPT_CEOCCUR_13) & M19_ANT_MEMBRANE_RUPT_CEOCCUR_13==1)),
                              1,0))

table(PPROM_OCCUR = merged_df$PPROM_OCCUR, SITE = merged_df$SITE, useNA = "always")

round(prop.table(table(PPROM_OCCUR = merged_df$PPROM_OCCUR, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)

#TODO: THIS NEEDS TO BE REVISED. IT IS THE SAME AS iPTB.
#***any_PTB** #
merged_df <- merged_df %>% 
  mutate(PRETERM_ANY = ifelse((PRETERM_SPON==1 | PRETERM_PROV==1), 1,0))


table(ANY_PTB = merged_df$PRETERM_ANY, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(ANY_PTB = merged_df$PRETERM_ANY, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```

***TERTIARY: PLACENTA PREVIA - PLACENTA_PREVIA***
Placenta previa is defined at the partial or complete covering of the cervix by the placenta. Signs include vaginal bleeding without pain in the second or third trimester. Diagnosis made via ultrasound. Ocurring ≥20 weeks to prior to delivery. 

- Look at just ANC-32 and IPC.
```{r}
merged_df <- merged_df %>% 
  mutate(PLACENTA_PREVIA = case_when(M01_PREVIA_PERES_FTS1_4==3 | M09_APH_FAORRES_1_6==1 | M09_APH_FAORRES_2_6==1 ~ 1,
                                     TRUE ~ as.numeric(0)))

table(PLACENTA_PREVIA = merged_df$PLACENTA_PREVIA, useNA = "always")
```

***TERTIARY: PLACENTAL ABRUPTION - PLACENTAL_ABRUPT***
Placental abruption is defined as the complete or partial separation of the placenta from the inner wall of the uterus before delivery. Signs include vaginal bleeding (painful or painless), pain during abdominal palpitations, and/or fetal distress. Diagnosis made via ultrasound. Ocurring ≥20 weeks to prior to delivery. 

- LOOK AT ANC-32 OR IPC.
```{r}
# merged_df <- merged_df %>% 
#   mutate(PLACENTAL_ABRUPT = case_when())
```



***TERTIARY: UTERINE RUPTURE = MAT_UTER_RUP***
Tear in the muscular wall of the uterus during pregnancy or childbirth.
L&D: 
M09_RUPT_UTERUS_CEOCCUR
M09_PPH_COMP_3

PNC:
M12_BIRTH_COMPL_MHTERM_3

Hospitalization:
M19_LD_COMPL_MHTERM_7

```{r echo=FALSE}
merged_df$M12_BIRTH_COMPL_MHTERM_3 <- ifelse("M12_BIRTH_COMPL_MHTERM_3" %in% names(merged_df),
                                            merged_df$M12_BIRTH_COMPL_MHTERM_3, NA)

merged_df$M19_LD_COMPL_MHTERM_7_13 <- ifelse("M19_LD_COMPL_MHTERM_7_13" %in% names(merged_df),
                                            merged_df$M19_LD_COMPL_MHTERM_7_13, NA)

temp.df <- merged_df %>% 
  dplyr::select(MOMID, PREGID, M09_RUPT_UTERUS_CEOCCUR_6, M09_PPH_COMP_3_6, M12_BIRTH_COMPL_MHTERM_3, M19_LD_COMPL_MHTERM_7_13)

merged_df <- merged_df %>% 
  mutate(MAT_UTER_RUP = if_else((!is.na(M09_RUPT_UTERUS_CEOCCUR_6) & M09_RUPT_UTERUS_CEOCCUR_6==1) | 
                                           (!is.na(M09_PPH_COMP_3_6) & M09_PPH_COMP_3_6==1) |
                                           (!is.na(M12_BIRTH_COMPL_MHTERM_3) & M12_BIRTH_COMPL_MHTERM_3==1)|
                                           (!is.na(M19_LD_COMPL_MHTERM_7_13) & M19_LD_COMPL_MHTERM_7_13==1),
                                1, 
                                if_else((!is.na(M09_RUPT_UTERUS_CEOCCUR_6) & M09_RUPT_UTERUS_CEOCCUR_6==0) | 
                                           (!is.na(M09_PPH_COMP_3_6) & M09_PPH_COMP_3_6==0) |
                                           (!is.na(M12_BIRTH_COMPL_MHTERM_3) & M12_BIRTH_COMPL_MHTERM_3==0)|
                                           (!is.na(M19_LD_COMPL_MHTERM_7_13) & M19_LD_COMPL_MHTERM_7_13==0),
                                        0,
                                        NA)))

table(MAT_UTERINE_RUPTURE = merged_df$MAT_UTER_RUP, SITE= merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_UTERINE_RUPTURE = merged_df$MAT_UTER_RUP, SITE= merged_df$SITE, useNA = "always"), margin = 2)*100, 2)
```

***LATE MATERNAL MORTALITY - SECONDARY OUTCOMES*** = LATE_MAT_DEATH
Death from any cause related to or aggravated by pregnancy or its management (excluding accidental or incidental causes), irrespective of the duration and site of the pregnancy, from 42 days postpartum up to one year.

MNH12	MAT_VITAL_MNH12
MNH12	TYPE_VISIT
MNH23	ACC_DDORRES = Was the death due to accidental or incidental causes (e.g., fall, road traffic accident, burns, poisoning, drowning, animal bite)? (1,0,99)
MNH23	CLOSE_DSDECOD = Record the primary reason for close-out: "1, 1-year postpartum follow-up period after live birth or stillbirth has ended
                                                                2, 42-day follow-up period after spontaneous abortion (miscarriage) or induced abortion has ended
                                                                3, Mother died before the completion of the follow-up period
                                                                4, Participant withdrew consent at any point before completion of the follow-up period 
                                                                5, Investigator terminated participation at any point before completion of follow-up period
                                                                6, Lost-to-follow-up"

MNH23	DTHDAT: Record date of death.
MNH27	Id10077
MNH27	Id10079
MNH27	Id10083
MNH27	Id10084
MNH27	Id10085
MNH27	Id10086
MNH27	Id10087
MNH27	Id10088
MNH27	Id10089
MNH27	Id10090
MNH27	Id10091
MNH27	Id10092
MNH27	Id10093
MNH27	Id10094
MNH27	Id10095
MNH27	Id10096

*Add non-schedule PNC visits - TYPE_VISIT=14*

```{r echo=FALSE}
# Add M12_MAT_VITAL_MNH12_7-12
#TODO Why is M23_DTHDAT NA for a women who died during PNC visit 9.
temp.df <- merged_df %>% select(MOMID, PREGID, SITE,
                                    starts_with("M12_MAT_VITAL_MNH12_"), 
                                    M23_CLOSE_DSDECOD, M23_DTHDAT, M23_ACC_DDORRES)

# temp.df[temp.df$MOMID == "KEARC00094", "M23_DTHDAT"] <- as.Date("2023-04-01")
#temp.df[temp.df$MOMID == "KEARC00094", "M23_CLOSE_DSDECOD"] <- 3

merged_df <- merged_df %>%
  mutate(LATE_MAT_DEATH = if_else((M23_CLOSE_DSDECOD == 3 |
                                     !is.na(M23_DTHDAT)) & 
                                    !is.na(M23_ACC_DDORRES) & (M23_ACC_DDORRES==0 | M23_ACC_DDORRES==99) &
                                    (M12_MAT_VITAL_MNH12_7==2 |
                                       M12_MAT_VITAL_MNH12_8==2 |
                                       M12_MAT_VITAL_MNH12_9==2 |
                                       M12_MAT_VITAL_MNH12_10==2 |
                                       M12_MAT_VITAL_MNH12_11==2 |
                                       M12_MAT_VITAL_MNH12_11==2), 
                                  1,
                                  if_else((M12_MAT_VITAL_MNH12_7==1 |
                                             M12_MAT_VITAL_MNH12_8==1 |
                                             M12_MAT_VITAL_MNH12_9==1 |
                                             M12_MAT_VITAL_MNH12_10==1 |
                                             M12_MAT_VITAL_MNH12_11==1 |
                                             M12_MAT_VITAL_MNH12_11==1),
                                  0, 
                                  NA)))
                            
table(LATE_MAT_DEATH = merged_df$LATE_MAT_DEATH, SITE = merged_df$SITE, useNA = "always") 
#TODO Convert M23 info for closeout response and date into an OR not AND.
```

***CHRONIC HYPERTENSION - CHRON_HYPER***
Clinical diagnosis of chronic hypertension AND/OR systolic blood pressure ≥140 mm Hg AND/OR diastolic blood pressure ≥90 mm Hg before 20 weeks’ gestation.
ENROLLMENT

```{r echo=FALSE}
merged_df <- merged_df %>% 
  rowwise() %>% 
  mutate(meanSBP_ANC_LT20 = mean(c(M06_BP_SYS_VSORRES_1_1, M06_BP_SYS_VSORRES_2_1, M06_BP_SYS_VSORRES_3_1), na.rm = TRUE), # ANC
         meanDBP_ANC_LT20 = mean(c(M06_BP_DIA_VSORRES_1_1, M06_BP_DIA_VSORRES_2_1, M06_BP_DIA_VSORRES_3_1), na.rm = TRUE))# ANC 


merged_df <- merged_df %>% 
  mutate(CHRON_HYPER = case_when((meanSBP_ANC_LT20 >=140 | meanDBP_ANC_LT20 >=90)  ~ 1, 
                                     TRUE  ~ as.numeric(0)))
table(merged_df$CHRON_HYPER, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(merged_df$CHRON_HYPER, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```

***GESTATIONAL HYPERTENSION (gHTN) - GEST_HYPER_MEAS***
"A systolic blood pressure >140 mm Hg on two occasions at least 1 hour apart or diastolic blood pressure >90 mm Hg on two occasions at least 1 hour apart or severe gestational hypertension in pregnancy (not at time of delivery) defined as systolic blood pressure > 160 mmHg or a diastolic blood pressure >110 mmHg on two occasions at least 1 minute apart after 20 weeks gestation or severe gestational hypertension at the time of delivery defined as one systolic blood pressure > 160 mmHg or a diastolic blood pressure >110 mmHg among participants without chronic hypertension.

Suggested change: A systolic blood pressure ≥140 mm Hg OR diastolic blood pressure ≥90 mm Hg after 20 weeks gestation (among participants without chronic hypertension). "

"ANC
Wk 20, 28, 32, 36 (VISITS 2-4),
Then, IPD (VISIT 6), then: MNH19 Hospitalization.

L&D"	we don't MNH04 at L&D so won't have those vars. 
MNH01	US_GA_WKS_AGE_FTS1	1st fetus: GA by ultrasound at TODAY’s visit:  weeks
		MNH04	HTN_EVER_MHOCCUR	Have you ever been diagnosed with chronic hypertension?
		MNH04	HPD_MHTERM	Specify type of HPD
		MNH06	TYPE_VISIT	Indicate type of visit when PoC measurements were performed:
		MNH06	BP_SYS_VSORRES_1	Record first BP measurement:  (systolic) mm Hg
		MNH06	BP_SYS_VSORRES_2	Record 2nd BP measurement:  (systolic) mm Hg
		MNH06	BP_SYS_VSORRES_3	Record 3rd BP measurement:  (systolic) mm Hg
		MNH06	BP_DIA_VSORRES_1	Record first BP measurement: (diastolic) mm Hg   
		MNH06	BP_DIA_VSORRES_2	Record 2nd BP measurement: (diastolic) mm Hg
		MNH06	BP_DIA_VSORRES_3	Record 3rd BP measurement: (diastolic) mm Hg 
		
		
Medications include magnesium sulfate, hydralazine, methyldopa (aldomet), atenolol, nifedipine, betamethasone, labetalol, and dexamethasone. 

***SEVERE GESTATIONAL HYPERTENSION - SEVERE_GEST_HYPER***
In pregnancy defined as systolic blood pressure ≥160 mmHg or a diastolic blood pressure ≥110 mmHg on two occasions at least 1 minute apart after 20 weeks gestation OR at the time of delivery defined as one systolic blood pressure ≥160 mmHg or a diastolic blood pressure ≥110 mmHg among participants without chronic hypertension.
```{r echo=FALSE}
###################################################################################################
#TODO 
# NOTES: 
########## NEEDS A LOT OF ATTENTION###########
# - Currently coded without medication prescribed variables M04_HTN_CMTRT_ #
      # b/c most of these are 0 or NA even when gHTN ==1. 
# - Emily said to look at the subsequent visit also b/c we are not collecting 1 hr later if BP high.
#       But need to figure out if Hospitalization happened at any of these visit in between to see which visit will be considered subsequent.
# - Have these NAs: M06_BP_SYS_VSORRES_3_NA - what to do???
#TODO EMILY WILL LET ME KNOW IF BP NON CONSEQUATIVE OK?  - MAY HAVE TO TAKE INTO ACCOUNT UNSCHEDULED VISITS. 
# DISCUSSION POINTS 09/21/2023 
# Create separate categories for DIAGNOSED, MEASURED and TREATED. 
# - Make a classic case of gHTN also where either BP high OR medication use. 
###################################################################################################
temp.df <- merged_df %>% 
  select(MOMID, PREGID, SITE,
         M19_BP_SYS_VSORRES_13, M19_BP_DIA_VSORRES_13,
         starts_with(c("M06_BP_SYS_VSORRES_", "M06_BP_DIA_VSORRES_", "M04_HTN_CMTRT_"))) 

merged_df <- merged_df %>% 
  rowwise() %>% 
  mutate(meanSBP_ANC20 = mean(c(M06_BP_SYS_VSORRES_1_2, M06_BP_SYS_VSORRES_2_2, M06_BP_SYS_VSORRES_3_2), na.rm = TRUE), # ANC
         meanDBP_ANC20 = mean(c(M06_BP_DIA_VSORRES_1_2, M06_BP_DIA_VSORRES_2_2, M06_BP_DIA_VSORRES_3_2), na.rm = TRUE), # ANC 
         
         meanSBP_ANC28 = mean(c(M06_BP_SYS_VSORRES_1_3, M06_BP_SYS_VSORRES_2_3, M06_BP_SYS_VSORRES_3_3), na.rm = TRUE), # ANC
         meanDBP_ANC28 = mean(c(M06_BP_DIA_VSORRES_1_3, M06_BP_DIA_VSORRES_2_3, M06_BP_DIA_VSORRES_3_3), na.rm = TRUE), # ANC
         
         meanSBP_ANC32 = mean(c(M06_BP_SYS_VSORRES_1_4, M06_BP_SYS_VSORRES_2_4, M06_BP_SYS_VSORRES_3_4), na.rm = TRUE), # ANC
         meanDBP_ANC32 = mean(c(M06_BP_DIA_VSORRES_1_4, M06_BP_DIA_VSORRES_2_4, M06_BP_DIA_VSORRES_3_4), na.rm = TRUE), # ANC
         
         meanSBP_ANC36 = mean(c(M06_BP_SYS_VSORRES_1_5, M06_BP_SYS_VSORRES_2_5, M06_BP_SYS_VSORRES_3_5), na.rm = TRUE), # ANC
         meanDBP_ANC36 = mean(c(M06_BP_DIA_VSORRES_1_5, M06_BP_DIA_VSORRES_2_5, M06_BP_DIA_VSORRES_3_5), na.rm = TRUE), # ANC
         
         meanSBP_IPC = mean(c(M06_BP_SYS_VSORRES_1_6, M06_BP_SYS_VSORRES_2_6, M06_BP_SYS_VSORRES_3_6), na.rm = TRUE), # L&D
         meanDBP_IPC = mean(c(M06_BP_DIA_VSORRES_1_6, M06_BP_DIA_VSORRES_2_6, M06_BP_DIA_VSORRES_3_6), na.rm = TRUE), # L&D
         
         meanSBP_Hosp_ANC = M19_BP_SYS_VSORRES_13, # ANC HOSPITALIZATION
         meanDBP_Hosp_ANC = M19_BP_DIA_VSORRES_13, # ANC HOSPITALIZATION
         
         meanSBP_PNC0 = mean(c(M06_BP_SYS_VSORRES_1_7, M06_BP_SYS_VSORRES_2_7, M06_BP_SYS_VSORRES_3_7), na.rm = TRUE), # PNC
         meanDBP_PNC0 = mean(c(M06_BP_DIA_VSORRES_1_7, M06_BP_DIA_VSORRES_2_7, M06_BP_DIA_VSORRES_3_7), na.rm = TRUE), # PNC
         
         meanSBP_PNC1 = mean(c(M06_BP_SYS_VSORRES_1_8, M06_BP_SYS_VSORRES_2_8, M06_BP_SYS_VSORRES_3_8), na.rm = TRUE), # PNC
         meanDBP_PNC1 = mean(c(M06_BP_DIA_VSORRES_1_8, M06_BP_DIA_VSORRES_2_8, M06_BP_DIA_VSORRES_3_8), na.rm = TRUE), # PNC
         
         meanSBP_PNC4 = mean(c(M06_BP_SYS_VSORRES_1_9, M06_BP_SYS_VSORRES_2_9, M06_BP_SYS_VSORRES_3_9), na.rm = TRUE), # PNC
         meanDBP_PNC4 = mean(c(M06_BP_DIA_VSORRES_1_9, M06_BP_DIA_VSORRES_2_9, M06_BP_DIA_VSORRES_3_9), na.rm = TRUE), # PNC
         
         meanSBP_PNC6 = mean(c(M06_BP_SYS_VSORRES_1_10, M06_BP_SYS_VSORRES_2_10, M06_BP_SYS_VSORRES_3_10), na.rm = TRUE), # PNC
         meanDBP_PNC6 = mean(c(M06_BP_DIA_VSORRES_1_10, M06_BP_DIA_VSORRES_2_10, M06_BP_DIA_VSORRES_3_10), na.rm = TRUE), # PNC
         
         meanSBP_PNC26 = mean(c(M06_BP_SYS_VSORRES_1_11, M06_BP_SYS_VSORRES_2_11, M06_BP_SYS_VSORRES_3_11), na.rm = TRUE), # PNC
         meanDBP_PNC26 = mean(c(M06_BP_DIA_VSORRES_1_11, M06_BP_DIA_VSORRES_2_11, M06_BP_DIA_VSORRES_3_11), na.rm = TRUE), # PNC
         
         meanSBP_PNC52 = mean(c(M06_BP_SYS_VSORRES_1_12, M06_BP_SYS_VSORRES_2_12, M06_BP_SYS_VSORRES_3_12), na.rm = TRUE), # PNC
         meanDBP_PNC52 = mean(c(M06_BP_DIA_VSORRES_1_12, M06_BP_DIA_VSORRES_2_12, M06_BP_DIA_VSORRES_3_12), na.rm = TRUE), # PNC
         
         meanSBP_Hosp_PNC = M19_BP_SYS_VSORRES_14, # ANC HOSPITALIZATION
         meanDBP_Hosp_PNC = M19_BP_DIA_VSORRES_14) # ANC HOSPITALIZATION

#TODO EMILY WILL LET ME KNOW IF BP NON CONSEQUATIVE OK?  - MAY HAVE TO TAKE INTO ACCOUNT UNSCHEDULED VISITS. 
merged_df <- merged_df %>% 
  mutate(GEST_HYPER_MEAS = case_when(CHRON_HYPER==0 & ((((meanSBP_ANC20 >=140 | meanDBP_ANC20 >=90) &
                                         (meanSBP_ANC28 >=140 | meanDBP_ANC28 >=90 )) | 
                                        ((meanSBP_ANC28 >=140 | meanDBP_ANC28 >=90) &
                                           (meanSBP_ANC32 >=140 | meanDBP_ANC32 >=90)) |
                                        ((meanSBP_ANC32 >=140 | meanDBP_ANC32 >=90) &
                                           (meanSBP_ANC36 >=140 | meanDBP_ANC36 >=90)) |
                                        ((meanSBP_ANC36 >=140 | meanDBP_ANC36 >=90) &
                                           (meanSBP_IPC >=140 | meanDBP_IPC >=90)) |
                                          (meanSBP_IPC >=140 | meanDBP_IPC >=90)| # just once at delivery is ok - don't need a subsequent visit or combined with previous.
                                        (meanSBP_Hosp_ANC >=140 | meanDBP_Hosp_ANC >=90))) ~ 1, 
                                     TRUE  ~ as.numeric(0)))

table(GEST_HYPER_MEAS = merged_df$GEST_HYPER_MEAS, SITE=merged_df$SITE, useNA = "always")
round(prop.table(table(GEST_HYPER_MEAS = merged_df$GEST_HYPER_MEAS, SITE=merged_df$SITE, useNA = "always"),margin=2)*100,2)

merged_df <- merged_df %>% 
  mutate(SEVERE_GEST_HYPER = case_when(CHRON_HYPER==0 &((meanSBP_ANC20 >=160 | meanDBP_ANC20 >=110 |
                                     meanSBP_ANC28 >=160 | meanDBP_ANC28 >=110 |
                                     meanSBP_ANC32 >=160 | meanDBP_ANC32 >=110 |
                                     meanSBP_ANC36 >=160 | meanDBP_ANC36 >=110 |
                                     meanSBP_IPC >=160 | meanDBP_IPC >=110 |
                                     meanSBP_Hosp_ANC >=160 | meanDBP_Hosp_ANC >=110)) ~ 1, 
                                     TRUE  ~ as.numeric(0)))
table(SEVERE_GEST_HYPER = merged_df$SEVERE_GEST_HYPER, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(SEVERE_GEST_HYPER = merged_df$SEVERE_GEST_HYPER, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- merged_df %>% select(MOMID, PREGID, GEST_HYPER_MEAS, starts_with("M04_HTN_CMTRT_"))

# M04_HTN_CMTRT_3==1 | M04_HTN_CMTRT_4==1 | M04_HTN_CMTRT_4==1 | M04_HTN_CMTRT_5==1 |
#   M04_HTN_CMTRT_6 ==1 | M04_HTN_CMTRT_7 ==1 | M04_HTN_CMTRT_8 == 1 | M04_HTN_CMTRT_9 ==1 | 
#   M04_HTN_CMTRT_9)
```

***POSTPARTUM HYPERTENSION - HYPER_PNC***
"Systolic blood pressure >140 mm Hg on two occasions at least 1 hour apart or diastolic blood pressure >90 mm Hg on two occasions at least 1 hour apart 
Suggested change: Systolic blood pressure >140 mm Hg OR diastolic blood pressure >90 mm Hg after delivery."
```{r}
#####################################################################
#TODO
# NOTES:
# - Need to account for any two high measurements - not nec. conseq).
# - SHOULD THIS BE ASSESSED ALL THE WAY OUT TO 1 YEAR POST DELIVERY?
# DUSCUSSION 09/21/2023: create these categories: 6week, 6month, 12 month 
#####################################################################

merged_df <- merged_df %>% 
  mutate(HYPER_PNC_MEAS = case_when(CHRON_HYPER==0 & (((!is.na(meanSBP_PNC0) & meanSBP_PNC0 >=140) | (!is.na(meanDBP_PNC0) & meanDBP_PNC0 >=90) |
                                     (!is.na(meanSBP_PNC1) & meanSBP_PNC1 >=140) | (!is.na(meanDBP_PNC1) & meanDBP_PNC1 >=90) |
                                     (!is.na(meanSBP_PNC4) & meanSBP_PNC4 >=140) | (!is.na(meanDBP_PNC4) & meanDBP_PNC4 >=90) |
                                     (!is.na(meanSBP_PNC6) & meanSBP_PNC6 >=140) | (!is.na(meanDBP_PNC6) & meanDBP_PNC6 >=90) |
                                     (!is.na(meanSBP_PNC26) & meanSBP_PNC26 >=140) | (!is.na(meanDBP_PNC26) & meanDBP_PNC26 >=90) |
                                  (!is.na(meanSBP_PNC52) & meanSBP_PNC52 >=140) | (!is.na(meanDBP_PNC52) & meanDBP_PNC52 >=90) |
                                     (!is.na(meanSBP_Hosp_PNC) & meanSBP_Hosp_PNC >=140) | (!is.na(meanDBP_Hosp_PNC) & meanDBP_Hosp_PNC >=90))) ~ 1, 
                                     TRUE  ~ as.numeric(0)))

table(HYPER_PNC_MEAS = merged_df$HYPER_PNC_MEAS, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(HYPER_PNC_MEAS = merged_df$HYPER_PNC_MEAS, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

***SECONDARY: GESTATIONAL HYPERTENSION - GEST_HYPER_DIAG***
Gestational hypertension (diagnosed)

```{r}
#####################################################################################################################################
#TODO 
# NOTES: 
# = I INCLUDED MEDICATION USE IN DIAGNOSIS - IS THIS CORRECT? 
# - SHOULD THIS INCLUDE SEVERE GESTATIONAH HYPERTENSION DIAGNOSED? - GOOGLE SHEETS VARS DON'T INCLUDE THIS IN PLAIN gHTN DIAGNOSED #
# - DURING THE ANC PERIOD FOR DIAGNOSED gHTN THERE IS NO QUESTION ON SEVERE gHTN.
####################################################################################################################################

merged_df <- merged_df %>% 
  mutate(GEST_HYPER_DIAG = case_when(M04_HPD_MHOCCUR_1=1 & M04_HPD_MHTERM_1==3 ~ 0, # WHEN HDP ==1 (INCL. CHRONIC HTN) AND HPD_MHTERM==3 WHICH IS CHRONIC HTN
                                     (M04_HPD_MHOCCUR_2==1 & M04_HPD_MHTERM_2==1) | 
                                       (M04_HPD_MHOCCUR_3==1 & M04_HPD_MHTERM_3==1) | 
                                       (M04_HPD_MHOCCUR_4==1 & M04_HPD_MHTERM_4==1) | 
                                       (M04_HPD_MHOCCUR_5==1 & M04_HPD_MHTERM_5==1) ~ 1,
                                     M09_HDP_HTN_MHOCCUR_1_6==1 ~ 0, # WHEN MOTHER IS DIAGNOSED WITH cHTN 0.
                                     M09_HDP_HTN_MHOCCUR_3_6==1 & M09_PREECLAMPSIA_CEOCCUR_3_6==1 ~ 1, # WHEN MOTHER IS DIAGNOSED WITH PE AND HAS SEVERE gHTN.
                                     M09_HDP_HTN_MHOCCUR_2_6==1 ~ 1, # IF MOTHER DIAGNOSED WITH HDP THAT IS gHTN THEN 1. 
                                     (M09_HDP_HTN_PROCCUR_3_6==1 | M09_HDP_HTN_PROCCUR_4_6==1 | M09_HDP_HTN_PROCCUR_5_6==1 |
                                       M09_HDP_HTN_PROCCUR_6_6==1 | M09_HDP_HTN_PROCCUR_7_6==1 | M09_HDP_HTN_PROCCUR_8_6==1 | 
                                       M09_HDP_HTN_PROCCUR_9_6==1) ~ 1,
                                     M19_HDP_HTN_MHOCCUR_1_13==1 ~ 0, # cHTN DURING HOSPITALIZATION THEN 0.
                                     M19_HDP_HTN_MHOCCUR_2_13==1 ~ 1, # gHTN DURING HOSPITALIZATION THEN 1.  
                                     (M19_HDP_HTN_MHOCCUR_3_13==1 & M19_PREECLAMPSIA_CEOCCUR_3_13==1) ~ 1, 
                                     TRUE ~ as.numeric(0))) 

table(GEST_HYPER_DIAG = merged_df$GEST_HYPER_DIAG, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(GEST_HYPER_DIAG = merged_df$GEST_HYPER_DIAG, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

***SEVERE GESTATIONAL HYPERTENSION - DIAGNOSED***
```{r}
merged_df <- merged_df %>% 
  mutate(SEVERE_GEST_HYPER_REP = case_when(M09_HDP_HTN_MHOCCUR_3_6==1 & M09_PREECLAMPSIA_CEOCCUR_3_6==1 ~ 1,
                                           M19_HDP_HTN_MHOCCUR_3_13==1 & M19_PREECLAMPSIA_CEOCCUR_3_13==1 ~ 1,
                                           TRUE ~ as.numeric(0)))
table(SEVERE_GEST_HYPER_REP = merged_df$SEVERE_GEST_HYPER_REP, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(SEVERE_GEST_HYPER_REP = merged_df$SEVERE_GEST_HYPER_REP, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

***GESTATIONAL PROTEINURIA - PROTEINURIA***
24 hour urine collection >300 mg protein OR single voided urine protein/creatinine ratio ≥0.3 OR Dipstick of 1+ or 2+.
Measured ANC20,28,32,36
IPC
PNC0,1,4,6
Hospitalizations.
```{r echo=FALSE}
merged_df <- merged_df %>% 
  mutate(PROTEINURIA = ifelse((!is.na(M08_UA_PROT_LBORRES_2) & (M08_UA_PROT_LBORRES_2 == 2 | M08_UA_PROT_LBORRES_2==3)) | 
                                (!is.na(M08_UA_PROT_LBORRES_3) & (M08_UA_PROT_LBORRES_3 == 2 | M08_UA_PROT_LBORRES_3==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_4) & (M08_UA_PROT_LBORRES_4 == 2 | M08_UA_PROT_LBORRES_4==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_5) & (M08_UA_PROT_LBORRES_5 == 2 | M08_UA_PROT_LBORRES_5==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_6) & (M08_UA_PROT_LBORRES_6 == 2 | M08_UA_PROT_LBORRES_6==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_7) & (M08_UA_PROT_LBORRES_7 == 2 | M08_UA_PROT_LBORRES_7==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_8) & (M08_UA_PROT_LBORRES_8 == 2 | M08_UA_PROT_LBORRES_8==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_9) & (M08_UA_PROT_LBORRES_9 == 2 | M08_UA_PROT_LBORRES_9==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_10) & (M08_UA_PROT_LBORRES_10 == 2 | M08_UA_PROT_LBORRES_10==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_13) & (M08_UA_PROT_LBORRES_13 == 2 | M08_UA_PROT_LBORRES_13==3)) |
                                (!is.na(M08_UA_PROT_LBORRES_14) & (M08_UA_PROT_LBORRES_14 == 2 | M08_UA_PROT_LBORRES_14==3)), 1, 0))

temp.df <- merged_df %>% 
  select(MOMID, PREGID, PROTEINURIA, M08_UA_PROT_LBORRES_2, M08_UA_PROT_LBORRES_3,M08_UA_PROT_LBORRES_4,M08_UA_PROT_LBORRES_5,M08_UA_PROT_LBORRES_6,
         M08_UA_PROT_LBORRES_7,M08_UA_PROT_LBORRES_8,M08_UA_PROT_LBORRES_9, M08_UA_PROT_LBORRES_10, M08_UA_PROT_LBORRES_13, M08_UA_PROT_LBORRES_14)

table(PROTEINURIA = merged_df$PROTEINURIA)
```

***ORGAN DYSFUNCTION - MAT_DYS***
Cardiovascular, respiratory, renal, coagulation/hematological, hepatic, neurological, and/or uterine dysfunction that occurred during pregnancy, childbirth or within 42 days of termination of pregnancy.
```{r echo=FALSE}
##################################################################################
#TODO 
# NOTES: 
# - THIS IS LOOKING AT L&D AND HOSPITALIZATION. 
# - THIS VAR WILL FEED INTO SEPSIS. #

##################################################################################
merged_df <- merged_df %>% 
  mutate(MAT_DYS = case_when(((M09_ORG_FAIL_MHOCCUR_1_6 ==1 | 
                                M09_ORG_FAIL_MHOCCUR_2_6==1 |
                                M09_ORG_FAIL_MHOCCUR_3_6==1 | 
                                M09_ORG_FAIL_MHOCCUR_4_6==1 |
                                M09_ORG_FAIL_MHOCCUR_5_6==1 | 
                                M09_ORG_FAIL_MHOCCUR_6_6==1 | 
                                M09_ORG_FAIL_MHOCCUR_7_6==1 | 
                                M19_ORGAN_FAIL_MHTERM_1_13==1 | 
                                M19_ORGAN_FAIL_MHTERM_2_13==1 | 
                                M19_ORGAN_FAIL_MHTERM_3_13==1 | 
                                M19_ORGAN_FAIL_MHTERM_4_13==1 |
                                M19_ORGAN_FAIL_MHTERM_5_13==1 | 
                                M19_ORGAN_FAIL_MHTERM_6_13==1 | 
                                M19_ORGAN_FAIL_MHTERM_7_13==1) & (M09_ORG_FAIL_SRCE_1_6==2 | M09_ORG_FAIL_SRCE_1_6==3)) ~1,
                             TRUE ~ as.numeric(0)))
# table(MAT_DYS = merged_df$MAT_DYS)

table(MAT_DYS = merged_df$MAT_DYS, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_DYS = merged_df$MAT_DYS, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)
```


***SECONDARY: HELLP = MAT_HELLP***
MNH08	AST_ul_LBORRES
Constructed	MAT_ANEMIA_ANY
MNH08	TBILIRUBIN_LBORRES
MNH08	DBILIRUBIN_LBORRES
MNH08	ALP_LBORRES
MNH08	GAMMAGT_LBORRES
MNH08	CBC_PLATE_LBORRES

Severe gestational hypertension (systolic >160 mmHg OR a diastolic >110 mmHg on two occasions at least 1 minute apart >20 weeks gestation or one occasion at delivery)
Hepatic abnormality (serum transaminase concentration AST or ALT ≥2 times the upper limit of the normal range)
Thrombocytopenia (<100,000 platelets/microL)
Hemolysis (serum bilirubin ≥1.2 mg/dL (20.52 umol/L) and hemoglobin <7 g/dL)
Rental insufficiency (serum creatinine >1.1 mg/dL)


```{r}
##################################################################################
#TODO 
# NOTES: 
# - WHAT IS THE UPPER LIMIT OF NORMAL RANGE FOR AST OR ALT - NEED TO LOOK UP.
# - WHERE IS THE ALT VARIABLE? 

##################################################################################
temp.df <- merged_df %>% 
  select(M08_AST_ul_LBORRES_1)
```

***SEVERE FEATURES OF PREECLAMPSIA - MAT_PRE_SEV_MEAS***

SEVERE_GEST_HYPER	Severe gestational hypertension
MAT_DYS	Organ dysfunction
MAT_HELLP	HELLP (measured)
AST_ul_LBORRES	Provide AST/SGOT test results:  Units/L
CBC_PLATE_LBORRES	Provide results: Platelets count:  x10³/mm³
CREAT_umoll_LBORRES	Provide Serum creatinine test results:  µmol/L
OTHR_CEOCCUR_10	Did mother have any other signs/symptoms of illness? Upper abdomen pain
ORG_FAIL_MHOCCUR_5	Did mother experience any type of organ failure? Neurological dysfunction
HEADACHE_CEOCCUR	Severe headache?
PREECLAMPSIA_CEOCCUR_4	If mother was diagnosed with preeclampsia, were there any of the following severe features? Pulmonary edema
PREECLAMPSIA_CEOCCUR_1	If mother was diagnosed with preeclampsia, were there any of the following severe features? Eclampsia or seizures
EPIGASTR_PAIN_CEOCCUR	Did the mother have any of the following signs of complication after delivery? Epigastric pain
HEADACHE_CEOCCUR	Did the mother have any of the following signs of complication after delivery? Severe headaches
FAINT_CEOCCUR	Did the mother have any of the following signs of complication after delivery? Feeling faint of dizzy
EPIGASTR_CEOCCUR	Epigastric or right upper quadrant pain?
Headache_CEOCCUR	Severe headache?
FAINT_CEOCCUR	Feeling faint or dizzy?
PULM_EDEMA_MHOCCUR	Was mother diagnosed with pulmonary edema?
RUQ_PAIN_CEOCCUR	"Were any of the following signs or symptoms of illness or pregnancy complication noted while hospitalized?
Right upper quadrant pain"
EPIGASTR_PAIN_CEOCCUR	"Were any of the following signs or symptoms of illness or pregnancy complication noted while hospitalized?
Epigastric pain (pain/discomfort in upper abdomen directly below ribs) "
ORGAN_FAIL_MHTERM_5	"Specify type of organ failure noted in the clinical record 
 Neurological dysfunction"
HEADACHE_CEOCCUR	"Were any of the following signs or symptoms of illness or pregnancy complication noted while hospitalized?
Severe headaches"
FAINT_CEOCCUR	"Were any of the following signs or symptoms of illness or pregnancy complication noted while hospitalized?
Feeling faint or dizzy"
CREAT_LBORRESU	serum creatinine result µmol/L
PREECLAMPSIA_CEOCCUR_4	"If mother was diagnosed with preeclampsia, were there any of the following severe features?
 Pulmonary edema"
PREECLAMPSIA_CEOCCUR_1	"If mother was diagnosed with preeclampsia, were there any of the following severe features?
 Eclampsia or seizures"
 
```{r echo=FALSE}
temp.df <- merged_df %>% 
  select(M08_CBC_LBPERF_1_1, M08_CBC_HB_LBORRES_1)
```

***PREECLAMPSIA - PRE_MEAS***
"- For those without preexisting hypertension: defined as gestational hypertension AND gestational proteinuria, OR clinical diagnosis of preeclampsia OR development of severe features (even in the absence of proteinuria). 
- For those with preexisting hypertension: defined by incident gestational proteinuria OR clinical diagnosis of preeclampsia OR development of severe features. 

Suggested change: 
- For those without preexisting hypertension: defined as gestational hypertension AND gestational proteinuria OR development of severe features (even in the absence of proteinuria). 
- For those with preexisting hypertension: defined by incident gestational proteinuria OR development of severe features."

***PREECLAMPSIA - PRE_DIAG***
***PREECLAMPSIA - PRE_ANY***
```{r echo=FALSE}

```


***PREECLAMPSIA (DIAGNOSED) - SECONDARY OUTCOME: PRE_DIAG***
LnD:
MNH09	HDP_HTN_MHOCCUR_3	Was mother diagnosed with any of the following hypertensive disorders of pregnancy (HDP)? Preeclampsia

Hospitalization:
MNH19	HDP_HTN_MHOCCUR_3	(If antenatal period) Was mother diagnosed with any of the following hypertensive disorders of pregnancy (HDP) while hospitalized? Preeclampsia
```{r}
temp.df <- merged_df %>% select(MOMID, PREGID, #,SITE
                                    M09_HDP_HTN_MHOCCUR_3_6, M19_HDP_HTN_MHOCCUR_3_13)

merged_df <- merged_df %>%
  mutate(PRE_DIAG = if_else(!is.na(M09_HDP_HTN_MHOCCUR_3_6) & M09_HDP_HTN_MHOCCUR_3_6==1, 1, 0))

table(PRE_DIAG = merged_df$PRE_DIAG, useNA = "always")
```


***GESTATIONAL DIABETES - SECONDARY OUTCOME: GEST_DIAB***

Look at: 
- MNH04 ANC28, 32, 36
- MNH06 ANC 28
- MNH08 <20, 28
- MNH09 L&D/IPC: M09_GEST_DIAB_MHOCCUR_6
- MNH19 Hospitalization visit

```{r echo=FALSE}
##################################################################################
#TODO 
# NOTES: 
# 1. NEED TO ADD ADDITIONAL CONDITIONS FOR DIAGNOSED # 
# 2. ALL OF MEASURED variables are NA - FASTING OGTT, HbA1c# 

##################################################################################

# This is DIAGNOSED at enrollment, ANC28, 32, 36 through MNH04.
temp.df <- merged_df %>% select(M04_DIABETES_EVER_MHOCCUR_2, 
                                    M04_DIABETES_EVER_MHOCCUR_3, M04_DIABETES_EVER_MHOCCUR_4,
                                    M09_GEST_DIAB_MHOCCUR_6, M09_INDUCED_PROCCUR_6,
                                    M19_PRIMARY_MHTERM_13, M19_LD_COMPL_MHTERM_3_13)

temp.df <- merged_df %>% select(MOMID, PREGID, SITE, M06_BGLUC_POC_MMOLL_LBORRES_2, 
                                    M08_BGLUC_PRETEST_MMOLL_LBORRES_1, M08_BGLUC_PRETEST_MMOLL_LBORRES_2, M08_BGLUC_PRETEST_MMOLL_LBORRES_3,
                                    M08_HBA1C_LBORRES_1)
tapply(merged_df$M08_HBA1C_LBORRES_1, merged_df$SITE, summary)
# %>% group_by(SITE) %>% summary(M08_HBA1C_LBORRES_1)
merged_df <- merged_df %>% 
  mutate(GEST_DIAB_DIAG = ifelse( !is.na(M04_DIABETES_EVER_MHOCCUR_2==1) & M04_DIABETES_EVER_MHOCCUR_2==1 |
                                  !is.na(M04_DIABETES_EVER_MHOCCUR_3==1) & M04_DIABETES_EVER_MHOCCUR_3==1 | 
                                  !is.na(M04_DIABETES_EVER_MHOCCUR_4) & M04_DIABETES_EVER_MHOCCUR_4==1, 1, 0)) %>%
  
  mutate(GEST_DIAB_MEAS = ifelse((!is.na(M08_HBA1C_LBORRES_1) & M08_HBA1C_LBORRES_1>=6.5) | # confirm HbA1C at enrollment is high
                                   (!is.na(M06_BGLUC_POC_MMOLL_LBORRES_2) & M06_BGLUC_POC_MMOLL_LBORRES_2>5.1) & # At ANC28, POC diagnostics in fasting is >5.1
                                      (!is.na(M08_BGLUC_PRETEST_MMOLL_LBORRES_1) & M08_BGLUC_PRETEST_MMOLL_LBORRES_1>5.1) & # confirm pre test (fasting) OGTT is high
                                       ((!is.na(M08_BGLUC_PRETEST_MMOLL_LBORRES_2) & M08_BGLUC_PRETEST_MMOLL_LBORRES_2>=10.0) | # when fasting OGTT is high, then 1-hr or 2-hr should be also high 
                                         (!is.na(M08_BGLUC_PRETEST_MMOLL_LBORRES_3) & M08_BGLUC_PRETEST_MMOLL_LBORRES_3 >=8.5)),
                                 1, 0))

table(GEST_DIAB_DIAG = merged_df$GEST_DIAB_DIAG, SITE = merged_df$SITE, useNA = "always")
table(GEST_DIAB_MEAS = merged_df$GEST_DIAB_MEAS, SITE = merged_df$SITE, useNA = "always")

```

***ANTEPARTUM HEMORRHAGE = MAT_APH*** 
Bleeding from or into the genital tract, occurring from ≥24 weeks gestation and prior to delivery.
ANC TP: 28, 32, 36
ANC Hospitalization
```{r echo=FALSE}
#################################################################################
#TODO 
# NOTES: 
# NEED to create HEMORRHAGE ANY.
# - LYNDA HAS N=7; FF HAS N=9.  
# LET LYNDA KNOW HER VARIABLE IS OFF
##################################################################################

temp.df <- merged_df %>% 
  select(MOMID, PREGID, M04_APH_CEOCCUR_3, M04_APH_CEOCCUR_4, M04_APH_CEOCCUR_5, M09_APH_CEOCCUR_6, M19_VAG_BLEED_CEOCCUR_13, M19_LD_COMPL_MHTERM_4_13) 

merged_df <- merged_df %>% 
  mutate(MAT_APH = ifelse(!is.na(M04_APH_CEOCCUR_3) & M04_APH_CEOCCUR_3==1 |
                            !is.na(M04_APH_CEOCCUR_4) & M04_APH_CEOCCUR_4==1 |
                            !is.na(M04_APH_CEOCCUR_5) & M04_APH_CEOCCUR_5==1 |
                            !is.na(M09_APH_CEOCCUR_6) & M09_APH_CEOCCUR_6==1 |
                            !is.na(M19_VAG_BLEED_CEOCCUR_13) & M19_VAG_BLEED_CEOCCUR_13==1 |
                            !is.na(M19_LD_COMPL_MHTERM_4_13) & M19_LD_COMPL_MHTERM_4_13==1, 1, 0))

table(MAT_APH = merged_df$MAT_APH, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_APH = merged_df$MAT_APH, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

***POSTPARTUM HEMORRHAGE = MAT_PPH***
Defined as estimated blood loss of 500 mL or more within 24 hours after birth OR clinician diagnosis of PPH.
LnD
PNC: 0 (TP 7)
Hospitalization

***LATE PPH***
Late PPH: Estimated blood loss of ≥500 mL from 24 hours after birth through 6 weeks postpartum.
PNC 1, 4, 6 (TP: 8-10)

***SEVERE POSTPARTUM HEMORRHAGE = MAT_PPH_SEV***
Abnormal bleeding (1000 ml or more) OR any bleeding with hypotension or blood transfusion, within 24 hours after birth.
- Will use vars that were used to create MAT_PPH plus BP vars or blood transfusion.
 
Hospitalization
```{r echo=FALSE}
#################################################################################
#TODO 
# NOTES: 
# NEED to create HEMORRHAGE ANY.
# -  M09_PPH_CEOCCUR_6 == 0 for many where M09_PPH_ESTIMATE_FAORRES_6 >=500 - #
# ----- for now, making this an OR statement then. # 
# 2. Should we look at ANC0 weeks for PPH within 24 hours or put that in late PPH? # 
# 3. Should M19_LD_COMPL_MHTERM_5_13 and M19_LD_COMPL_ML_13 be used for MAT_PPH or Late? #  
# - LYNNDA HAS N=5 FOR SEVERE HEMORRHAGE. 
# DO WE HAVE PNC0 TIME? THEN WE CAN'T PNC0. JUST BETTER TO USE IPC.  - SOME SITES MAY FILL MNH06 - POC BUT THIS OPTIONAL. 
##################################################################################

temp.df <- merged_df %>%
  select(M09_PPH_CEOCCUR_6, M09_PPH_ESTIMATE_FAORRES_6,
         M12_BIRTH_COMPL_MHTERM_1_7, M12_BIRTH_COMPL_MHTERM_1_8, M12_BIRTH_COMPL_MHTERM_1_9, 
         M12_BIRTH_COMPL_MHTERM_1_10,
         M12_VAG_BLEED_LOSS_ML_7, M12_VAG_BLEED_LOSS_ML_8, M12_VAG_BLEED_LOSS_ML_9, 
         M12_VAG_BLEED_LOSS_ML_10,
         M19_LD_COMPL_MHTERM_5_13, M19_LD_COMPL_ML_13,
         starts_with(c("M06_BP_SYS_VSORRES_", "M06_BP_DIA_VSORRES_")), # will just need TP 7,8,9,10 BP
         M09_PPH_TRNSFSN_PROCCUR_6, M19_TX_PROCCUR_1_13, M19_BP_LT90_SYS_VSORRES_13, M19_BP_LT90_DIA_VSORRES_13)

merged_df <- merged_df %>%
  mutate(MAT_PPH = ifelse(((!is.na(M09_PPH_CEOCCUR_6) & M09_PPH_CEOCCUR_6==1) | # looking for PPH at L&D
                             (!is.na(M09_PPH_ESTIMATE_FAORRES_6) & M09_PPH_ESTIMATE_FAORRES_6>=500) |
                             
                           #  !is.na(M12_BIRTH_COMPL_MHTERM_1_7) & M12_BIRTH_COMPL_MHTERM_1_7==1 & # looking for PPH at PNC week 0 
                            # !is.na(M12_VAG_BLEED_LOSS_ML_7) & M12_VAG_BLEED_LOSS_ML_7 >=500 |
                             
                             (!is.na(M19_LD_COMPL_MHTERM_5_13) & M19_LD_COMPL_MHTERM_5_13==1) & # looking for PPH at L&D at hospitalization 
                             !is.na(M19_LD_COMPL_ML_13) & M19_LD_COMPL_ML_13>=500), 1,0)) %>% 
  #***********# 
  #**LATE-PPH**
  #***********# 
  mutate(MAT_PPH_LATE = ifelse((!is.na(M12_BIRTH_COMPL_MHTERM_1_8) & M12_BIRTH_COMPL_MHTERM_1_8==1 &
                                  !is.na(M12_VAG_BLEED_LOSS_ML_8) & M12_VAG_BLEED_LOSS_ML_8 >=500 |
                                  
                                  !is.na(M12_BIRTH_COMPL_MHTERM_1_9) & M12_BIRTH_COMPL_MHTERM_1_9==1 &
                                  !is.na(M12_VAG_BLEED_LOSS_ML_9) & M12_VAG_BLEED_LOSS_ML_9 >=500 |
                                  
                                  !is.na(M12_BIRTH_COMPL_MHTERM_1_10) & M12_BIRTH_COMPL_MHTERM_1_10==1 &
                                  !is.na(M12_VAG_BLEED_LOSS_ML_10) & M12_VAG_BLEED_LOSS_ML_10 >=500), 1, 0)) %>% 
  
  #***********# 
  #**SEV-PPH**
  #***********# 
  
  rowwise() %>% 
  mutate(meanSBP_IPC = mean(c(M06_BP_SYS_VSORRES_1_6, M06_BP_SYS_VSORRES_2_6, M06_BP_SYS_VSORRES_3_6), na.rm = TRUE), # at L&D BP
         meanDBP_IPC = mean(c(M06_BP_DIA_VSORRES_1_6, M06_BP_DIA_VSORRES_2_6, M06_BP_DIA_VSORRES_3_6), na.rm = TRUE), 
         
         meanSBP_PNC0 = mean(c(M06_BP_SYS_VSORRES_1_7, M06_BP_SYS_VSORRES_2_7, M06_BP_SYS_VSORRES_3_7), na.rm = TRUE), # at PNC0 TP (within 24hr of birth?)
         meanDBP_PNC0 = mean(c(M06_BP_DIA_VSORRES_1_7, M06_BP_DIA_VSORRES_2_7, M06_BP_DIA_VSORRES_3_7), na.rm = TRUE)) %>%
  
  mutate(MAT_PPH_SEV = ifelse(((#!is.na(M09_PPH_CEOCCUR_6) & M09_PPH_CEOCCUR_6==1 | # looking for PPH at L&D
    !is.na(M09_PPH_ESTIMATE_FAORRES_6) & M09_PPH_ESTIMATE_FAORRES_6>=1000)  | # bleeding >=1000mL
      (!is.na(M09_PPH_ESTIMATE_FAORRES_6) & M09_PPH_ESTIMATE_FAORRES_6>0 & # any bleeding and hypotension
         (!is.na(meanSBP_IPC) & meanSBP_IPC <90 |
            !is.na(meanDBP_IPC) & meanDBP_IPC <60)) |

      
      (#!is.na(M19_LD_COMPL_MHTERM_5_13) & M19_LD_COMPL_MHTERM_5_13==1 & # looking for PPH at L&D at hospitalization 
        !is.na(M19_LD_COMPL_ML_13) & M19_LD_COMPL_ML_13>=1000)) | 
      (!is.na(M09_PPH_TRNSFSN_PROCCUR_6) & M09_PPH_TRNSFSN_PROCCUR_6==1), 1,0)) # did mother need a transfusion
      
      
# REMOVING HOSPITALIZATION TP ALSO HERE. 
      # !is.na(M19_TX_PROCCUR_1_13) & M19_TX_PROCCUR_1_13==1 | # did the mother receive transfusion while hosp.
      # !is.na(M19_BP_LT90_SYS_VSORRES_13) & M19_BP_LT90_SYS_VSORRES_13<90 | 
      # (!is.na(M19_BP_LT90_DIA_VSORRES_13) & M19_BP_LT90_DIA_VSORRES_13<60), 1,0)) #%>%
  
  # select(MAT_PPH_SEV, M09_PPH_ESTIMATE_FAORRES_6, meanSBP_IPC, meanDBP_IPC, 
  #        M12_VAG_BLEED_LOSS_ML_7, meanSBP_PNC0, meanDBP_PNC0,
  #        M19_LD_COMPL_ML_13, M09_PPH_TRNSFSN_PROCCUR_6, 
  #        M19_TX_PROCCUR_1_13, M19_BP_LT90_SYS_VSORRES_13, M19_BP_LT90_DIA_VSORRES_13)

table(MAT_PPH = merged_df$MAT_PPH, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_PPH = merged_df$MAT_PPH, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)


table(MAT_PPH_LATE = merged_df$MAT_PPH_LATE, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_PPH_LATE = merged_df$MAT_PPH_LATE, SITE = merged_df$SITE, useNA = "always"),margin=2)*100, 2)

table(MAT_PPH_SEV = merged_df$MAT_PPH_SEV, SITE = merged_df$SITE, useNA = "always") #TODO LYNDA HAS N=5
round(prop.table(table(MAT_PPH_SEV = merged_df$MAT_PPH_SEV, SITE = merged_df$SITE, useNA = "always"),margin=2)*100, 2)
                            
```


***PROLONGED LABOR - TERTIARY OUTCOME: PRO_LABOR***
Prolonged labor is defined as a first stage of labor lasting ≥20 hours for primipara and ≥14 hours for multipara.
```{r}
temp.df <- merged_df %>% select(MOMID, PREGID, M04_PH_PREV_RPORRES_1, M09_LABOR_MHSTDAT_6, M09_LABOR_MHSTTIM_6, M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTTIM_INF1_6)

merged_df <- merged_df %>% mutate(M09_LABOR_MHSTTIM_6 = 
                                ifelse(M09_LABOR_MHSTTIM_6=="99:99", as.character(NA), M09_LABOR_MHSTTIM_6),
                              M09_DELIV_DSSTTIM_INF1_6 = 
                                ifelse(M09_DELIV_DSSTTIM_INF1_6=="99:99", as.character(NA), M09_DELIV_DSSTTIM_INF1_6))
  
merged_df <- merged_df %>% 
  mutate(LABOR_DATE_TIME = paste(M09_LABOR_MHSTDAT_6, "", M09_LABOR_MHSTTIM_6),
         DELIV_DATE_TIME = paste(M09_DELIV_DSSTDAT_INF1_6, "", M09_DELIV_DSSTTIM_INF1_6))

merged_df$LABOR_DATE_TIME <- format(as.POSIXct(merged_df$LABOR_DATE_TIME, format="%Y-%m-%d %H:%M"))

merged_df$DELIV_DATE_TIME <- format(as.POSIXct(merged_df$DELIV_DATE_TIME, format="%Y-%m-%d %H:%M"))

merged_df <- merged_df %>% 
  mutate(LABOR_DELIVERY_INTERVAL = difftime(DELIV_DATE_TIME, LABOR_DATE_TIME, units = "hours"))

merged_df <- merged_df %>% 
  mutate(PRO_LABOR = case_when((M04_PH_PREV_RPORRES_1==1 & LABOR_DELIVERY_INTERVAL>=20) | # WHEN PRIMIPAROUS
                                 (M04_PH_PREV_RPORRES_1==0 & LABOR_DELIVERY_INTERVAL>=14) ~ 1,# WHEN MULTIPAROUS
                               TRUE ~ as.numeric(0)))

table(PRO_LABOR = merged_df$PRO_LABOR, useNA = "always")
```


***TERTIARY: UNPLANNED SURGERY - UN_SURGERY***
The occurrence of medically-indicated or emergent surgical procedure during labor and delivery. Includes: (1) Hysterectomy, defined as the removal of the uterus (i.e. partial) or of the uterus and the cervix (i.e. total hysterectomy). (2) Cesarean section, defined as a surgical procedure used to deliver a baby through incisions in the abdomen and uterus.

MNH09	PPH_FAORRES_5	Were any of the following procedures carried out for PPH: Hysterectomy
MNH09	CES_PROCCUR_INF1	Was Cesarean delivery emergent or planned?
MNH19	TX_PROCCUR_5	Did the mother receive any of the following interventions while hospitalized at this location? Hysterectomy

```{r}
#################################################################################
#TODO 
# NOTES: 
# - DO WE NEED PPH_FAORRES_5 = HYSTERECTOMY FOR PPH in MNH09. 

##################################################################################

temp.df <- merged_df %>% 
  select(M09_PPH_FAORRES_5_6, M09_DELIV_PRROUTE_INF1_6, M09_DELIV_PRROUTE_INF2_6, M09_DELIV_PRROUTE_INF3_6, M09_DELIV_PRROUTE_INF4_6, M09_CES_PROCCUR_INF1_6, M19_TX_PROCCUR_2_13, M19_TX_PROCCUR_5_13) %>% 
  mutate(UN_SURGERY = case_when(M09_PPH_FAORRES_5_6==1 |
                               (M09_DELIV_PRROUTE_INF1_6==2 | M09_DELIV_PRROUTE_INF2_6==2 | 
                                  M09_DELIV_PRROUTE_INF3_6==2 | M09_DELIV_PRROUTE_INF4_6==2 & 
                                  M09_CES_PROCCUR_INF1_6==1) |
                               M19_TX_PROCCUR_2_13==1 | M19_TX_PROCCUR_5_13==1 ~ 1, 
                               TRUE ~ as.numeric(0)))
table(UN_SURGERY = temp.df$UN_SURGERY)

```

# SECONDARY: MATERNAL INFECTION AND SEPSIS (PREGNANCY) - ANC VISITS

Any infection and/or organ dysfunction resulting from infection during pregnancy.
Maternal infection: Any infection during pregnancy, delivery, and up to 42 days postpartum.
Maternal sepsis: Organ dysfunction resulting from infection during pregnancy, delivery, and up to 42 days postpartum.
***MAT_INFECT_DIAG_ANC*** = just infection
***MAT_SEPSIS_DIAG_ANC*** = infection and organ dysfunction. 
```{r}
#################################################################################
#TODO 
# NOTES: 
# - DO WE NEED TO ADD MEDICATIONS SPECIFIC TO INFECTIONS UNDER DIAGNOSED MAT_INFECT? 
# - DO WE KEEP THE SAME MAT_DYS (ORGAN DYSFUCTION) FOR DIAGNOSED AND FOR MEASURED? 
# = DIAGNOSED DURING ANC USING M04 - I ADDED COVID-19.
# DISCUSSION: 09/21/2023
# - Include “Other” and don’t include “Don’t know”
# At LnD often a lot of medication is given so for LnD exclude 'Prophylaxis' indication
# ----But for all the other timepoints, it doesn't matter what the indication is, just say INFECTION = YES if they are taking medication.
####BUT ERS said: remove prophylaxis from all TPs (ANC, IPC and PNC) but keep "others" and "don't know"
##################################################################################

######## MATERNAL INFECTION DURING ANC WITHOUT HOSPITALIZATION DURING ANC 
merged_df <- merged_df %>% 
  mutate(MAT_INFECT_DIAG_ANC_WO_HOSP = case_when(M04_HIV_CMOCCUR_1==1 | M04_HIV_CMOCCUR_2==1 | M04_HIV_CMOCCUR_3==1 | 
                                           M04_HIV_CMOCCUR_4==1 | M04_HIV_CMOCCUR_5==1 |
                                           M04_SYPH_MHOCCUR_1==1 | M04_SYPH_MHOCCUR_2==1 | M04_SYPH_MHOCCUR_3==1 | 
                                           M04_SYPH_MHOCCUR_4==1 | M04_SYPH_MHOCCUR_4==1 | 
                                           M04_OTHR_STI_MHOCCUR_1==1 | M04_OTHR_STI_MHOCCUR_2==1 | M04_OTHR_STI_MHOCCUR_3==1 | 
                                           M04_OTHR_STI_MHOCCUR_4==1 | M04_OTHR_STI_MHOCCUR_5==1 | 
                                           M04_GONORRHEA_MHOCCUR_1==1 | M04_GONORRHEA_MHOCCUR_2==1 | M04_GONORRHEA_MHOCCUR_3==1 |
                                           M04_GONORRHEA_MHOCCUR_4==1 | M04_GONORRHEA_MHOCCUR_5==1 | 
                                           M04_CHLAMYDIA_MHOCCUR_1==1 | M04_CHLAMYDIA_MHOCCUR_2==1 | M04_CHLAMYDIA_MHOCCUR_3==1 |
                                           M04_CHLAMYDIA_MHOCCUR_4==1 | M04_CHLAMYDIA_MHOCCUR_5==1 | 
                                           M04_CHANC_MHOCCUR_1==1 | M04_CHANC_MHOCCUR_2==1 | M04_CHANC_MHOCCUR_3==1 | 
                                           M04_CHANC_MHOCCUR_4==1 | M04_CHANC_MHOCCUR_5==1 | 
                                           M04_GENULCER_MHOCCUR_1==1 | M04_GENULCER_MHOCCUR_2==1 | M04_GENULCER_MHOCCUR_3==1 | 
                                           M04_GENULCER_MHOCCUR_4==1 | M04_GENULCER_MHOCCUR_5==1 |
                                           M04_STI_OTHR_MHOCCUR_1==1 | M04_STI_OTHR_MHOCCUR_2==1 | M04_STI_OTHR_MHOCCUR_3==1 |
                                           M04_STI_OTHR_MHOCCUR_4==1 | M04_STI_OTHR_MHOCCUR_5==1 |
                                           M04_MALARIA_EVER_MHOCCUR_1==1 | M04_MALARIA_EVER_MHOCCUR_2==1 | M04_MALARIA_EVER_MHOCCUR_3==1 |
                                           M04_MALARIA_EVER_MHOCCUR_4==1 | M04_MALARIA_EVER_MHOCCUR_5==1 |
                                           M04_TB_MHOCCUR_1==1 | M04_TB_MHOCCUR_2==1 | M04_TB_MHOCCUR_3==1 | 
                                           M04_TB_MHOCCUR_4==1 | M04_TB_MHOCCUR_5==1 | 
                                           M04_COVID_LBORRES_1==1 | M04_COVID_LBORRES_2==1 | M04_COVID_LBORRES_3==1 | 
                                           M04_COVID_LBORRES_4==1 | M04_COVID_LBORRES_5==1 ~ 1, 
                                         TRUE ~ as.numeric(0)))

table(MAT_INFECT_DIAG_ANC_WO_HOSP = merged_df$MAT_INFECT_DIAG_ANC_WO_HOSP, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_DIAG_ANC_WO_HOSP = merged_df$MAT_INFECT_DIAG_ANC_WO_HOSP, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)

################# ANC HOSPITALIZATION _13.
merged_df <- merged_df %>%
  mutate(MAT_INFECT_DIAG_HOSP_ANC = case_when(M19_PRIMARY_MHTERM_13==2 | # 2= INFECTION; 5= ORGAN FAILURE
                                               (1 %in% c(M19_INFECTION_MHTERM_1_13, M19_INFECTION_MHTERM_2_13, M19_INFECTION_MHTERM_3_13, 
                                                         M19_INFECTION_MHTERM_4_13, M19_INFECTION_MHTERM_5_13, M19_INFECTION_MHTERM_6_13, 
                                                         M19_INFECTION_MHTERM_7_13, M19_INFECTION_MHTERM_8_13, M19_INFECTION_MHTERM_9_13, 
                                                         M19_INFECTION_MHTERM_10_13, M19_INFECTION_MHTERM_11_13, # NOT INCLUDING 12 B/C IT IS MATERNAL SEPSIS 
                                                         M19_INFECTION_MHTERM_13_13, M19_INFECTION_MHTERM_14_13, M19_INFECTION_MHTERM_15_13, 
                                                         M19_INFECTION_MHTERM_16_13,
                                                         M19_INFECTION_MHTERM_17_13, M19_INFECTION_MHTERM_18_13, M19_INFECTION_MHTERM_19_13, 
                                                         M19_INFECTION_MHTERM_88_13)) ~ 1, 
         TRUE ~ as.numeric(0))) 

table(MAT_INFECT_DIAG_HOSP_ANC=merged_df$MAT_INFECT_DIAG_HOSP_ANC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_DIAG_HOSP_ANC = merged_df$MAT_INFECT_DIAG_HOSP_ANC, 
                       SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)

```

# MATERNAL INFECTION VARIABLE - DIAGNOSED AT ANC (FINAL)
```{R}
###############################################################################################################
###############################################################################################################
############ MATERNAL INFECTION ANC + ANC HOSPITALIZATION _13. ###############################
merged_df <- merged_df %>%
  mutate(MAT_INFECT_DIAG_ANC = case_when(1 %in% c(MAT_INFECT_DIAG_ANC_WO_HOSP, MAT_INFECT_DIAG_HOSP_ANC) ~ 1, 
         TRUE ~ as.numeric(0)))

table(MAT_INFECT_DIAG_ANC = merged_df$MAT_INFECT_DIAG_ANCP, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_DIAG_ANC = merged_df$MAT_INFECT_DIAG_ANC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)

```

MATERNAL INFECTION AT DIAGNOSIS THORUGH MEDICATION USE
```{r}
#############################################
# MATERNAL INFECTION THROUGH MEDICATION USE #
# TREATMENT TROUGH ANC VISITS 1-5.
#############################################
merged_df <- merged_df %>%
  mutate(MAT_SYPH_INFECT_TREAT_ANC = case_when(M04_SYPH_CMTRT_1_1==1 | M04_SYPH_CMTRT_1_2==1 | M04_SYPH_CMTRT_1_3==1 |
                                            M04_SYPH_CMTRT_1_4==1 | M04_SYPH_CMTRT_1_5==1 | M04_SYPH_CMTRT_1_13==1 | # _13 ARE UNSCHEDULED ANC VISITS.
                                            M04_SYPH_CMTRT_2_1==1 | M04_SYPH_CMTRT_2_2==1 | M04_SYPH_CMTRT_2_3==1 |
                                            M04_SYPH_CMTRT_2_4==1 | M04_SYPH_CMTRT_2_5==1 | M04_SYPH_CMTRT_2_13==1 | 
                                            M04_SYPH_CMTRT_88_1==1 | M04_SYPH_CMTRT_88_2==1 | M04_SYPH_CMTRT_88_3==1 |
                                            M04_SYPH_CMTRT_88_4==1 | M04_SYPH_CMTRT_88_5==1 | M04_SYPH_CMTRT_88_13==1 ~1, 
                                            TRUE ~ as.numeric(0)))
table(MAT_SYPH_INFECT_TREAT_ANC = merged_df$MAT_SYPH_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")


merged_df <- merged_df %>%
  mutate(MAT_GONORRHEA_INFECT_TREAT_ANC = case_when(M04_GONORRHEA_CMTRT_1_1==1 | M04_GONORRHEA_CMTRT_1_2==1 | M04_GONORRHEA_CMTRT_1_3==1 |
                                            M04_GONORRHEA_CMTRT_1_4==1 | M04_GONORRHEA_CMTRT_1_5==1 | M04_GONORRHEA_CMTRT_1_13==1 | 
                                            M04_GONORRHEA_CMTRT_2_1==1 | M04_GONORRHEA_CMTRT_2_2==1 | M04_GONORRHEA_CMTRT_2_3==1 |
                                            M04_GONORRHEA_CMTRT_2_4==1 | M04_GONORRHEA_CMTRT_2_5==1 | M04_GONORRHEA_CMTRT_2_13==1 |
                                            M04_GONORRHEA_CMTRT_3_1==1 | M04_GONORRHEA_CMTRT_3_2==1 | M04_GONORRHEA_CMTRT_3_3==1 |
                                            M04_GONORRHEA_CMTRT_3_4==1 | M04_GONORRHEA_CMTRT_3_5==1 | M04_GONORRHEA_CMTRT_3_13==1 |
                                            M04_GONORRHEA_CMTRT_88_1==1 | M04_GONORRHEA_CMTRT_88_2==1 | M04_GONORRHEA_CMTRT_88_3==1 |
                                            M04_GONORRHEA_CMTRT_88_4==1 | M04_GONORRHEA_CMTRT_88_5==1 | M04_GONORRHEA_CMTRT_88_13==1 ~ 1, 
                                            TRUE ~ as.numeric(0)))
table(MAT_GONORRHEA_INFECT_TREAT_ANC = merged_df$MAT_GONORRHEA_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")

merged_df <- merged_df %>%
  mutate(MAT_CHLAMYDIA_INFECT_TREAT_ANC = case_when(M04_CHLAMYDIA_CMTRT_1_1==1 | M04_CHLAMYDIA_CMTRT_1_2==1 | M04_CHLAMYDIA_CMTRT_1_3==1 |
                                            M04_CHLAMYDIA_CMTRT_1_4==1 | M04_CHLAMYDIA_CMTRT_1_5==1 | M04_CHLAMYDIA_CMTRT_1_13==1 |
                                            M04_CHLAMYDIA_CMTRT_2_1==1 | M04_CHLAMYDIA_CMTRT_2_2==1 | M04_CHLAMYDIA_CMTRT_2_3==1 |
                                            M04_CHLAMYDIA_CMTRT_2_4==1 | M04_CHLAMYDIA_CMTRT_2_5==1 | M04_CHLAMYDIA_CMTRT_2_13==1 |
                                            M04_CHLAMYDIA_CMTRT_3_1==1 | M04_CHLAMYDIA_CMTRT_3_2==1 | M04_CHLAMYDIA_CMTRT_3_3==1 |
                                            M04_CHLAMYDIA_CMTRT_3_4==1 | M04_CHLAMYDIA_CMTRT_3_5==1 | M04_CHLAMYDIA_CMTRT_3_13==1 |
                                            M04_CHLAMYDIA_CMTRT_4_1==1 | M04_CHLAMYDIA_CMTRT_4_2==1 | M04_CHLAMYDIA_CMTRT_4_3==1 |
                                            M04_CHLAMYDIA_CMTRT_4_4==1 | M04_CHLAMYDIA_CMTRT_4_5==1 | M04_CHLAMYDIA_CMTRT_4_13==1 |
                                            M04_CHLAMYDIA_CMTRT_88_1==1 | M04_CHLAMYDIA_CMTRT_88_2==1 | M04_CHLAMYDIA_CMTRT_88_3==1 |
                                            M04_CHLAMYDIA_CMTRT_88_4==1 | M04_CHLAMYDIA_CMTRT_88_5==1 | M04_CHLAMYDIA_CMTRT_88_13==1 ~ 1,
                                            TRUE ~ as.numeric(0)))
table(MAT_CHLAMYDIA_INFECT_TREAT_ANC = merged_df$MAT_CHLAMYDIA_INFECT_TREAT_ANC, SITE = merged_df$SITE,useNA = "always")

merged_df <- merged_df %>%
  mutate(MAT_CHANC_INFECT_TREAT_ANC = case_when(M04_CHANC_CMTRT_1_1==1 | M04_CHANC_CMTRT_1_2==1 | M04_CHANC_CMTRT_1_3==1 |
                                            M04_CHANC_CMTRT_1_4==1 | M04_CHANC_CMTRT_1_5==1 | M04_CHANC_CMTRT_1_13==1 |
                                            M04_CHANC_CMTRT_2_1==1 | M04_CHANC_CMTRT_2_2==1 | M04_CHANC_CMTRT_2_3==1 |
                                            M04_CHANC_CMTRT_2_4==1 | M04_CHANC_CMTRT_2_5==1 | M04_CHANC_CMTRT_2_13==1 |
                                            M04_CHANC_CMTRT_3_1==1 | M04_CHANC_CMTRT_3_2==1 | M04_CHANC_CMTRT_3_3==1 |
                                            M04_CHANC_CMTRT_3_4==1 | M04_CHANC_CMTRT_3_5==1 | M04_CHANC_CMTRT_3_13==1 |
                                            M04_CHANC_CMTRT_4_1==1 | M04_CHANC_CMTRT_4_2==1 | M04_CHANC_CMTRT_4_5==1 |
                                            M04_CHANC_CMTRT_88_1==1 | M04_CHANC_CMTRT_88_2==1 | M04_CHANC_CMTRT_88_3==1 |
                                            M04_CHANC_CMTRT_88_4==1 | M04_CHANC_CMTRT_88_5==1 | M04_CHANC_CMTRT_88_13==1 ~1, 
                                            TRUE ~ as.numeric(0)))
table(MAT_CHANC_INFECT_TREAT_ANC = merged_df$MAT_CHANC_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")

merged_df <- merged_df %>%
  mutate(MAT_STI_OTHR_INFECT_TREAT_ANC = case_when(M04_STI_OTHR_CMOCCUR_1==1 | M04_STI_OTHR_CMOCCUR_2==1 | M04_STI_OTHR_CMOCCUR_3==1 |
                                            M04_STI_OTHR_CMOCCUR_4==1 | M04_STI_OTHR_CMOCCUR_5==1 | M04_STI_OTHR_CMOCCUR_13==1 ~ 1, 
                                            TRUE ~ as.numeric(0)))
table(MAT_STI_OTHR_INFECT_TREAT_ANC = merged_df$MAT_STI_OTHR_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")

merged_df <- merged_df %>%
  mutate(MAT_MALARIA_INFECT_TREAT_ANC = case_when(M04_MALARIA_EVER_CMTRT_1_1==1 | M04_MALARIA_EVER_CMTRT_1_2==1 | M04_MALARIA_EVER_CMTRT_1_3==1 |
                                            M04_MALARIA_EVER_CMTRT_1_4==1 | M04_MALARIA_EVER_CMTRT_1_5==1 | M04_MALARIA_EVER_CMTRT_1_13==1 |
                                            M04_MALARIA_EVER_CMTRT_2_1==1 | M04_MALARIA_EVER_CMTRT_2_2==1 | M04_MALARIA_EVER_CMTRT_2_3==1 |
                                            M04_MALARIA_EVER_CMTRT_2_4==1 | M04_MALARIA_EVER_CMTRT_2_5==1 | M04_MALARIA_EVER_CMTRT_2_13==1 | 
                                            M04_MALARIA_EVER_CMTRT_88_1==1 | M04_MALARIA_EVER_CMTRT_88_2==1 | M04_MALARIA_EVER_CMTRT_88_3==1 | 
                                            M04_MALARIA_EVER_CMTRT_88_4==1 | M04_MALARIA_EVER_CMTRT_88_5==1 | M04_MALARIA_EVER_CMTRT_88_13==1 ~ 1,
                                            TRUE ~ as.numeric(0)))
table(MAT_MALARIA_INFECT_TREAT_ANC = merged_df$MAT_MALARIA_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")

merged_df <- merged_df %>%
  mutate(MAT_TB_INFECT_TREAT_ANC = case_when(M04_TB_CMTRT_1_1==1 | M04_TB_CMTRT_1_2==1 | M04_TB_CMTRT_1_3==1 | 
                                            M04_TB_CMTRT_1_4==1 | M04_TB_CMTRT_1_5==1 | M04_TB_CMTRT_1_13==1 | 
                                            M04_TB_CMTRT_2_1==1 | M04_TB_CMTRT_2_2==1 | M04_TB_CMTRT_2_3==1 | 
                                            M04_TB_CMTRT_2_4==1 | M04_TB_CMTRT_2_5==1 | M04_TB_CMTRT_2_13==1 | 
                                            M04_TB_CMTRT_3_1==1 | M04_TB_CMTRT_3_2==1 | M04_TB_CMTRT_3_3==1 | 
                                            M04_TB_CMTRT_3_4==1 | M04_TB_CMTRT_3_5==1 | M04_TB_CMTRT_3_13==1 | 
                                            M04_TB_CMTRT_4_1==1 | M04_TB_CMTRT_4_2==1 | M04_TB_CMTRT_4_3==1 | 
                                            M04_TB_CMTRT_4_4==1 | M04_TB_CMTRT_4_5==1 | M04_TB_CMTRT_4_13==1 |
                                            M04_TB_CMTRT_5_1==1 | M04_TB_CMTRT_5_2==1 | M04_TB_CMTRT_5_3==1 | 
                                            M04_TB_CMTRT_5_4==1 | M04_TB_CMTRT_5_5==1 | M04_TB_CMTRT_5_13==1 | 
                                            M04_TB_CMTRT_88_1==1 | M04_TB_CMTRT_88_2==1 | M04_TB_CMTRT_88_3==1 |
                                            M04_TB_CMTRT_88_4==1 | M04_TB_CMTRT_88_5==1 | M04_TB_CMTRT_88_13==1 ~ 1,
                                            TRUE ~ as.numeric(0)))
table(MAT_TB_INFECT_TREAT_ANC = merged_df$MAT_TB_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")


#TREATMENT VARIABLES DURING ANC WITHOUT HOSP CONT.
merged_df <- merged_df %>%
  mutate(MAT_ANTIBX_TREAT_ANC = case_when((M04_ANTIBX_CMOCCUR_1==1 | M04_ANTIBX_CMOCCUR_2==1 | M04_ANTIBX_CMOCCUR_3==1 |
                                            M04_ANTIBX_CMOCCUR_4==1 | M04_ANTIBX_CMOCCUR_5==1 | M04_ANTIBX_CMOCCUR_13==1 |
                                            M04_ANTIBX_CMTRT_1_1==1 | M04_ANTIBX_CMTRT_1_2==1 | M04_ANTIBX_CMTRT_1_3==1 | 
                                            M04_ANTIBX_CMTRT_1_4==1 | M04_ANTIBX_CMTRT_1_5==1 | M04_ANTIBX_CMTRT_1_13==1 |  
                                            M04_ANTIBX_CMTRT_2_1==1 | M04_ANTIBX_CMTRT_2_2==1 | M04_ANTIBX_CMTRT_2_3==1 | 
                                            M04_ANTIBX_CMTRT_2_4==1 | M04_ANTIBX_CMTRT_2_5==1 | M04_ANTIBX_CMTRT_2_13==1 |
                                            M04_ANTIBX_CMTRT_3_1==1 | M04_ANTIBX_CMTRT_3_2==1 | M04_ANTIBX_CMTRT_3_3==1 | 
                                            M04_ANTIBX_CMTRT_3_4==1 | M04_ANTIBX_CMTRT_3_5==1 | M04_ANTIBX_CMTRT_3_13==1 | 
                                            M04_ANTIBX_CMTRT_4_1==1 | M04_ANTIBX_CMTRT_4_2==1 | M04_ANTIBX_CMTRT_4_3==1 | 
                                            M04_ANTIBX_CMTRT_4_4==1 | M04_ANTIBX_CMTRT_4_5==1 | M04_ANTIBX_CMTRT_4_13==1 | 
                                            M04_ANTIBX_CMTRT_5_1==1 | M04_ANTIBX_CMTRT_5_2==1 | M04_ANTIBX_CMTRT_5_3==1 | 
                                            M04_ANTIBX_CMTRT_5_4==1 | M04_ANTIBX_CMTRT_5_5==1 | M04_ANTIBX_CMTRT_5_13==1 | 
                                            M04_ANTIBX_CMTRT_6_1==1 | M04_ANTIBX_CMTRT_6_2==1 | M04_ANTIBX_CMTRT_6_3==1 | 
                                            M04_ANTIBX_CMTRT_6_4==1 | M04_ANTIBX_CMTRT_6_5==1 | M04_ANTIBX_CMTRT_6_13==1 |
                                            M04_ANTIBX_CMTRT_7_1==1 | M04_ANTIBX_CMTRT_7_2==1 | M04_ANTIBX_CMTRT_7_3==1 |
                                            M04_ANTIBX_CMTRT_7_4==1 | M04_ANTIBX_CMTRT_7_5==1 | M04_ANTIBX_CMTRT_7_13==1 |
                                            M04_ANTIBX_CMTRT_8_1==1 | M04_ANTIBX_CMTRT_8_2==1 | M04_ANTIBX_CMTRT_8_3==1 | 
                                            M04_ANTIBX_CMTRT_8_4==1 | M04_ANTIBX_CMTRT_8_5==1 | M04_ANTIBX_CMTRT_8_13==1 | 
                                            M04_ANTIBX_CMTRT_9_1==1 | M04_ANTIBX_CMTRT_9_2==1 | M04_ANTIBX_CMTRT_9_3==1 | 
                                            M04_ANTIBX_CMTRT_9_4==1 | M04_ANTIBX_CMTRT_9_5==1 | M04_ANTIBX_CMTRT_9_13==1 | 
                                            M04_ANTIBX_CMTRT_88_1==1 | M04_ANTIBX_CMTRT_88_2==1 | M04_ANTIBX_CMTRT_88_3==1 | 
                                            M04_ANTIBX_CMTRT_88_4==1 | M04_ANTIBX_CMTRT_88_5==1 | M04_ANTIBX_CMTRT_88_13==1) &
                                            # ANY OF THESE MEDS DURING ANC 1-5:
                                            # VISIT 1 - Indication can be: 1-99 except 9(Prophylaxis)
                                            ((M04_ANTIBX_CMINDC_1 %in% c(1,2,3,4,5,6,7,88,99)) |
                                            # DISCUSSED WITH ERS - INCLUDE "OTHER = 88" TRT.
                                            
                                            # VISIT 2 - Indication can be: 1-99 except 9(Prophylaxis)
                                            (M04_ANTIBX_CMINDC_2 %in% c(1,2,3,4,5,6,7,88,99)) |
                                            
                                            # VISIT 3 - Indication can be: 1-99 except 9(Prophylaxis)
                                            (M04_ANTIBX_CMINDC_3 %in% c(1,2,3,4,5,6,7,88,99)) |
                                            
                                            # VISIT 4 - Indication can be: 1-99 except 9(Prophylaxis)
                                            (M04_ANTIBX_CMINDC_2 %in% c(1,2,3,4,5,6,7,88,99)) |
                                            
                                            # VISIT 5 - Indication can be: 1-99 except 9(Prophylaxis)
                                            (M04_ANTIBX_CMINDC_2 %in% c(1,2,3,4,5,6,7,88,99)) |
                                            
                                            # VISIT 13 - UNSCHEDULED ANC - Indication can be: 1-99 except 9(Prophylaxis)
                                            (M04_ANTIBX_CMINDC_2 %in% c(1,2,3,4,5,6,7,88,99)))  ~ 1, 
                                          TRUE ~ as.numeric(0)))

table(MAT_ANTIBX_TREAT_ANC = merged_df$MAT_ANTIBX_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_ANTIBX_TREAT_ANC = merged_df$MAT_ANTIBX_TREAT_ANC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)


################## MATERNAL INFECTION TREATMENT DURING ANC WITHOUT HOSPITALZIATION
merged_df <- merged_df %>%
  mutate(MAT_INFECT_TREAT_ANC_WO_HOSP = case_when(MAT_CHANC_INFECT_TREAT_ANC ==1 | MAT_CHLAMYDIA_INFECT_TREAT_ANC==1 |
                                                 MAT_GONORRHEA_INFECT_TREAT_ANC==1 | MAT_STI_OTHR_INFECT_TREAT_ANC==1 | 
                                                 MAT_MALARIA_INFECT_TREAT_ANC==1 | MAT_TB_INFECT_TREAT_ANC==1 |
                                                 MAT_ANTIBX_TREAT_ANC==1 ~ 1,
                   TRUE ~ as.numeric(0)))

round(prop.table(table(MAT_INFECT_TREAT_ANC_WO_HOSP = merged_df$MAT_INFECT_TREAT_ANC_WO_HOSP, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)

```

# MATERNAL INFECTION TREATMENT DURING HOSPITALIZATION 
```{r}
##########################################################################
# MATERNAL INFECTION TREATMENT DURING HOSPITALIZATION # 
#TODO
# - WHAT IF M_19_PRIMARY_MHTERM == 5 (ORGAN FAILURE = YES) BUT ORGAN_FAIL_MHTERM_99==1 (DON'T KNOW)??? - ASK ERS - 
# --------------IT WILL BE INCLUDED THE WAY MY CODE IS SET UP RIGHT NOW.
#########################################################################
merged_df <- merged_df %>%
  mutate(MAT_INFECT_TREAT_ANC_HOSP = case_when(M19_ABX_CMOCCUR_13==1 | 
                                                     ((1 %in% c(M19_ABX_CMTRT_1_13, M19_ABX_CMTRT_2_13, M19_ABX_CMTRT_3_13, 
                                                                M19_ABX_CMTRT_4_13, M19_ABX_CMTRT_5_13, M19_ABX_CMTRT_6_13,
                                                                M19_ABX_CMTRT_7_13, M19_ABX_CMTRT_8_13, M19_ABX_CMTRT_9_13,
                                                                M19_ABX_CMTRT_88_13)) & M19_ABX_CMINDC_13!=8) ~ 1, # 'DON'T KNOW' IS NOT INCLUDED.
                                                   TRUE ~ as.numeric(0)))

table(MAT_INFECT_TREAT_ANC_HOSP = merged_df$MAT_INFECT_TREAT_ANC_HOSP, SITE = merged_df$SITE, useNA = "always")

round(prop.table(table(MAT_INFECT_TREAT_ANC_HOSP = merged_df$MAT_INFECT_TREAT_ANC_HOSP, 
                       SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```

# MATERNAL INFECTION VARIABLE - TREATED AT ANC INCL. HOSP (FINAL)
```{r}
###############################################################################################################
###############################################################################################################
############ MATERNAL INFECTION TREATMENT DURING ANC INCLUDING HOSPITALIZATION ###############################
merged_df <- merged_df %>%
  mutate(MAT_INFECT_TREAT_ANC = case_when(1 %in% c(MAT_INFECT_TREAT_ANC_WO_HOSP, MAT_INFECT_TREAT_ANC_HOSP) ~ 1,
         TRUE ~ as.numeric(0)))

table(MAT_INFECT_TREAT_ANC = merged_df$MAT_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_TREAT_ANC = merged_df$MAT_INFECT_TREAT_ANC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

# MATERNAL INFECTION VARIABLE - MEASURED AT ANc - NO HOSPITALIZATION DATA HAS LABS FOR INFECTION (FINAL)
```{r}
###########################################################################
# MATERNAL INFECTION MEASURED THROUGH POC MNH06 and LAB MNH06 - ANC ONLY #
##########################################################################

merged_df <- merged_df %>%  # POC FIRST (MNH06)
  mutate(MAT_INFECT_MEAS_ANC = case_when((M06_HIV_POC_LBORRES_1==1 | M06_HIV_POC_LBORRES_2==1 | M06_HIV_POC_LBORRES_3==1 | 
                                                   M06_HIV_POC_LBORRES_4==1 | M06_HIV_POC_LBORRES_5==1 |# M06_HIV_POC_LBORRES_13==1 | # UNSCHEDULED ANC VISITS _13
                                                   M06_MALARIA_POC_LBORRES_1==1 | M06_MALARIA_POC_LBORRES_2==1 | M06_MALARIA_POC_LBORRES_3==1 |
                                                   M06_MALARIA_POC_LBORRES_4==1 | M06_MALARIA_POC_LBORRES_5==1 | #M06_MALARIA_POC_LBORRES_13==1 | 
                                                   M06_SYPH_POC_LBORRES_1==1 | M06_SYPH_POC_LBORRES_2==1 | M06_SYPH_POC_LBORRES_3==1 |
                                                   M06_SYPH_POC_LBORRES_4==1 | M06_SYPH_POC_LBORRES_5==1 |# M06_SYPH_POC_LBORRES_13==1 |
                                                   M06_HBV_POC_LBORRES_1==1 | M06_HBV_POC_LBORRES_2==1 | M06_HBV_POC_LBORRES_3==1 | 
                                                   M06_HBV_POC_LBORRES_4==1 | M06_HBV_POC_LBORRES_5==1 |# M06_HBV_POC_LBORRES_13==1 | 
                                                   M06_HCV_POC_LBORRES_1==1 | M06_HCV_POC_LBORRES_2==1 | M06_HCV_POC_LBORRES_3==1 | 
                                                   M06_HCV_POC_LBORRES_4==1 | M06_HCV_POC_LBORRES_5==1 |# M06_HCV_POC_LBORRES_13==1 | 
                                                   M06_COVID_POC_LBORRES_1==1 | M06_COVID_POC_LBORRES_2==1 | M06_COVID_POC_LBORRES_3==1 | 
                                                   M06_COVID_POC_LBORRES_4==1 | M06_COVID_POC_LBORRES_5==1 ) ~ 1, #| M06_COVID_POC_LBORRES_13==1 
                                                   
                                                   # LAB DIAGNOSED (MNH08) 
                                                   (M08_MALBL_LBORRES_1==1 | M08_MALBL_LBORRES_2==1 | M08_MALBL_LBORRES_3==1 | #THESE LABS ARE NOT DONE DURING _13 VISITS.
                                                   M08_MALBL_LBORRES_4==1 | M08_MALBL_LBORRES_5==1 |
                                                   M08_PLACMAL_LBPERF_1_1==1 | M08_PLACMAL_LBPERF_1_2==1 | M08_PLACMAL_LBPERF_1_3==1 |
                                                   M08_PLACMAL_LBPERF_1_4==1 | M08_PLACMAL_LBPERF_1_5==1 | 
                                                   M08_TB_CNFRM_LBORRES_1==1 | M08_TB_CNFRM_LBORRES_2==1 | M08_TB_CNFRM_LBORRES_3==1 | 
                                                   M08_TB_CNFRM_LBORRES_4==1 | M08_TB_CNFRM_LBORRES_5==1 | 
                                                   M08_SYPH_TITER_LBPERF_1_1==1 | M08_SYPH_TITER_LBPERF_1_2==1 | M08_SYPH_TITER_LBPERF_1_3==1 | 
                                                   M08_SYPH_TITER_LBPERF_1_4==1 | M08_SYPH_TITER_LBPERF_1_5==1 |
                                                   M08_HEV_IGM_LBORRES_1==1 | M08_HEV_IGM_LBORRES_2==1 | M08_HEV_IGM_LBORRES_3==1 |
                                                   M08_HEV_IGM_LBORRES_4==1 | M08_HEV_IGM_LBORRES_5==1 | 
                                                   M08_CTNG_CT_LBORRES_1==1 | M08_CTNG_CT_LBORRES_2==1 | M08_CTNG_CT_LBORRES_3==1 | 
                                                   M08_CTNG_CT_LBORRES_4==1 | M08_CTNG_CT_LBORRES_5==1 |
                                                   M08_CTNG_NG_LBORRES_1==1 | M08_CTNG_NG_LBORRES_2==1 | M08_CTNG_NG_LBORRES_3==1 | 
                                                   M08_CTNG_NG_LBORRES_4==1 | M08_CTNG_NG_LBORRES_5==1 | 
                                                   M08_ZCD_ZIKIGM_LBORRES_1==1 | M08_ZCD_ZIKIGM_LBORRES_2==1 | M08_ZCD_ZIKIGM_LBORRES_3==1 |
                                                   M08_ZCD_ZIKIGM_LBORRES_4==1 | M08_ZCD_ZIKIGM_LBORRES_5==1 |
                                                   M08_ZCD_CHKIGM_LBORRES_1==1 | M08_ZCD_CHKIGM_LBORRES_2==1 | M08_ZCD_CHKIGM_LBORRES_3==1 | 
                                                   M08_ZCD_CHKIGM_LBORRES_4==1 | M08_ZCD_CHKIGM_LBORRES_5==1 | 
                                                   M08_ZCD_DENIGM_LBORRES_1==1 | M08_ZCD_DENIGM_LBORRES_2==1 | M08_ZCD_DENIGM_LBORRES_3==1 |
                                                   M08_ZCD_DENIGM_LBORRES_4==1 | M08_ZCD_DENIGM_LBORRES_5==1 |
                                                   M08_LEPT_IGM_LBORRES_1==1 | M08_LEPT_IGM_LBORRES_2==1 | M08_LEPT_IGM_LBORRES_3==1 | 
                                                   M08_LEPT_IGM_LBORRES_4==1 | M08_LEPT_IGM_LBORRES_5==1) ~ 1, 
                                                 
                                                 # Inconclusive:
                                                 (M08_MALBL_LBORRES_1==2 | M08_MALBL_LBORRES_2==2 | M08_MALBL_LBORRES_3==2 | 
                                                   M08_MALBL_LBORRES_4==1 | M08_MALBL_LBORRES_5==2 | 
                                                   M08_PLACMAL_LBPERF_1_1==2 | M08_PLACMAL_LBPERF_1_2==2 | M08_PLACMAL_LBPERF_1_3==2 |
                                                   M08_PLACMAL_LBPERF_1_4==2 | M08_PLACMAL_LBPERF_1_5==2 | 
                                                   M08_TB_CNFRM_LBORRES_1==2 | M08_TB_CNFRM_LBORRES_2==2 | M08_TB_CNFRM_LBORRES_3==2 | 
                                                   M08_TB_CNFRM_LBORRES_4==2 | M08_TB_CNFRM_LBORRES_5==2 | 
                                                   M08_SYPH_TITER_LBPERF_1_1==2 | M08_SYPH_TITER_LBPERF_1_2==2 | M08_SYPH_TITER_LBPERF_1_3==2 | 
                                                   M08_SYPH_TITER_LBPERF_1_4==2 | M08_SYPH_TITER_LBPERF_1_5==2 |
                                                   M08_HEV_IGM_LBORRES_1==2 | M08_HEV_IGM_LBORRES_2==2 | M08_HEV_IGM_LBORRES_3==2 |
                                                   M08_HEV_IGM_LBORRES_4==2 | M08_HEV_IGM_LBORRES_5==2 | 
                                                   M08_CTNG_CT_LBORRES_1==2 | M08_CTNG_CT_LBORRES_2==2 | M08_CTNG_CT_LBORRES_3==2 | 
                                                   M08_CTNG_CT_LBORRES_4==2 | M08_CTNG_CT_LBORRES_5==2 |
                                                   M08_CTNG_NG_LBORRES_1==2 | M08_CTNG_NG_LBORRES_2==2 | M08_CTNG_NG_LBORRES_3==2 | 
                                                   M08_CTNG_NG_LBORRES_4==2 | M08_CTNG_NG_LBORRES_5==2 | 
                                                   M08_ZCD_ZIKIGM_LBORRES_1==2 | M08_ZCD_ZIKIGM_LBORRES_2==2 | M08_ZCD_ZIKIGM_LBORRES_3==2 |
                                                   M08_ZCD_ZIKIGM_LBORRES_4==2 | M08_ZCD_ZIKIGM_LBORRES_5==2 |
                                                   M08_ZCD_CHKIGM_LBORRES_1==2 | M08_ZCD_CHKIGM_LBORRES_2==2 | M08_ZCD_CHKIGM_LBORRES_3==2 | 
                                                   M08_ZCD_CHKIGM_LBORRES_4==2 | M08_ZCD_CHKIGM_LBORRES_5==2 | 
                                                   M08_ZCD_DENIGM_LBORRES_1==2 | M08_ZCD_DENIGM_LBORRES_2==2 | M08_ZCD_DENIGM_LBORRES_3==2 |
                                                   M08_ZCD_DENIGM_LBORRES_4==2 | M08_ZCD_DENIGM_LBORRES_5==2 |
                                                   M08_LEPT_IGM_LBORRES_1==2 | M08_LEPT_IGM_LBORRES_2==2 | M08_LEPT_IGM_LBORRES_3==2 | 
                                                   M08_LEPT_IGM_LBORRES_4==2 | M08_LEPT_IGM_LBORRES_5==2) ~ 0, 
                                                 TRUE ~ as.numeric(0)))

table(MAT_INFECT_MEAS_ANC = merged_df$MAT_INFECT_MEAS_ANC, SITE= merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_MEAS_ANC = merged_df$MAT_INFECT_MEAS_ANC, SITE= merged_df$SITE,  useNA = "always"),
                 margin=2)*100,2)

```

# MATERNAL SEPSIS DIAGNOSED (INCLUDING ORGAN DYS) AT ANC INCLUDING HOSPITALIZATION _13 (FINAL)
```{r}

######################################
#TODO
# - SEPSIS/ORGAN DYSFUNCTION INFO IS ONLY PRESENT AT HOSPITALIZATION FOR ANC IN MNH19
# - THERE IS NO SEPSIS INFO IN MNH04, MNH06 OR MNH08
######################################

merged_df <- merged_df %>%
  mutate(MAT_SEPSIS_DIAG_ANC = case_when(M19_PRIMARY_MHTERM_13==5 |
                                                       (1 %in% c(M19_ORGAN_FAIL_MHTERM_1_13, M19_ORGAN_FAIL_MHTERM_2_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_3_13, M19_ORGAN_FAIL_MHTERM_4_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_5_13, M19_ORGAN_FAIL_MHTERM_6_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_7_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_88_13, M19_ORGAN_FAIL_MHTERM_99_13)) ~ 1, # OTHER AND DON'T KNOW.
                                                     M19_INFECTION_MHTERM_12_13==1 ~ 1,# MATERNAL SEPSIS OPTION ON MNH19
                                                     TRUE ~ as.numeric(0)))


table(MAT_SEPSIS_DIAG_ANC = merged_df$MAT_SEPSIS_DIAG_ANC, SITE = merged_df$SITE, useNA = "always") 
round(prop.table(table(MAT_SEPSIS_DIAG_ANC = merged_df$MAT_SEPSIS_DIAG_ANC, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)
```

# MATERNAL INFECTIONSEPSIS_ANY - ALL ANC (INFECT DIAGNOSED, INFECT TREATED, INFECT MEASURED + SEPSIS DIAGNOSED) (FINAL)
```{r}
merged_df <- merged_df %>%
  mutate(MAT_INFECTIONSEPSIS_ANY_ANC = case_when(1 %in% c(MAT_INFECT_DIAG_ANC, MAT_INFECT_TREAT_ANC, MAT_INFECT_MEAS_ANC, MAT_SEPSIS_DIAG_ANC) ~ 1,
         TRUE ~ as.numeric(0)))

table(MAT_INFECTIONSEPSIS_ANY_ANC = merged_df$MAT_INFECTIONSEPSIS_ANY_ANC, SITE = merged_df$SITE, useNA = "always") 
round(prop.table(table(MAT_INFECTIONSEPSIS_ANY_ANC = merged_df$MAT_INFECTIONSEPSIS_ANY_ANC, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)

```

#                               ### L&D INFECTION AND SEPSIS SECTION  ###

# LOOK AT INFECTION DIAGNOSED, TREATED AT L&D AND POST DELIVERY.  THERE ARE NO LAB MEASURED INFECTION.

# MATERNAL INFECTION DIAGNOSED AT IPC VISIT (FINAL)
```{r}
##########################################################################
# MATERNAL INFECTION DURING L&D AND POST-DELIVERY - VISIT 6 - DIAGNOSED # 
#TODO
# - KEEP "OTHER" 
#TODO ASK ERS: SHOULD I INCLUDE GENITAL ULCERS, HBV, HCV, OTHER  from MNH09
#########################################################################
merged_df <- merged_df %>% # DELIVERY AND POST DELIVERY
  mutate(MAT_INFECT_DIAG_IPC = case_when((1 %in% c(M09_COMMUNIC_MHOCCUR_1_6, M09_COMMUNIC_MHOCCUR_2_6, 
                                                     M09_COMMUNIC_MHOCCUR_3_6, M09_COMMUNIC_MHOCCUR_4_6, 
                                                     M09_COMMUNIC_MHOCCUR_5_6, M09_COMMUNIC_MHOCCUR_6_6,
                                                     M09_COMMUNIC_MHOCCUR_7_6, M09_COMMUNIC_MHOCCUR_8_6,
                                                     M09_COMMUNIC_MHOCCUR_9_6, M09_COMMUNIC_MHOCCUR_10_6,
                                                     
                                                     M09_INFECT_MHOCCUR_1_6, M09_INFECT_MHOCCUR_2_6, 
                                                     M09_INFECT_MHOCCUR_3_6, M09_INFECT_MHOCCUR_4_6, 
                                                     M09_INFECT_MHOCCUR_5_6, M09_INFECT_MHOCCUR_6_6, 
                                                     M09_INFECT_MHOCCUR_7_6, M09_INFECT_MHOCCUR_8_6, 
                                                     M09_INFECT_MHOCCUR_9_6)) & # M09_INFECT_MHOCCUR_10_6 = SEPSIS/SEPTIC SHOCK
                                              
                                              (1 %in% c(M09_INFECT_SRCE_2_6, M09_INFECT_SRCE_3_6)) ~ 1, # FACILITY BASED OR STUDY ASSESSMENT
                                         
                                         (1 %in% c(M10_POST_DEL_INF_CEOCCUR_1_6, M10_POST_DEL_INF_CEOCCUR_2_6,
                                            M10_POST_DEL_INF_CEOCCUR_3_6, M10_POST_DEL_INF_CEOCCUR_4_6,
                                            M10_POST_DEL_INF_CEOCCUR_5_6, M10_POST_DEL_INF_CEOCCUR_6_6, 
                                            M10_POST_DEL_INF_CEOCCUR_7_6, M10_POST_DEL_INF_CEOCCUR_8_6,
                                            M10_POST_DEL_INF_CEOCCUR_9_6, M10_POST_DEL_INF_CEOCCUR_10_6, 
                                            M10_POST_DEL_INF_CEOCCUR_11_6, M10_POST_DEL_INF_CEOCCUR_12_6, 
                                            M10_POST_DEL_INF_CEOCCUR_13_6, M10_POST_DEL_INF_CEOCCUR_14_6, 
                                            M10_POST_DEL_INF_CEOCCUR_88_6)) ~ 1, 
                                        TRUE ~ as.numeric(0)))

table(MAT_INFECT_DIAG_IPC = merged_df$MAT_INFECT_DIAG_IPC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_DIAG_IPC = merged_df$MAT_INFECT_DIAG_IPC, SITE = merged_df$SITE, useNA = "always"),
                 margin=2)*100,2)

```

# MATERNAL INFECTION TREATMENT AT IPC VISIT (FINAL)
```{r}

#############################################################
# MATERNAL INFECTION ***TREATMENT*** DURING L&D - VISIT 6  # 
# - SHOULD "OTHER" BE ADDED HERE - YES I ADDED!
#############################################################

merged_df <- merged_df %>%
  mutate(MAT_INFECT_TREAT_IPC = case_when((M09_ADMIT_ABX_CMOCCUR_6==1 | # MADE THIS INTO AN "OR" INSTEAD OF "AND" EVENTOUGH IT SHOULD BE "AND".
                                                              ((1 %in% c(M09_ADMIT_ABX_CMTRT_1_6, M09_ADMIT_ABX_CMTRT_2_6, M09_ADMIT_ABX_CMTRT_3_6,
                                                              M09_ADMIT_ABX_CMTRT_4_6, M09_ADMIT_ABX_CMTRT_5_6, M09_ADMIT_ABX_CMTRT_6_6,
                                                              M09_ADMIT_ABX_CMTRT_7_6, M09_ADMIT_ABX_CMTRT_8_6, M09_ADMIT_ABX_CMTRT_9_6)) &
                                                             # Indication is any of these reasons (i.e. UT, PID, dental infection, other, don't know etc):
                                                             M09_ADMIT_ABX_CMINDC_6!=8)) ~ 1, # AS LONG AS TYPE OF ABX IS NOT 'PROPHYLAXIS'
                                                          # M09_ADMIT_ABX_CMTRT_88==1
                                                          
                                                          # POST DELIVERY:
                                                          # NOTE: POST-DELVIERY DOESN'T HAVE INDICATION FOR WHY ABX GIVEN LIKE IPC DOES. 
                                                          (1 %in% c(M10_LD_ABX_CMOCCUR_1_6, M10_LD_ABX_CMOCCUR_2_6, M10_LD_ABX_CMOCCUR_3_6, 
                                                             M10_LD_ABX_CMOCCUR_4_6, M10_LD_ABX_CMOCCUR_5_6, M10_LD_ABX_CMOCCUR_6_6, 
                                                             M10_LD_ABX_CMOCCUR_7_6, M10_LD_ABX_CMOCCUR_88_6)) ~ 1,
                                                          TRUE ~ as.numeric(0)))

table(MAT_INFECT_TREAT_IPC = merged_df$MAT_INFECT_TREAT_IPC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_TREAT_IPC = merged_df$MAT_INFECT_TREAT_IPC, 
                       SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```

# MATERNAL ***SEPSIS*** DURING L&D (FINAL)
```{r}
merged_df <- merged_df %>% 
  mutate(MAT_SEPSIS_DIAG_IPC = case_when((1 %in% c(M09_ORG_FAIL_MHOCCUR_1_6, M09_ORG_FAIL_MHOCCUR_2_6,
                                M09_ORG_FAIL_MHOCCUR_3_6, M09_ORG_FAIL_MHOCCUR_4_6,
                                M09_ORG_FAIL_MHOCCUR_5_6, M09_ORG_FAIL_MHOCCUR_6_6, 
                                M09_ORG_FAIL_MHOCCUR_7_6, M09_ORG_FAIL_MHOCCUR_88_6,
                                M09_INFECT_MHOCCUR_10_6, # 10 = SEPSIS/SEPTIC SHOCK
                                # NO QUESTIONS ON ORGAN FAILURE IN MNH10 (POST DELIVERY)
                                M10_POST_DEL_INF_CEOCCUR_14_6) & # 14 = SEPSIS/SEPTIC SHOCK
                                  
                                  # SOURCE OF ORGAN FAILURE IS FACILITY BASED OR STUDY ASSESSMENT
                                  (M09_ORG_FAIL_SRCE_1_6==2 | M09_ORG_FAIL_SRCE_1_6==3)) ~ 1, 
                             TRUE ~ as.numeric(0)))

table(MAT_SEPSIS_DIAG_IPC = merged_df$MAT_SEPSIS_DIAG_IPC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_SEPSIS_DIAG_IPC = merged_df$MAT_SEPSIS_DIAG_IPC, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)
```

# MATERNAL INFECTION & SEPSIS AT L&D (FINAL)
```{r}
merged_df <- merged_df %>%
  mutate(MAT_INFECTIONSEPSIS_ANY_IPC = case_when(1 %in% c(MAT_INFECT_DIAG_IPC, MAT_INFECT_TREAT_IPC, MAT_SEPSIS_DIAG_IPC) ~ 1,
                                                 TRUE ~ as.numeric(0)))

table(MAT_INFECTIONSEPSIS_ANY_IPC = merged_df$MAT_INFECTIONSEPSIS_ANY_IPC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECTIONSEPSIS_ANY_IPC = merged_df$MAT_INFECTIONSEPSIS_ANY_IPC, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)
```

#UAA UAG UGA

***SECONDARY: MATERNAL INFECTION AND SEPSIS  - PNC VISIT***
USE MNH06 PNC6, PNC1, PNC4, PNC26 (VISITS 7-10)
```{r}
##########################################################################
# MATERNAL INFECTION DURING PNC - VISIT 7-10 - DIAGNOSED # 
#TODO
# - I INCLUDED SEPSIS HERE B/C IT'S ONE OF THE OPTIONS BUT I AM KEEPING IT SEPERATE AS MAT_DYS FOR OTHER VISITS - IS THIS CORRECT? 
# - SHOULD COVID_FAMETHOD = 1 OR 2 BE INCLUDED? ERS SAID ONLY INCLUDE 1 OR 2. 
# - # THERE ARE A LOT OF COVID-19 IMAGINING QUESTIONS HERE - SHOULD THOSE BE ACCOUNTED FOR?
# - REASON I AM INCLUDING SEPSIS HERE IS B/C IT IS PART OF MN12 - PNC CLINICAL DIAGNOSIS:
# -------"WAS MOTHER DIAGNOSED WITH MATERNAL SEPSIS/SEPTIC SHOCK" WITH:
# ------------POST_DEL_INF_MHOCCUR_11
# -------AND THERE IS ANOTHER QUESTION: 
# ------------WAS MOTHER DIAGNOSED WITH ORGAN FAILURE.
#########################################################################

temp.df <- merged_df %>% 
  select(MOMID, PREGID, M12_POST_DEL_INF_MHOCCUR_1_7, M12_POST_DEL_INF_MHOCCUR_2_7, M12_POST_DEL_INF_MHOCCUR_3_7,
                                                    M12_POST_DEL_INF_MHOCCUR_4_7, M12_POST_DEL_INF_MHOCCUR_5_7, M12_POST_DEL_INF_MHOCCUR_6_7, 
                                                    M12_POST_DEL_INF_MHOCCUR_7_7, M12_POST_DEL_INF_MHOCCUR_8_7, M12_POST_DEL_INF_MHOCCUR_9_7,
                                                    M12_POST_DEL_INF_MHOCCUR_10_7, M12_POST_DEL_INF_MHOCCUR_11_7)


merged_df <- merged_df %>%                  # VISIT 7
  mutate(MAT_INFECT_N_SEPSIS_DIAG_PNC = case_when((1 %in% c(M12_POST_DEL_INF_MHOCCUR_1_7, M12_POST_DEL_INF_MHOCCUR_2_7, M12_POST_DEL_INF_MHOCCUR_3_7,
                                                            M12_POST_DEL_INF_MHOCCUR_4_7, M12_POST_DEL_INF_MHOCCUR_5_7, M12_POST_DEL_INF_MHOCCUR_6_7, 
                                                            M12_POST_DEL_INF_MHOCCUR_7_7, M12_POST_DEL_INF_MHOCCUR_8_7, M12_POST_DEL_INF_MHOCCUR_9_7,
                                                            M12_POST_DEL_INF_MHOCCUR_10_7, M12_POST_DEL_INF_MHOCCUR_11_7)) ~1, #_11 is SEPSIS.
                                                  
                                                  #ORGAN FAILURE QUESTION:
                                                  (1 %in% c(M12_ORG_FAIL_MHOCCUR_1_7, M12_ORG_FAIL_MHOCCUR_2_7, M12_ORG_FAIL_MHOCCUR_3_7,
                                                            M12_ORG_FAIL_MHOCCUR_4_7, M12_ORG_FAIL_MHOCCUR_88_7)) ~ 1,
                                                  
                                                  # SARI, COVID-19, MALARIA, HIV:
                                                  (M12_SARI_CEOCCUR_7==1 | 
                                                     (M12_COVID_LBPERF_7==1 &  
                                                        (M12_COVID_FAMETHOD_7 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.  
                                                     (M12_MALARIA_MHOCCUR_7==1 | 
                                                        (M12_MALARIA_FAMETHOD_7 %in% c(1,2)))| 
                                                     M12_HIV_MHOCCUR_7==1) ~ 1,
                                                  
                                                  # VISIT 8: 
                                                  (M12_POST_DEL_INF_MHOCCUR_1_8==1 | M12_POST_DEL_INF_MHOCCUR_2_8==1 | M12_POST_DEL_INF_MHOCCUR_3_8==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_4_8==1 | M12_POST_DEL_INF_MHOCCUR_5_8==1 | M12_POST_DEL_INF_MHOCCUR_6_8==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_7_8==1 | M12_POST_DEL_INF_MHOCCUR_8_8==1 |M12_POST_DEL_INF_MHOCCUR_9_8==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_10_8==1 |M12_POST_DEL_INF_MHOCCUR_11_8==1) ~ 1,
                                                  
                                                  #ORGAN FAILURE QUESTION:
                                                  (1 %in% c(M12_ORG_FAIL_MHOCCUR_1_8, M12_ORG_FAIL_MHOCCUR_2_8, M12_ORG_FAIL_MHOCCUR_3_8,
                                                            M12_ORG_FAIL_MHOCCUR_4_8, M12_ORG_FAIL_MHOCCUR_88_8)) ~ 1,
                                                  
                                                  # SARI, COVID-19, MALARIA, HIV:
                                                  (M12_SARI_CEOCCUR_8==1 |
                                                     (M12_COVID_LBPERF_8==1 & 
                                                        (M12_COVID_FAMETHOD_8 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.  
                                                     (M12_MALARIA_MHOCCUR_8==1 & 
                                                        (M12_MALARIA_FAMETHOD_8 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.  
                                                     (M12_HIV_MHOCCUR_8==1)) ~ 1,
                                                  
                                                  
                                                  # VISIT 9:
                                                  (M12_POST_DEL_INF_MHOCCUR_1_9==1 | M12_POST_DEL_INF_MHOCCUR_2_9==1 | M12_POST_DEL_INF_MHOCCUR_3_9==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_4_9==1 | M12_POST_DEL_INF_MHOCCUR_5_9==1 | M12_POST_DEL_INF_MHOCCUR_6_9==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_7_9==1 | M12_POST_DEL_INF_MHOCCUR_8_9==1 | M12_POST_DEL_INF_MHOCCUR_9_9==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_10_9==1 | M12_POST_DEL_INF_MHOCCUR_11_9==1) ~ 1,
                                                  
                                                  #ORGAN FAILURE QUESTION:
                                                  (1 %in% c(M12_ORG_FAIL_MHOCCUR_1_9, M12_ORG_FAIL_MHOCCUR_2_9, M12_ORG_FAIL_MHOCCUR_3_9,
                                                            M12_ORG_FAIL_MHOCCUR_4_9, M12_ORG_FAIL_MHOCCUR_88_9)) ~ 1,
                                                  
                                                  # SARI, COVID-19, MALARIA, HIV:
                                                  (M12_SARI_CEOCCUR_9==1  | 
                                                     (M12_COVID_LBPERF_9==1 |   # THERE ARE A LOT OF COVID-19 IMAGINING QUESTIONS HERE - SHOULD THOSE BE ACCOUNTED FOR? 
                                                        (M12_COVID_FAMETHOD_9 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.
                                                     (M12_MALARIA_MHOCCUR_9==1 | 
                                                        (M12_MALARIA_FAMETHOD_9 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.
                                                     M12_HIV_MHOCCUR_9==1) ~ 1,
                                                  
                                                  # VISIT 10: 
                                                  (M12_POST_DEL_INF_MHOCCUR_1_10==1 | M12_POST_DEL_INF_MHOCCUR_2_10==1 | M12_POST_DEL_INF_MHOCCUR_3_10==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_4_10==1 | M12_POST_DEL_INF_MHOCCUR_5_10==1 | M12_POST_DEL_INF_MHOCCUR_6_10==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_7_10==1 | M12_POST_DEL_INF_MHOCCUR_8_10==1 | M12_POST_DEL_INF_MHOCCUR_9_10==1 |
                                                     M12_POST_DEL_INF_MHOCCUR_10_10==1 | M12_POST_DEL_INF_MHOCCUR_11_10==1) ~ 1,
                                                  
                                                  # ORGAN FAILURE QUESTION:
                                                  (1 %in% c(M12_ORG_FAIL_MHOCCUR_1_10, M12_ORG_FAIL_MHOCCUR_2_10, M12_ORG_FAIL_MHOCCUR_3_10,
                                                            M12_ORG_FAIL_MHOCCUR_4_10, M12_ORG_FAIL_MHOCCUR_88_10)) ~ 1,
                                                  
                                                  # SARI, COVID-19, MALARIA, HIV:
                                                  (M12_SARI_CEOCCUR_10==1 |
                                                     (M12_COVID_LBPERF_10==1 &
                                                        (M12_COVID_FAMETHOD_10 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.
                                                     (M12_MALARIA_MHOCCUR_10==1 & 
                                                        (M12_MALARIA_FAMETHOD_10 %in% c(1,2))) | #ERS SUGGESTED NOT TO INCLUDE "DONT KNOW" IN THIS.
                                                     M12_HIV_MHOCCUR_10==1) ~ 1,
                                                  TRUE ~ as.numeric(0)))

table(MAT_INFECT_N_SEPSIS_DIAG_PNC = merged_df$MAT_INFECT_N_SEPSIS_DIAG_PNC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_N_SEPSIS_DIAG_PNC = merged_df$MAT_INFECT_N_SEPSIS_DIAG_PNC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```


```{r}
##########################################################################
# MATERNAL INFECTION DURING PNC - VISIT 7-10 - TREATMENT # 
#TODO
# - # THERE ARE A LOT OF COVID-19 IMAGINING QUESTIONS HERE - SHOULD THOSE BE ACCOUNTED FOR?
# - NOTE THAT I AM NOT LOOKING AT HIV_MHOCUR (WAS MOTHER DIAGNOSED WITH HIV?) FIRST 
# -------B/C IN ZAMBIA THIS QUESTION = 0 BUT THEN HIV MEDICATION ==1.

#########################################################################
# as.logical(sum(c(1,2,3) %in% c(2,3,4,5)))

temp.df <- merged_df %>% 
  select(MOMID, PREGID, SITE, M12_HIV_MHOCCUR_7, M12_HIV_CMOCCUR_7, M12_HIV_CMOCCUR_DAT_7, 
         M12_HIV_CMTRT_1_7, M12_HIV_CMTRT_2_7, M12_HIV_CMTRT_3_7, M12_HIV_CMTRT_4_7,
         M12_HIV_CMTRT_5_7, M12_HIV_CMTRT_6_7,M12_HIV_CMTRT_7_7, M12_HIV_CMTRT_8_7,
         M12_HIV_CMTRT_9_7, M12_HIV_CMTRT_10_7, M12_HIV_CMTRT_11_7, M12_HIV_CMTRT_12_7,
         M12_HIV_CMTRT_13_7, M12_HIV_CMTRT_14_7, M12_HIV_CMTRT_15_7, M12_HIV_CMTRT_16_7,
         M12_HIV_CMTRT_17_7, M12_HIV_CMTRT_18_7, M12_HIV_CMTRT_18_7, M12_HIV_CMTRT_20_7,
         M12_HIV_CMTRT_21_7, M12_HIV_CMTRT_22_7, M12_HIV_CMTRT_23_7, M12_HIV_CMTRT_24_7,
         M12_HIV_CMTRT_25_7, M12_HIV_CMTRT_88_7)


merged_df <- merged_df %>% #VISIT 7
  mutate(MAT_INFECT_TREAT_PNC = case_when((M12_HIV_CMOCCUR_7==1 | !is.na(M12_HIV_CMOCCUR_DAT_7)) | 
                                                 (1 %in% c(M12_HIV_CMTRT_1_7, M12_HIV_CMTRT_2_7, M12_HIV_CMTRT_3_7, M12_HIV_CMTRT_4_7,
                                                           M12_HIV_CMTRT_5_7, M12_HIV_CMTRT_6_7, M12_HIV_CMTRT_7_7, M12_HIV_CMTRT_8_7,
                                                           M12_HIV_CMTRT_9_7, M12_HIV_CMTRT_10_7, M12_HIV_CMTRT_11_7, M12_HIV_CMTRT_12_7,
                                                           M12_HIV_CMTRT_13_7, M12_HIV_CMTRT_14_7, M12_HIV_CMTRT_15_7, M12_HIV_CMTRT_16_7,
                                                           M12_HIV_CMTRT_17_7, M12_HIV_CMTRT_18_7, M12_HIV_CMTRT_18_7, M12_HIV_CMTRT_20_7,
                                                           M12_HIV_CMTRT_21_7, M12_HIV_CMTRT_22_7, M12_HIV_CMTRT_23_7, M12_HIV_CMTRT_24_7,
                                                           M12_HIV_CMTRT_25_7, M12_HIV_CMTRT_88_7)) ~ 1, 
                                               
                                               #VISIT 8
                                               (M12_HIV_CMOCCUR_8==1 | !is.na(M12_HIV_CMOCCUR_DAT_8)) | 
                                                 (1 %in% c(M12_HIV_CMTRT_1_8, M12_HIV_CMTRT_2_8, M12_HIV_CMTRT_3_8, M12_HIV_CMTRT_4_8,
                                                           M12_HIV_CMTRT_5_8, M12_HIV_CMTRT_6_8, M12_HIV_CMTRT_7_8, M12_HIV_CMTRT_8_8,
                                                           M12_HIV_CMTRT_9_8, M12_HIV_CMTRT_10_8, M12_HIV_CMTRT_11_8, M12_HIV_CMTRT_12_8,
                                                           M12_HIV_CMTRT_13_8, M12_HIV_CMTRT_14_8, M12_HIV_CMTRT_15_8, M12_HIV_CMTRT_16_8,
                                                           M12_HIV_CMTRT_17_8, M12_HIV_CMTRT_18_8, M12_HIV_CMTRT_18_8, M12_HIV_CMTRT_20_8,
                                                           M12_HIV_CMTRT_21_8, M12_HIV_CMTRT_22_8, M12_HIV_CMTRT_23_8, M12_HIV_CMTRT_24_8,
                                                           M12_HIV_CMTRT_25_8, M12_HIV_CMTRT_88_8)) ~ 1,
                                               
                                               #VISIT 9
                                               (M12_HIV_CMOCCUR_9==1 | !is.na(M12_HIV_CMOCCUR_DAT_9)) | 
                                                 (1 %in% c(M12_HIV_CMTRT_1_9, M12_HIV_CMTRT_2_9, M12_HIV_CMTRT_3_9, M12_HIV_CMTRT_4_9,
                                                           M12_HIV_CMTRT_5_9, M12_HIV_CMTRT_6_9, M12_HIV_CMTRT_7_9, M12_HIV_CMTRT_8_9,
                                                           M12_HIV_CMTRT_9_9, M12_HIV_CMTRT_10_9, M12_HIV_CMTRT_11_9, M12_HIV_CMTRT_12_9,
                                                           M12_HIV_CMTRT_13_9, M12_HIV_CMTRT_14_9, M12_HIV_CMTRT_15_9, M12_HIV_CMTRT_16_9,
                                                           M12_HIV_CMTRT_17_9, M12_HIV_CMTRT_18_9, M12_HIV_CMTRT_18_9, M12_HIV_CMTRT_20_9,
                                                           M12_HIV_CMTRT_21_9, M12_HIV_CMTRT_22_9, M12_HIV_CMTRT_23_9, M12_HIV_CMTRT_24_9,
                                                           M12_HIV_CMTRT_25_9, M12_HIV_CMTRT_88_9)) ~ 1, 
                                               
                                               #VISIT 10
                                               (M12_HIV_CMOCCUR_10==1 | !is.na(M12_HIV_CMOCCUR_DAT_10)) | 
                                                 (1 %in% c(M12_HIV_CMTRT_1_10, M12_HIV_CMTRT_2_10, M12_HIV_CMTRT_3_10, M12_HIV_CMTRT_4_10,
                                                           M12_HIV_CMTRT_5_10, M12_HIV_CMTRT_6_10, M12_HIV_CMTRT_7_10, M12_HIV_CMTRT_8_10,
                                                           M12_HIV_CMTRT_9_10, M12_HIV_CMTRT_10_10, M12_HIV_CMTRT_11_10, M12_HIV_CMTRT_12_10,
                                                           M12_HIV_CMTRT_13_10, M12_HIV_CMTRT_14_10, M12_HIV_CMTRT_15_10, M12_HIV_CMTRT_16_10,
                                                           M12_HIV_CMTRT_17_10, M12_HIV_CMTRT_18_10, M12_HIV_CMTRT_18_10, M12_HIV_CMTRT_20_10,
                                                           M12_HIV_CMTRT_21_10, M12_HIV_CMTRT_22_10, M12_HIV_CMTRT_23_10, M12_HIV_CMTRT_24_10,
                                                           M12_HIV_CMTRT_25_10, M12_HIV_CMTRT_88_10)) ~ 1, 
                                               TRUE ~ as.numeric(0)))
table(merged_df$MAT_INFECT_TREAT_PNC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(merged_df$MAT_INFECT_TREAT_PNC, SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)

##########################################################################
# MATERNAL INFECTION DURING PNC - DIAGNOSED # 
#TODO
# MNH08 ONLY DURING PNC6 - VISIT 10
#########################################################################

# LAB DIAGNOSED (MNH08) 
    #THESE LABS ARE NOT DONE DURING _13 VISITS.
merged_df <- merged_df %>% 
  mutate(MAT_INFECT_MEAS_PNC = case_when((1 %in% c(M08_MALBL_LBORRES_10, M08_PLACMAL_LBPERF_1_10, 
                             M08_TB_CNFRM_LBORRES_10, M08_SYPH_TITER_LBPERF_1_10,
                             M08_HEV_IGM_LBORRES_10, M08_CTNG_CT_LBORRES_10,
                             M08_CTNG_NG_LBORRES_10, M08_ZCD_ZIKIGM_LBORRES_10,
                             M08_ZCD_CHKIGM_LBORRES_10, M08_ZCD_DENIGM_LBORRES_10,
                             M08_LEPT_IGM_LBORRES_10)) ~ 1, 
                   
                   # Inconclusive:
                   (1 %in% c(M08_MALBL_LBORRES_10, M08_PLACMAL_LBPERF_1_10,
                             M08_TB_CNFRM_LBORRES_10, M08_SYPH_TITER_LBPERF_1_10,
                             M08_HEV_IGM_LBORRES_10, M08_CTNG_CT_LBORRES_10,
                             M08_CTNG_NG_LBORRES_10, M08_ZCD_ZIKIGM_LBORRES_10,
                             M08_ZCD_CHKIGM_LBORRES_10, M08_ZCD_DENIGM_LBORRES_10,
                             M08_LEPT_IGM_LBORRES_10)) ~ 0, 
                   TRUE ~ as.numeric(0)))

table(merged_df$MAT_INFECT_MEAS_PNC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(merged_df$MAT_INFECT_MEAS_PNC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```


***SECONDARY: MATERNAL INFECTION AND SEPSIS (PREGNANCY) - HOSPITALIZATION (MNH19) VISIT***
```{r}
##########################################################################
# MATERNAL INFECTION DURING HOSPITALIZATION - IT'S DIAGNOSED ONLY, NO MEASURED # 
#TODO
# - LOOK AT MNH19 - HOSPITALIZATION AND MNH27 - VERBAL AUTOPSY
# - THIS DOESN'T CURRENTLY INCLUDE HOSPITALIZATION DURING PNC _14 
# - DOESN'T CURRENTLY INCLUDE AUTOPSY MNH27 YET - I CAN'T FIND THE CRF VERSION - 
# -----JUST SEE INSTRUMENT THAT IS ADMINSTERED IN THE FIELD - 09/22/2023
# ------B/C THERE ARE NONE - AND I HAVEN'T CREATED AS OF 09/22/2023
#########################################################################

# WOMAN CAN BE HOSPITALZIED DURING ANC _13 OR PNC_14.
merged_df <- merged_df %>%
  mutate(MAT_INFECT_DIAG_HOSP_VA_ANC_PNC = case_when(M19_PRIMARY_MHTERM_13==2 | # 2= INFECTION; 5= ORGAN FAILURE
                                               (1 %in% c(M19_INFECTION_MHTERM_1_13, M19_INFECTION_MHTERM_2_13, M19_INFECTION_MHTERM_3_13, 
                                                         M19_INFECTION_MHTERM_4_13, M19_INFECTION_MHTERM_5_13, M19_INFECTION_MHTERM_6_13, 
                                                         M19_INFECTION_MHTERM_7_13, M19_INFECTION_MHTERM_8_13, M19_INFECTION_MHTERM_9_13, 
                                                         M19_INFECTION_MHTERM_10_13, M19_INFECTION_MHTERM_11_13, # NOT INCLUDING 12 B/C IT IS MATERNAL SEPSIS 
                                                         M19_INFECTION_MHTERM_13_13, M19_INFECTION_MHTERM_14_13, M19_INFECTION_MHTERM_15_13, 
                                                         # THERE IS NO 16 B/C IT IS ENDOMETRITIS
                                                         M19_INFECTION_MHTERM_17_13, M19_INFECTION_MHTERM_18_13, M19_INFECTION_MHTERM_19_13, 
                                                         M19_INFECTION_MHTERM_88_13)) ~ 1, 
         TRUE ~ as.numeric(0))) 

table(MAT_INFECT_DIAG_HOSP_VA_ANC_PNC=merged_df$MAT_INFECT_DIAG_HOSP_VA_ANC_PNC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_DIAG_HOSP_VA_ANC_PNC = merged_df$MAT_INFECT_DIAG_HOSP_VA_ANC_PNC, 
                       SITE = merged_df$SITE, useNA = "always"),margin=2)*100,2)



##########################################################################
# MATERNAL ***ORGAN DYSFUNCTION/SEPSIS*** DURING HOSPITALIZATION # 
#TODO
# LOOK AT MNH19 - HOSPITALIZATION AND MNH27 - VERBAL AUTOPSY
# - WHAT IF M_19_PRIMARY_MHTERM == 5 (ORGAN FAILURE = YES) BUT ORGAN_FAIL_MHTERM_99==1 (DON'T KNOW)??? - ASK ERS
#########################################################################
merged_df <- merged_df %>%
  mutate(MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC = case_when(M19_PRIMARY_MHTERM_13==5 |
                                                       (1 %in% c(M19_ORGAN_FAIL_MHTERM_1_13, M19_ORGAN_FAIL_MHTERM_2_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_3_13, M19_ORGAN_FAIL_MHTERM_4_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_5_13, M19_ORGAN_FAIL_MHTERM_6_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_7_13, 
                                                                 M19_ORGAN_FAIL_MHTERM_88_13, M19_ORGAN_FAIL_MHTERM_99_13)) ~ 1, # OTHER AND DON'T KNOW.
                                                     M19_INFECTION_MHTERM_12_13==1 ~ 1,# MATERNAL SEPSIS OPTION ON MNH19
                                                     TRUE ~ as.numeric(0)))

table(MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC = merged_df$MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_SEPSIS_DIAG_HOSP_VA_ANc_PNC = merged_df$MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC, SITE = merged_df$SITE, useNA = "always"), margin=2)*100, 2)                                                  

```

# MATERNAL INFECTION ***AND*** SEPSIS
```{r}
###################################################################################################
# MATERNAL INFECTION AND SEPSIS AND ORGAN DYSFUNCTION # 
#TODO
# - THIS IS DURING ANC, PNC, HOSPITAIATION, IPC (DIAGNOSED, MEASURED, TREATED) - ALL POSSIBILITIES.
###################################################################################################

merged_df <- merged_df %>%
  mutate(MAT_INFECT_SEPSIS_ANY = case_when(1 %in% c(MAT_DYS, MAT_INFECT_DIAG_ANC, MAT_INFECT_SEPSIS_DIAG_ANC, 
                                                    MAT_INFECT_DIAG_TREAT_ANC, MAT_INFECT_MEAS_POC_LAB_ANC,
                                                    MAT_INFECT_DIAG_IPC_POST_DELIV, MAT_INFECT_TREAT_IPC_POST_DELIV, 
                                                    MAT_INFECT_TREAT_IPC_POST_DELIV, MAT_INFECT_N_SEPSIS_DIAG_PNC, 
                                                    MAT_INFECT_TREAT_PNC, MAT_INFECT_MEAS_PNC, 
                                                    MAT_INFECT_DIAG_HOSP_VA_ANC_PNC, MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC, 
                                                    MAT_INFECT_TREAT_DIAG_HOSP_ANC_PNC) ~ 1,
                                           TRUE ~ as.numeric(0)))

table(MAT_INFECT_SEPSIS_ANY = merged_df$MAT_INFECT_SEPSIS_ANY, SITE = merged_df$SITE, useNA = "always")
round(prop.table(table(MAT_INFECT_SEPSIS_ANY = merged_df$MAT_INFECT_SEPSIS_ANY, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)


#### MATERNAL INFECTION AND SEPSIS IN PREGNANCY
merged_df <- merged_df %>%
  mutate(MAT_INFECT_SEPSIS_ANC_ANY = case_when(1 %in% c(MAT_INFECT_DIAG_ANC, MAT_INFECT_SEPSIS_DIAG_ANC, 
                                                    MAT_INFECT_DIAG_TREAT_ANC, MAT_INFECT_MEAS_POC_LAB_ANC) ~ 1,
         TRUE ~ as.numeric(0)))

round(prop.table(table(MAT_INFECT_SEPSIS_ANC_ANY = merged_df$MAT_INFECT_SEPSIS_ANC_ANY, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)

#### MATERNAL INFECTION AND SEPSIS AT L&D
merged_df <- merged_df %>%
  mutate(MAT_INFECT_SEPSIS_IPC_ANY = case_when(1 %in% c(MAT_DYS, MAT_INFECT_DIAG_IPC_POST_DELIV, MAT_INFECT_TREAT_IPC_POST_DELIV, 
                                                    MAT_INFECT_TREAT_IPC_POST_DELIV) ~ 1,
         TRUE ~ as.numeric(0)))

round(prop.table(table(MAT_INFECT_SEPSIS_IPC_ANY = merged_df$MAT_INFECT_SEPSIS_IPC_ANY, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)

#### MATERNAL INFECTION AND SEPSIS AT PNC
merged_df <- merged_df %>%
  mutate(MAT_INFECT_SEPSIS_PNC_ANY = case_when(1 %in% c(MAT_INFECT_N_SEPSIS_DIAG_PNC, # NO NEED TO ADD MAT_DYS B/C SEPSIS IS PART OF ITS DEFINITION.
                                                    MAT_INFECT_TREAT_PNC, MAT_INFECT_MEAS_PNC) ~ 1,
         TRUE ~ as.numeric(0)))

round(prop.table(table(MAT_INFECT_SEPSIS_PNC_ANY = merged_df$MAT_INFECT_SEPSIS_PNC_ANY, SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)

#### MATERNAL INFECTION AND SEPSIS DURING HOSPITALIZATION (ANC OR PNC) OR VERBAL AUTOPSY
merged_df <- merged_df %>%
  mutate(MAT_INFECT_SEPSIS_HOSP_ANC_PNC_vA_ANY = case_when(1 %in% c(MAT_INFECT_DIAG_HOSP_VA_ANC_PNC, MAT_SEPSIS_DIAG_HOSP_VA_ANC_PNC, 
                                                                    MAT_INFECT_TREAT_DIAG_HOSP_ANC_PNC) ~ 1,
                                                           TRUE ~ as.numeric(0)))

round(prop.table(table(MAT_INFECT_SEPSIS_HOSP_ANC_PNC_vA_ANY = merged_df$MAT_INFECT_SEPSIS_HOSP_ANC_PNC_vA_ANY, 
                       SITE = merged_df$SITE, useNA = "always"), margin=2)*100,2)
```


#SEPSIS
```{r}

##########################################################################
# MATERNAL INFECTION TREATMENT DURING HOSPITALIZATION# 
#TODO
# LOOK AT MNH19 - HOSPITALIZATION AND MNH27 - VERBAL AUTOPSY
# - WHAT IF M_19_PRIMARY_MHTERM == 5 (ORGAN FAILURE = YES) BUT ORGAN_FAIL_MHTERM_99==1 (DON'T KNOW)??? - ASK ERS
#########################################################################

############
# SEPSIS #
# - Should this be AND or OR.
###########
merged_df <- merged_df %>% 
  mutate(MAT_INFECT_SEPSIS_DIAG_ANC = case_when(MAT_DYS==1 | MAT_INFECT_DIAG_ANC==1 ~ 1, 
                                         TRUE ~ as.numeric(0)))
table(merged_df$MAT_INFECT_SEPSIS_DIAG_ANC, SITE= merged_df$SITE, useNA = "always")

# LOOK AT Q12 IN M10 ALSO FOR INFECTION TREATMENT AT L&D AND POST DELIVERY.       
# INCLUDE M09_INFECT_MHOCCUR_10_6==1 FOR SEPSIS/SEPTIC SHOCK FOR L&D
# INCLUDE M10_POST_DEL_INF_CEOCCUR_14 - POST L&D FORM 

```



# MATERNAL INFECT_DIAGNOSED AT ANYTIME (ANC, ANC-HOSP, L&D, PNC, PNC-HOSP)
```{r}

```


******************************************************************************************************
******************************************************************************************************
******************************************************************************************************
                                          FETAL OUTCOMES:
******************************************************************************************************
******************************************************************************************************
******************************************************************************************************
Neonatal mortality (Death of a live born baby during the first 28 days of life from any cause. )

L&D: M09_DELIV_DSSTDAT_INF1	Date of delivery:
L&D: M09_BIRTH_DSTERM_INF1	Birth outcome
PNC: M11_DTHDAT	Specify date of death
Inf Close-out: M24_DTHDAT	Record date of death
Do this for all 4 infants:
If (birth outcome == fetal death) --> NEO_DTH==0
If (birth outcome == live & date of death <= (date of birth + 28 days)) --> NEO_DTH==1
***WHY DO WE NEED M11_DTHDAT --> MATERNAL DEATH DATE - DOES IT HAVE ANYTHING TO DO WITH NEONATAL MORTALITY?***
***HOW COME M24_DTHDAT DOESN'T BLONG TO EACH OF THE MULTIPLE GESTATIONS -->***
     ***Stacie said: mnh24 is filled out for each infant so if there is a multiples birth and you have inf 1 and inf 2,     then they will each have their own MNH24 form***
     ***Stacie said to just do different merges for mom's forms and for infant forms***
     
```{r echo=FALSE}
# merged_df <- merged_df %>% 
#   mutate(NEO_DTH_1 = case_when(M09_BIRTH_DSTERM_INF1_6 ==2 ~ 0,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF1_6, units="days")<=28 ~1,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF1_6, units="days")>28 ~0,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  is.na(M24_DTHDAT) ~0,
#                                TRUE ~ as.integer(NA))) 
# 
# merged_df <- merged_df %>% 
#   mutate(NEO_DTH_2 = case_when(M09_BIRTH_DSTERM_INF2_6 ==2 ~ 0,
#                                M09_BIRTH_DSTERM_INF2_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF2_6, units="days")<=28 ~1,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF2_6, units="days")>28 ~0,
#                                M09_BIRTH_DSTERM_INF2_6 == 1 & 
#                                  is.na(M24_DTHDAT) ~0,
#                                TRUE ~ as.integer(NA))) 
# 
# merged_df <- merged_df %>% 
#   mutate(NEO_DTH_3 = case_when(M09_BIRTH_DSTERM_INF3_6 ==2 ~ 0,
#                                M09_BIRTH_DSTERM_INF3_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF3_6, units="days")<=28 ~1,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF3_6, units="days")>28 ~0,
#                                M09_BIRTH_DSTERM_INF3_6 == 1 & 
#                                  is.na(M24_DTHDAT) ~0,
#                                TRUE ~ as.integer(NA)))
# 
# merged_df <- merged_df %>% 
#   mutate(NEO_DTH_4 = case_when(M09_BIRTH_DSTERM_INF4_6 ==2 ~ 0,
#                                M09_BIRTH_DSTERM_INF4_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF4_6, units="days")<=28 ~1,
#                                M09_BIRTH_DSTERM_INF1_6 == 1 & 
#                                  difftime(M24_DTHDAT, M09_DELIV_DSSTDAT_INF4_6, units="days")>28 ~0,
#                                M09_BIRTH_DSTERM_INF4_6 == 1 & 
#                                  is.na(M24_DTHDAT) ~0,
#                                TRUE ~ as.integer(NA))) 
# temp.df <- merged_df %>% 
#   select(M09_BIRTH_DSTERM_INF1_6, M09_BIRTH_DSTERM_INF2_6, M09_BIRTH_DSTERM_INF3_6,
#          M09_DELIV_DSSTDAT_INF4_6, M24_DTHDAT, NEO_DTH_4)
# 
# temp.df <- merged_df %>% select(NEO_DTH_1, NEO_DTH_2, NEO_DTH_3, NEO_DTH_4)
#   
# merged_df <- merged_df %>% 
#   mutate(NEO_DTH = case_when((NEO_DTH_1 == 1 | NEO_DTH_2 == 1 | NEO_DTH_3 == 1 | NEO_DTH_4) == 1 ~ 1,
#                              (is.na(NEO_DTH_1) & is.na(NEO_DTH_2) & is.na(NEO_DTH_3) & is.na(NEO_DTH_4) ~ as.integer(NA)),
#                              TRUE ~ 0))
# 
# table(NEO_DTH = merged_df$NEO_DTH, useNA = "always")
  
```

*DONT NEED THIS CHUNCK FOR NOW. WAS WORKING TO SEE IF AT ANY VISIT HEMOGLOBIN LEVELS ARE AS NEEDED - THIS WAY EVERYONE TURNS OUT TO BE ANEMIC B/C AT LEAST ONE VISIT, IT'S LOW*
```{r}
  # mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & #at least 1 visit is non-missing 
  #                                       if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))  ~ 1,
  #                                    TRUE ~ 2)) %>% select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4,
  #                                                          M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2, 
  #                                                          M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, MAT_ANEMIA_MEAS)




# temp.df <- mat_inf_subset_df[1:20, ] %>%
#   select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
#          starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
#                        "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
#                        "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
#   mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & #at least 1 visit is non-missing 
#                                         if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))  ~ 1,
#                                      TRUE ~ 2)) %>% select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4,
#                                                            M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2, 
#                                                            M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, MAT_ANEMIA_MEAS)
# 
# temp.df <- mat_inf_subset_df[1:20, ] %>%
#   select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
#          starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES_", "M09_DELIV_DSSTDAT_INF",
#                        "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
#                        "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
#   
#   mutate(MAT_ANEMIA_MEAS1 = case_when((if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
#                                           if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))   ~ 1,
#                                      TRUE ~ 2)) %>% select(M08_TYPE_VISIT_1, M08_TYPE_VISIT_2, M08_TYPE_VISIT_3, M08_TYPE_VISIT_4,
#                                                            M08_CBC_HB_LBORRES_1, M08_CBC_HB_LBORRES_2, 
#                                                            M08_CBC_HB_LBORRES_3, M08_CBC_HB_LBORRES_4, MAT_ANEMIA_MEAS1)

```



```{r}
#TODO Pull out these columns and see what they look like. Atm all are 1. 
# temp.df <- mat_inf_subset_df %>% 
#   select((starts_with(c("M06_DIAG_VSDAT_", "M06_TYPE_VISIT_", "M06_HB_POC_LBORRES_", "M08_LBSTDAT_"))),
#          starts_with(c("M08_TYPE_VISIT_", "M08_CBC_HB_LBORRES", "M09_DELIV_DSSTDAT_INF",
#                        "M19_TIMING_OHOCAT_VISIT", "M19_CBC_LBDAT_VISIT", "M19_CBC_HB_LBORRES_VISIT",
#                        "M19_HB_POC_LBTSTDAT_VISIT", "M19_HB_POC_LBORRES_VISIT"))) %>%
#   
#   mutate(MAT_ANEMIA_MEAS = case_when((if_any(num_range('M06_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
#                                         if_any(num_range('M06_HB_POC_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
#                                        
#                                        (if_any(num_range('M08_TYPE_VISIT_', 1:4), ~ !is.na(.x)) & 
#                                           if_any(num_range('M08_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9))) |
#                                        
#                                        (if_any(num_range('M19_TIMING_OHOCAT_VISIT_', 1:3), ~ .==1) &
#                                           (if_any(num_range('M19_HB_POC_LBORRES_', 1:4), ~ between(.x,10,10.9)) |
#                                              
#                                              if_any(num_range('M19_CBC_HB_LBORRES_', 1:4), ~ between(.x, 10, 10.9)))) ~ 1,
#                                      TRUE ~ 2)) %>% 
#   select(M06_TYPE_VISIT_1, M06_TYPE_VISIT_2, M06_TYPE_VISIT_3, M06_TYPE_VISIT_4, 
#          M06_HB_POC_LBORRES_1, M06_HB_POC_LBORRES_2,M06_HB_POC_LBORRES_3, M06_HB_POC_LBORRES_4, 
#          MAT_ANEMIA_MEAS)
# 
# # Using library Purrr here
# # .x placeholder for each of the variable inside if_any. Can use just "." if it's not inside a function.
# # Lambda function used here = it's a little expression inside of something. It's not a function that's defined outside. 
# 
# table(mat_inf_subset_df$M19_TIMING_OHOCAT_VISIT3, useNA = "always")

```


