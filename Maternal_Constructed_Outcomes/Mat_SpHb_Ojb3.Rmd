---
title: "Mat_Sphb_Obj3"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

OBJECTIVE 3 RISK FACTORS TO ASSESS: 
●	Maternal age,
●	Study site,
●	Tobacco use,
●	Participant’s early pregnancy BMI (measured at first ANC visit),
●	Anemia severity stratum, 
●	Gestational age at assessment and at first ANC visit,
●	Time between SpHb collection and CBC collection,
●	Mid upper arm circumference (MUAC),
●	Nutritional status (e.g., iron deficiency),
●	Technician,
●	Estimated plasma volume (PV)  
●	HIV status (Zambia and Kenya sites only),
●	Malaria status (Kenya site only),
●	Helminth infection status (Kenya site only),


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, echo=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
library(haven)
library(lme4)
library(Matrix) # dependency for lme4
library(tableone)
# library(kableExtra)
library(equatiomatic) # for creating equations from models 
```

Import data: 
```{r}
path_to_data <-  'D:/Users/fouziafarooq/Documents/PRISMA_constructed-outcomes/data/2023-12-15/'# - for AWS data

UploadDate = "2023-12-15"
uploadDate <- as.Date(UploadDate, format = "%Y-%m-%d")
```

Pulling CSV files from AWS into a list:
```{r}
########################################################################################
recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
tic <- Sys.time()
if(recreate_mnh_list == TRUE){
  mnh_names <- c()
  list_mnh <- dir(path = path_to_data, pattern = "*.csv", full.names = TRUE) #creates a list of all the csv files in the directory
  for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
    form_name <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
    #basename() pulls out just the name of the file from the entire directory/path.
    print(paste("Reading", form_name))
    assign(form_name, read.csv(data_file))
    mnh_names <- c(mnh_names, form_name) # it's buidling up a vector of obj names.
  }
  save(list=mnh_names, file = paste0("MNH_dfs_", basename(path_to_data), ".RDS"))
} else{
  load(file = paste0('MNH_dfs_',  basename(path_to_data), ".RDS"))
}

toc <- Sys.time()
print(toc - tic)
```


### Hard code TYPE_VISIT for M00=1, M02=1, M03=1, M09=6, M10=6, M11=6, M17=6, M18=12 ***
```{r echo=FALSE}

if (exists("mnh00")) {
  mnh00 <- mnh00 %>% 
    mutate(M00_TYPE_VISIT = 1)
} else{
  "MNH00 dataframe doesn't exist"
}

if (exists("mnh01")) {
  mnh01 <- mnh01 %>% 
    mutate(M01_TYPE_VISIT = 1)
} else{
  "MNH01 dataframe doesn't exist"
}

if (exists("mnh02")) {
  mnh02 <- mnh02 %>% 
    mutate(M02_TYPE_VISIT = 1)
} else{
  "MNH02 dataframe doesn't exist"
}

if (exists("mnh03")) {
  mnh03 <- mnh03 %>% 
    mutate(M03_TYPE_VISIT = 1)
} else{
  "MNH03 dataframe doesn't exist"
}



if (exists("mnh09")) {
  mnh09 <- mnh09 %>% 
    mutate(M09_TYPE_VISIT = 6)
} else{
  "MNH09 dataframe doesn't exist"
}

if (exists("mnh10")) {
  mnh10 <- mnh10 %>% 
    mutate(M10_TYPE_VISIT = 6)
} else{
  "MNH10 dataframe doesn't exist"
}

if (exists("mnh11")) {
  mnh11 <- mnh11 %>% 
    mutate(M11_TYPE_VISIT = 6)
} else{
  "MNH11 dataframe doesn't exist"
}

if (exists("mnh16")) {
  mnh16 <- mnh16 %>% 
    mutate(M16_TYPE_VISIT = 5)
} else{
  "MNH16 dataframe doesn't exist"
}

if (exists("mnh17")) {
  mnh17 <- mnh17 %>% 
    mutate(M17_TYPE_VISIT = 6)
} else{
  "MNH17 dataframe doesn't exist"
}

if (exists("mnh18")) {
  mnh18 <- mnh18 %>% 
    mutate(M18_TYPE_VISIT = 12)
} else{
  "MNH18 dataframe doesn't exist"
}

if (exists("mnh19")) {
  mnh19 <- mnh19 %>% 
    mutate(M19_TYPE_VISIT = 13)
} else{
  "MNH19 dataframe doesn't exist"
}
```

Create a vector of women who are enrolled. 
```{r}
mnh02 <- mnh02 %>% 
  mutate(ENROLLED_FF = ifelse(M02_AGE_IEORRES==1 & M02_PC_IEORRES==1 & 
                                M02_CATCHMENT_IEORRES==1 & M02_CATCH_REMAIN_IEORRES==1 & 
                                M02_CONSENT_IEORRES==1, 1,0)) %>% filter(ENROLLED_FF ==1) # THIS DOES DROP SOME WOMEN!

unique <- mnh02 %>% group_by(SITE, PREGID) %>% unique()

enrolled_ids_vec <- as.vector(mnh02$PREGID)
```

Rename TYPE_VISIT variables:
```{r}
mnh01 <- mnh01 %>% rename(TYPE_VISIT = M01_TYPE_VISIT)
mnh02 <- mnh02 %>% rename(TYPE_VISIT = M02_TYPE_VISIT)
mnh03 <- mnh03 %>% rename(TYPE_VISIT = M03_TYPE_VISIT)
mnh04 <- mnh04 %>% rename(TYPE_VISIT = M04_TYPE_VISIT)
mnh05 <- mnh05 %>% rename(TYPE_VISIT = M05_TYPE_VISIT)
mnh06 <- mnh06 %>% rename(TYPE_VISIT = M06_TYPE_VISIT)
mnh08 <- mnh08 %>% rename(TYPE_VISIT = M08_TYPE_VISIT)
mnh12 <- mnh12 %>% rename(TYPE_VISIT = M12_TYPE_VISIT)
```

Clean up the data frames: 
```{r}

mnh01 <- mnh01 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)


mnh02 <- mnh02 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh03 <- mnh03 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh04 <- mnh04 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh06 <- mnh06 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh08 <- mnh08 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh12 <- mnh12 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)
```

Drop TYPE_VISIT in MNH02 and in MNH03 (b/c  TYPE_VISIT=1 for all)
```{r}
mnh01 <- mnh01 %>% select(-TYPE_VISIT)
mnh02 <- mnh02 %>% select(-TYPE_VISIT)
mnh03 <- mnh03 %>% select(-TYPE_VISIT)
```

SUBSETTING BEFORE MERGING
########### STOPPED HERE ########## I AM THINKING THAT I SHOULD JUST SUBSET THE VARS I NEED.  IT WILL BE EASIER TO CATCH MISTAKES IN MERGING. 

Vars needed: 
1. Maternal age, 
2. Study site,
3. Tobacco use,
4. Early pregnancy BMI
5. Estimated plasma volume
6. Mid upper arm circumference (MUAc)
7. Anemia severity stratum
8. Time between SpHb collection and CBC collection
9. GA at first ANC visit
10. Gestational age at assessment
11. Technician
12.Nutritional status (e.g. iron deficiency)
13. HIV status (Zambia, Kenya)
14. Helminth infection status (Kenya)

```{r}
######################
### MNH01 SUBSET ####
###         ####
######################
mnh01_subset <- mnh01 %>%
  select(SITE, MOMID, PREGID, M01_US_OHOSTDAT, M01_US_GA_WKS_AGE_FTS1, M01_US_GA_WKS_AGE_FTS2, 
         M01_US_GA_WKS_AGE_FTS3, M01_US_GA_WKS_AGE_FTS4, GA_US_DAYS_FTS1, 
         GA_US_DAYS_FTS2, GA_US_DAYS_FTS3, GA_US_DAYS_FTS4, M01_GA_LMP_WEEKS_SCORRES) 

######################
### MNH03 SUBSET ####
###      SES     ####
######################

mnh03_subset <- mnh03 %>%
  select(SITE, MOMID, PREGID, M03_SD_OBSSTDAT, M03_CHEW_OECOCCUR, M03_SMOKE_OECOCCUR, 
         M03_SMOKE_OECOCCUR, M03_CHEW_BNUT_OECOCCUR) 

###########################
### MNH04 SUBSET ####
### ANC CLINICAL STATUS ###
###########################

mnh04_subset <- mnh04 %>% 
  select(SITE, MOMID, PREGID, TYPE_VISIT, M04_ANC_OBSSTDAT, TYPE_VISIT, 
         # HIV diagnosis since last visit
         M04_HIV_MHOCCUR,
         M04_FOLIC_ACID_CMOCCUR, M04_IRON_ORAL_CMOCCUR, M04_IFA_CMOCCUR, M04_CALCIUM_CMOCCUR,
         M04_VITAMIN_A_CMOCCUR, M04_ZINC_CMOCCUR, M04_MICRONUTRIENT_CMOCCUR) # FOLIC ACID, IRON, IFA, CALCIUM, 
# vA, zINC, MULTIPLE MICRONUTRIENT SUPP (MMN). DID YOU RECEIVE ANY OF THESE AT THIS VISIT? 

######################
### MNH05 SUBSET ####
###  MAT ANTHRO   ###
######################
mnh05_subset <- mnh05 %>% 
  select(SITE, MOMID, PREGID, M05_ANT_PEDAT, TYPE_VISIT, M05_WEIGHT_PERES, M05_HEIGHT_PERES, M05_MUAC_PERES)

##########################
###    MNH06 SUBSET   ###
###   MAT POC DIAG.   ###
##########################
mnh06_subset <- mnh06 %>% 
  select(SITE, MOMID, PREGID, TYPE_VISIT, M06_DIAG_VSDAT, 
         #Form completion Date, Time, Person ID
         M06_FORMCOMPLDAT_MNH06, M06_FORMCOMPLTIM_MNH06, M06_FORMCOMPLID_MNH06, 
         M06_SPHB_LBORRES, M06_HB_POC_LBORRES, # first one is Masimo, POC is point of care Hemocue test. 
         # Malaria, HIV, Helminth
         M06_MALARIA_POC_LBORRES, M06_HIV_POC_LBORRES, 
         # HIV POC
         M06_HIV_POC_LBORRES)

##########################
###    MNH08 SUBSET   ###
###     MAT LABS      ###
##########################
mnh08_subset <- mnh08 %>% 
  select(SITE, MOMID, PREGID, TYPE_VISIT, M08_LBSTDAT,
         #  and Hemoglobin
          M08_CBC_HB_LBORRES, 
         # Hematocrit
         M08_CBC_HCT_LBORRES,
         # Person ID
         M08_FORMCOMPLID_MNH08,
         # Helminth test results
         M08_HELM_LBORRES,
         # Malaria test results
         M08_MALBL_LBORRES)

##########################
###    MNH12 SUBSET   ###
###    MAT PNC Labs   ###
##########################
mnh12_subset <- mnh12 %>% 
  select(SITE, MOMID, PREGID, TYPE_VISIT, M12_VISIT_OBSSTDAT)
```

1. Arranging Based on Dates and Scheduled/Unscheduled visits:
This I might have to do for each MNH that is included.  FOr this analysis, I need MNH08 and MNH06 for now.  No need to worry about organizing other ones for now. 
```{r}
# mnh08_temp
mnh08_subset <- mnh08_subset %>% 
  # select(MOMID, PREGID, SITE, M08_LBSTDAT, TYPE_VISIT) %>%
 # filter(SITE=="Pakistan") %>%
  group_by(MOMID, PREGID) %>%
  arrange(M08_LBSTDAT) %>%
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M08_LBSTDAT)

temp_df <- mnh08_subset %>% select(SITE, MOMID, PREGID, M08_LBSTDAT, TYPE_VISIT) %>% 
  group_by(SITE, MOMID, PREGID)
temp_df <- mnh08_subset %>% select(SITE, MOMID, PREGID, M08_LBSTDAT, TYPE_VISIT, scheduled, visit_seq, prior_scheduled_visit_type, next_scheduled_visit_type) %>% 
  filter(TYPE_VISIT %in% c(13, 14))
```

Arrange Scheduled/Unscheduled visits for MNH04:
```{r}
mnh04_subset <- mnh04_subset %>% 
  group_by(MOMID, PREGID) %>%
  arrange(M04_ANC_OBSSTDAT) %>% # DATE OF VISIT
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M04_ANC_OBSSTDAT)
```

Arrange Scheduled/Unscheduled visits for MNH06:
```{r}
mnh06_subset <- mnh06_subset %>% 
  group_by(MOMID, PREGID) %>%
  arrange(M06_DIAG_VSDAT) %>%
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M06_DIAG_VSDAT)
```

Arrange Scheduled/Unscheduled visits for MNH12: - MNH12 IS FOR PNC VISITS
```{r}
mnh12_subset <- mnh12_subset %>% 
  group_by(MOMID, PREGID) %>%
  arrange(M12_VISIT_OBSSTDAT) %>%
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M12_VISIT_OBSSTDAT)
```


MERGED MNH02 AND MNH03 FIRST:
```{r}
mnh02_03 <- left_join(mnh02, mnh03_subset,by = c("SITE", "MOMID", "PREGID"))
```

Merge MNH02_03, MNH00, MNH04, MNH05, MNH08, MNH06 together: 
***STILL NEED TO MERGE IN MNH12***
```{r}
merged_df <- left_join(mnh02_03, mnh00, 
                       by = c("SITE", "SCRNID"))

merged_df2 <- left_join(merged_df, mnh04_subset, 
                        by = c("SITE", "MOMID", "PREGID"))

merged_df2 <- left_join(merged_df2, mnh05_subset, 
                        by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT"))

merged_df3 <- full_join(merged_df2, mnh08_subset, 
                        by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT", 
                               "scheduled", "visit_seq", 
                               "prior_scheduled_visit_type", "next_scheduled_visit_type"))

mnh06_subset <- mnh06_subset %>% select(-scheduled, -visit_seq, 
                               -prior_scheduled_visit_type, -next_scheduled_visit_type)

# NOTE: Doing a full join here to add in mnh06.
merged_df4 <- full_join(merged_df3, mnh06_subset, 
                        by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT"))

temp.df <- merged_df4 %>% select(SITE, MOMID, PREGID, TYPE_VISIT, M06_DIAG_VSDAT, M08_LBSTDAT, 
                                 scheduled, visit_seq, 
                                 prior_scheduled_visit_type, next_scheduled_visit_type, 
                                 M08_CBC_HCT_LBORRES, M08_CBC_HB_LBORRES,
                                 # Person ID
                                 M08_FORMCOMPLID_MNH08,
                                 # Helminth test results
                                 M08_HELM_LBORRES,
                                 # Malaria test results
                                 M08_MALBL_LBORRES, 
                                 
                                 #Form completion Date, Time, Person ID
                                 M06_FORMCOMPLDAT_MNH06, M06_FORMCOMPLTIM_MNH06, M06_FORMCOMPLID_MNH06, 
                                 M06_SPHB_LBORRES,
                                 # Malaria, HIV, Helminth
                                 M06_MALARIA_POC_LBORRES, M06_HIV_POC_LBORRES, 
                                 # HIV POC
                                 M06_HIV_POC_LBORRES) 

temp.df <- merged_df4 %>% select(SITE, MOMID, PREGID, TYPE_VISIT, M08_LBSTDAT, M02_SCRN_OBSSTDAT, M06_DIAG_VSDAT, 
                                  M06_SPHB_LBORRES, 
                                 scheduled, visit_seq,
                                 prior_scheduled_visit_type,next_scheduled_visit_type) %>% 
  filter(MOMID == 'AZ-4173')

# NOTE: Should i keep this as a left join? 
merged_df5 <- left_join(merged_df4, mnh12_subset,
                        by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT"))

temp.df <- merged_df4 %>% filter(SITE =="Zambia") %>% 
  select(MOMID, PREGID, TYPE_VISIT, M06_FORMCOMPLDAT_MNH06, M06_FORMCOMPLTIM_MNH06, M06_FORMCOMPLID_MNH06)
```


Count number of participants who have completed week 6 postpartum (VISIT 10)
```{r}

merged_df5 <- merged_df5 %>%
  filter(SITE %in% c("Pakistan", "Kenya", "Zambia"))



participant_count <- merged_df5 %>% 
  filter(TYPE_VISIT==10) %>% 
  group_by(SITE) %>%
  distinct(MOMID) %>%
  summarise(total_count_6wkPP = n())
 # summarise(count = n_distinct(MOMID))
```

```{r}
#Since I only am doing analysis on a few time points (<20, 20, 28, 36 and 6 wk PP (only Pak had week 32 data also)) --> I can just filter this first. 
# For now, I can leave UNSCHEDULED VISITS out.

merged_df5 <- merged_df5 %>% filter(TYPE_VISIT %in% c(1,2,3,5,10))
temp_df <- merged_df5 %>% select(SITE, MOMID, TYPE_VISIT, M06_SPHB_LBORRES, M08_CBC_HB_LBORRES)
```

First do some crosstabs: 
```{r}
# Group by 'SITE' and count occurrences for each measurement variable
# This is the total number of observations across all 5 time points 
hb_counts <- merged_df5 %>%
  group_by(SITE, TYPE_VISIT) %>%
  summarize(SPHB_N = sum(!is.na(M06_SPHB_LBORRES)), 
                         CBC_N = sum(!is.na(M08_CBC_HB_LBORRES))
  )
```


Set all -7, 77, -5, 55, etc to NA
```{r echo=FALSE}
CONVERT_NA <- TRUE
if(CONVERT_NA ==TRUE){
  tic <- Sys.time()
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1907-07-07", NA, d)
    })
  
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==-7, NA, d)
    })
  
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==77, NA, d)
    })
  
  # -5 IS MISSING FOR CONTINUOUS
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==-5, NA, d) 
    })
  
  # 55 IS MISSING FOR CATEGORICAL
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==55, NA, d) 
    })
  
  # 55:55 IS MISSING FOR TIME
  merged_df5 <- merged_df5 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d=='55:55', NA, d)
    })
  
  toc <- Sys.time()
}
time_diff <- toc-tic
time_diff
```

Compute difference between SphB and CBC at each time point
```{r}
merged_df5 <- merged_df5 %>% 
  mutate(diff_hb = M06_SPHB_LBORRES - M08_CBC_HB_LBORRES)

temp.df <- merged_df5 %>% select(SITE, MOMID, TYPE_VISIT, M06_SPHB_LBORRES, M08_CBC_HB_LBORRES, diff_hb)
```

FACTORIZE TYPE_VISIT VARIABLE:
```{r}
merged_df5$TYPE_VISIT <- factor(merged_df5$TYPE_VISIT)
merged_df5$TYPE_VISIT <- relevel(merged_df5$TYPE_VISIT, ref = "1")
levels(merged_df5$TYPE_VISIT)
```

COMPUTE MATERNAL AGE CATEGORIES:
```{r}
merged_df5$M00_BRTHDAT <- as.Date(merged_df5$M00_BRTHDAT)
merged_df5$M02_SCRN_OBSSTDAT <- as.Date(merged_df5$M02_SCRN_OBSSTDAT)

#Age
merged_df5 <- merged_df5 %>% 
  mutate(
    mom_age_enroll = if_else(
      (!is.na(M02_SCRN_OBSSTDAT) & !is.na(M00_BRTHDAT)), ((as.numeric(M02_SCRN_OBSSTDAT) - as.numeric(M00_BRTHDAT)) %/% 365),
      if_else(!is.na(M00_ESTIMATED_AGE), M00_ESTIMATED_AGE, as.numeric(NA))))

merged_df5 <- merged_df5 %>% 
  mutate(
    #age below 18
    age_lt_18 = case_when(
      mom_age_enroll > 0 & mom_age_enroll < 18 ~ 1, 
      mom_age_enroll >= 18 ~ 0,
      TRUE ~ NA_real_
    ))

temp.df <- merged_df5 %>% select(SITE, MOMID, M02_SCRN_OBSSTDAT, M00_BRTHDAT, M00_ESTIMATED_AGE, mom_age_enroll, age_lt_18)
```


***TOBACCO USE:***
```{r}
# Do you smoke cig: M03_SMOKE_OECOCCUR
# In the last month, did you chew tobacco: M03_CHEW_OECOCCUR
# In the last month, did you chew betel nut: M03_CHEW_BNUT_OECOCCUR

table(merged_df5$M03_SMOKE_OECOCCUR, useNA = "always")
table(merged_df5$M03_CHEW_OECOCCUR, useNA = "always")
table(merged_df5$M03_CHEW_BNUT_OECOCCUR, useNA = "always")

merged_df5 <- merged_df5 %>% 
  mutate(tobacco_use = case_when((!is.na(M03_SMOKE_OECOCCUR) &  M03_SMOKE_OECOCCUR==1) | 
                                    (!is.na(M03_CHEW_OECOCCUR) & M03_CHEW_OECOCCUR==1) | 
                                    (!is.na(M03_CHEW_BNUT_OECOCCUR) & M03_CHEW_BNUT_OECOCCUR==1) ~ 1,
                                 
                                 ((!is.na(M03_SMOKE_OECOCCUR) & M03_SMOKE_OECOCCUR==0) & 
                                    (!is.na(M03_CHEW_OECOCCUR) & M03_CHEW_OECOCCUR==0) & 
                                    (!is.na(M03_CHEW_BNUT_OECOCCUR) & M03_CHEW_BNUT_OECOCCUR==0)) ~ 0,
                                 
                                 TRUE ~ as.numeric(NA)))
    
temp.df <- merged_df5 %>% select(SITE, MOMID, PREGID, 
                                 M03_SMOKE_OECOCCUR, M03_CHEW_OECOCCUR, M03_CHEW_BNUT_OECOCCUR, tobacco_use)

table(merged_df5$tobacco_use, useNA = "always")

merged_df5$tobacco_use <- factor(merged_df5$tobacco_use)
levels(merged_df5$tobacco_use)
merged_df5$tobacco_use <- relevel(merged_df5$tobacco_use, ref="0")

```

CALCULATE BMI:
```{r}
merged_df5 <- merged_df5 %>% 
  group_by(MOMID) %>%
  mutate(mat_bmi_enroll = ifelse(
    TYPE_VISIT==1,
    ifelse(complete.cases(M05_WEIGHT_PERES, M05_HEIGHT_PERES),
           (M05_WEIGHT_PERES/((M05_HEIGHT_PERES/100)^2)), 
           as.numeric(NA)),
    NA_real_ # Default value if TYPE_VISIT!=1
    ))

merged_df5 <- merged_df5 %>%
  mutate(bmi_enroll_cat = case_when(
      mat_bmi_enroll < 18.5 ~ 1, #UNDERWEIGHT
      mat_bmi_enroll >= 18.5 & mat_bmi_enroll < 25 ~ 2, # NORMAL WEIGHT
      mat_bmi_enroll >= 25 & mat_bmi_enroll < 30 ~ 3, # OVERWEIGHT
      mat_bmi_enroll >= 30 ~ 4, # OBESE
      TRUE ~ NA_real_ # DEFAULT VALUE 
      ))


table(merged_df5$bmi_enroll_cat)
merged_df5$bmi_enroll_cat <- factor(merged_df5$bmi_enroll_cat)
str(merged_df5$bmi_enroll_cat)
merged_df5$bmi_enroll_cat <- relevel(merged_df5$bmi_enroll_cat, ref = "2")
temp.df <- merged_df5 %>% 
  select(SITE, MOMID, TYPE_VISIT, M05_WEIGHT_PERES, M05_HEIGHT_PERES, mat_bmi_enroll, bmi_enroll_cat)

temp.df <- merged_df5 %>% filter(MOMID == 'AA-4424') %>% select(SITE, MOMID, TYPE_VISIT, M05_WEIGHT_PERES, M05_HEIGHT_PERES, mat_bmi_enroll)
```

MID UPPER ARM CIRCUMFERENCE (MUAC) - proxy for BMI in pregnancy
HAVE MUAC MEASUREMENTS AT EACH TIMEPOINT. 
```{r}
# Normal/healthy MUAC >23
#TODO I am looking at this at every time point currently, should this be done just at enrollment? 
merged_df5 <- merged_df5 %>%
  mutate(MUAC = ifelse(M05_MUAC_PERES <= 23, 0,
                       ifelse(M05_MUAC_PERES > 23, 1, as.numeric(NA))
    ))

merged_df5$MUAC <- factor(merged_df5$MUAC)
levels(merged_df5$MUAC)
table(merged_df5$MUAC, useNA = "always")
merged_df5$MUAC <- relevel(merged_df5$MUAC, ref = "0")

temp.df <- merged_df5 %>% select(SITE, MOMID, TYPE_VISIT, M05_MUAC_PERES, MUAC)
```

***PLASMA EXPANSION VOLUME***

Kaplan-Hakim formula:
PV (cPV) = (1-hematocrit)*[a +(b*weight in kg)] 
a=1,530 in males; a=864 in females
b=41 in males; b=47.9 in females
```{r}
merged_df5$pv_a <- 864 # a=1,530 in males; a=864 in females
merged_df5$pv_b <- 47.9 # b=41 in males; b=47.9 in females

merged_df5 <- merged_df5 %>% 
  mutate(PV = (1-(M08_CBC_HCT_LBORRES/100))*(pv_a + (pv_b * M05_WEIGHT_PERES)) # Hematocrit is a percentage. Weight in KG
    )

temp.df <- merged_df5 %>% select(SITE, MOMID, TYPE_VISIT, M08_CBC_HCT_LBORRES, M05_WEIGHT_PERES, PV)
```


***NUTRITIONAL STATUS***
```{r}
merged_df5$M04_IRON_ORAL_CMOCCUR
```

*********************************
********************************
*********************************
***ANEMIA STATUS***

Create anemia levels for each ANC Visit
WHO Hb thresholds g/dl:
Mild: 10.0-10.9
Moderate: 7.0-9.9
Severe: <7
Normal: >=11.0
Excess Hb: >13

NOTE: all the visits can have the same definition since this is long data. 
```{r}

# NOTE: That I am using the same threshold for all the time points. 
merged_df5 <- merged_df5 %>% 
  mutate(MAT_ANEMIA_MEAS= case_when((!is.na(M08_CBC_HB_LBORRES) & 
                                        M08_CBC_HB_LBORRES>=10 & M08_CBC_HB_LBORRES<11) ~ "mild",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                        M06_HB_POC_LBORRES>=10 & M06_HB_POC_LBORRES<11) ~ "mild",
                                      
                                      (!is.na(M08_CBC_HB_LBORRES) & 
                                        M08_CBC_HB_LBORRES>=7 & M08_CBC_HB_LBORRES<10) ~ "moderate",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                        M06_HB_POC_LBORRES>=7 & M06_HB_POC_LBORRES<10) ~ "moderate",
                                      
                                      (!is.na(M08_CBC_HB_LBORRES) & 
                                        M08_CBC_HB_LBORRES>=0 & M08_CBC_HB_LBORRES<7) ~ "severe",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                        M06_HB_POC_LBORRES>=0 & M06_HB_POC_LBORRES<7) ~ "severe",
                                      
                                      (!is.na(M08_CBC_HB_LBORRES) & 
                                        M08_CBC_HB_LBORRES>=11 & M08_CBC_HB_LBORRES<=13) ~ "normal",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                        M06_HB_POC_LBORRES>=11 & M06_HB_POC_LBORRES<=13) ~ "normal",
                                      
                                      (!is.na(M08_CBC_HB_LBORRES) & 
                                        M08_CBC_HB_LBORRES>13 & M08_CBC_HB_LBORRES<15) ~ "high hb 13-<15g/dl",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                        M06_HB_POC_LBORRES>13 & M06_HB_POC_LBORRES<15) ~ "high hb 13-<15g/dl",
                                      
                                      (!is.na(M08_CBC_HB_LBORRES) & M08_CBC_HB_LBORRES>=15)  ~ "high hb >=15g/dl",
                                      (is.na(M08_CBC_HB_LBORRES) & !is.na(M06_HB_POC_LBORRES) & 
                                      M06_HB_POC_LBORRES>=15) ~ "high hb >=15g/dl",
                                      
                                      TRUE ~ as.character(NA)))



temp.df <- merged_df5 %>% 
  select(MOMID, SITE, TYPE_VISIT, MAT_ANEMIA_MEAS, M08_CBC_HB_LBORRES, M06_HB_POC_LBORRES)

sum(merged_df5$M08_CBC_HB_LBORRES %in% c(-5, -7))

table(MAT_ANEMIA_MEAS = merged_df5$MAT_ANEMIA_MEAS, useNA = "always", SITE = merged_df5$SITE)
round(prop.table(table(merged_df5$MAT_ANEMIA_MEAS, useNA = "always", merged_df5$SITE), margin=2)*100,2) 


merged_df5 <- merged_df5 %>%
  mutate(HIGH_HB_gt15 = case_when(MAT_ANEMIA_MEAS=="high hb >=15g/dl" ~ 1, TRUE ~0))

merged_df5$MAT_ANEMIA_MEAS <- factor(merged_df5$MAT_ANEMIA_MEAS) 
merged_df5$MAT_ANEMIA_MEAS <- relevel(merged_df5$MAT_ANEMIA_MEAS, ref="normal")
str(merged_df5$MAT_ANEMIA_MEAS)
```

*********************************************************
*********************************************************
*********************************************************
***GESTATIONAL AGE AT ASSESSMENT AT AT FIRST ANC VISIT***
*********************************************************
*********************************************************
*********************************************************

# CREATE BOE AND EDD_BOE (BOE = just at enrollment)
```{r}
merged_df5 <- merged_df5 %>%
  mutate(M01_US_OHOSTDAT = ymd(M01_US_OHOSTDAT))

# momid <- mnh02_df %>% select(MOMID, SCRNID, PREGID, SITE)
# mnh01_constructed_df <- left_join()
mnh01_constructed_df <- mnh01_df %>%
  # only want participants who are enrolled
  filter(PREGID %in% enrolled_ids_vec) %>% 
  
  ## only want the first ultrasound visit -- take the earliest date for each participant
  # group_by(SITE, MOMID, PREGID) %>%
  # arrange(M01_US_OHOSTDAT) %>%
  # slice(1) %>%
  # filter(M01_TYPE_VISIT == 1) %>% 
  # select a subset of variables
  
  # select(SITE, MOMID,PREGID, M01_US_OHOSTDAT_1,
  #        M01_US_GA_WKS_AGE_FTS1_1, M01_US_GA_WKS_AGE_FTS2_1,
  #        M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_WKS_AGE_FTS4_1,
  #        M01_US_GA_DAYS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS2_1,
  #        M01_US_GA_DAYS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS4_1,
  #        M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1) 
  
  mutate(M01_US_OHOSTDAT_1 = ymd(M01_US_OHOSTDAT_1)) %>%
  

  # filter out any ultrasound visit dates that are 07-07-1907
  filter(M01_US_OHOSTDAT_1 != ymd("1907-07-07")) %>%   
  # calculate us ga in days with reported ga in wks + days. if ga is -7 or -5, replace with NA
  mutate(GA_US_DAYS_FTS1_1 =  ifelse(M01_US_GA_WKS_AGE_FTS1_1!= -7 & M01_US_GA_DAYS_AGE_FTS1_1 != -7 & M01_US_GA_WKS_AGE_FTS1_1 != -5 & M01_US_GA_DAYS_AGE_FTS1_1 != -5,  (M01_US_GA_WKS_AGE_FTS1_1 * 7 + M01_US_GA_DAYS_AGE_FTS1_1), NA), 
         GA_US_DAYS_FTS2_1 =  ifelse(M01_US_GA_WKS_AGE_FTS2_1!= -7 & M01_US_GA_DAYS_AGE_FTS2_1 != -7 & M01_US_GA_WKS_AGE_FTS2_1 != -5 & M01_US_GA_WKS_AGE_FTS2_1 != -5,  (M01_US_GA_WKS_AGE_FTS2_1 * 7 + M01_US_GA_DAYS_AGE_FTS2_1), NA),
         GA_US_DAYS_FTS3_1 =  ifelse(M01_US_GA_WKS_AGE_FTS3_1!= -7 & M01_US_GA_DAYS_AGE_FTS3_1 != -7 & M01_US_GA_WKS_AGE_FTS3_1 != -5 & M01_US_GA_WKS_AGE_FTS3_1 != -5,  (M01_US_GA_WKS_AGE_FTS3_1 * 7 + M01_US_GA_DAYS_AGE_FTS3_1), NA),
         GA_US_DAYS_FTS4_1 =  ifelse(M01_US_GA_WKS_AGE_FTS4_1!= -7 & M01_US_GA_DAYS_AGE_FTS4_1 != -7 & M01_US_GA_WKS_AGE_FTS4_1 != -5 & M01_US_GA_WKS_AGE_FTS4_1 != -5,  (M01_US_GA_WKS_AGE_FTS4_1 * 7 + M01_US_GA_DAYS_AGE_FTS4_1), NA)) %>% 
  #  pull the largest GA for multiple fetuses + convert to weeks
  mutate(US_GA_DAYS = pmax(GA_US_DAYS_FTS1_1, GA_US_DAYS_FTS2_1, GA_US_DAYS_FTS3_1, GA_US_DAYS_FTS4_1, na.rm = TRUE)) %>% ## where GA_US_DAYS_FTSx is the reported GA by ultrasound (added together M01_US_GA_WKS_AGE_FTSx and M01_US_GA_DAYS_AGE_FTSx to get a single estimate in days)
  mutate(US_GA_WKS = floor(US_GA_DAYS/7)) %>% 
  #  convert ga by LMP to days and wks
  # on US meaturement for all 4 babies. 
  # For LMP we just have info on one baby.
  mutate(LMP_GA_DAYS =  ifelse(M01_GA_LMP_WEEKS_SCORRES_1 != -7 & M01_GA_LMP_DAYS_SCORRES_1 != -7,  (M01_GA_LMP_WEEKS_SCORRES_1 * 7 + M01_GA_LMP_DAYS_SCORRES_1), NA)) %>% 
  mutate(LMP_GA_WKS = floor(LMP_GA_DAYS/7)) %>%
  ## generate indicator variable for missing US 
  mutate(MISSING_BOTH_US_LMP = ifelse((US_GA_WKS < 0 & LMP_GA_WKS < 0) | 
                                        (is.na(US_GA_WKS) & is.na(LMP_GA_WKS)), 1, 0)) %>% 
  #  calculate the difference in days between reported LMP and reported US
  mutate(GA_DIFF_DAYS = LMP_GA_DAYS-US_GA_DAYS) %>%
  #  obtain best obstetric estimate in weeks
  mutate(BOE_GA_WKS = case_when(LMP_GA_WKS %/% 7 < 9 ~
                                  if_else(abs(GA_DIFF_DAYS) <= 5,
                                          LMP_GA_WKS,
                                          US_GA_WKS),
                                LMP_GA_WKS %/% 7 < 16 ~
                                  if_else(abs(GA_DIFF_DAYS) <=7,
                                          LMP_GA_WKS, US_GA_WKS),
                                LMP_GA_WKS %/% 7 >= 16 ~
                                  if_else(abs(GA_DIFF_DAYS) <=10,
                                          LMP_GA_WKS, US_GA_WKS),
                                TRUE ~ US_GA_WKS)) %>%
  mutate(BOE_GA_DAYS = BOE_GA_WKS*7) %>%
 
   # generate indicator variable if LMP or US was used (where 1 = US and 2 = LMP)
  mutate(BOE_METHOD = ifelse(BOE_GA_WKS == US_GA_WKS, 1, 
                             ifelse(BOE_GA_WKS == LMP_GA_WKS, 2, 55))) %>%
 
   # generate EDD_BOE based on BOE 
  # "zero out" GA and obtain the estimated "date of conception" 
  mutate(EST_CONCEP_DATE = M01_US_OHOSTDAT_1 - BOE_GA_DAYS) %>% 
  # add 280 days to EST_CONCEP_DATE to generate EDD based on BOE 
  mutate(EDD_BOE = EST_CONCEP_DATE + 280)

mnh01_constructed_df2 <- mnh01_constructed_df %>%
  select(MOMID, PREGID, SITE, 
         GA_US_DAYS_FTS1_1, GA_US_DAYS_FTS2_1, GA_US_DAYS_FTS3_1, GA_US_DAYS_FTS4_1,
         US_GA_DAYS, US_GA_WKS, LMP_GA_DAYS, LMP_GA_WKS, MISSING_BOTH_US_LMP, GA_DIFF_DAYS, 
         BOE_GA_WKS, BOE_GA_DAYS, BOE_METHOD, US_GA_DAYS,
         EST_CONCEP_DATE, EDD_BOE)
```

# MERGED EST CONCEPTION DATE, EDD_BOE, BOE_GA vars here with merged_df5
```{r}
merged_df5 <- left_join(merged_df5, mnh01_constructed_df2, 
                       by = c("MOMID", "SITE", "PREGID"))
```

# GA AT ENROLLMENT
```{r}
# EXTRACT GA AT ENROLLMENT:
# CREATE MERGED FILE FIRST. 
merged_df5 <- merged_df5 %>%
  rowwise() %>%
  mutate(DIFFDAYS = as.numeric(difftime(M02_SCRN_OBSSTDAT_1, M01_US_OHOSTDAT_1, units = "days"))) %>% # EXTRACT THE DIFFERENCE IN NUM OF DAYS B/W SCREENING US AND ENROLLMENT VISIT
  # MNH02 is being used as definitive enrollment. 
  # MNH01 visit 1 is when US is done. 
  mutate(DIFFDAYS = ifelse(DIFFDAYS < 0,0,DIFFDAYS)) %>% #IF THE DIFF IS NEG, REPLACE WITH 0 (JUST USE DATE OF ULTRASOUND SCREENING)
   mutate(GA_ENROLL_WKS = floor(as.numeric((DIFFDAYS + US_GA_DAYS)/7)), #TODO Stacie had this as GA_US_DAYS_1
         GA_ENROLL_DAYS = floor(as.numeric(DIFFDAYS + US_GA_DAYS))) #TODO Stacie had this as GA_US_DAYS_1

#TODO STACIE SAID SHE USED GA_US_DAYS IN THE MONITORING REPORT AND IN MATERNAL_WIDE FILE HAS US_GA_DAYS - SAME THING

  # mutate(GA_ENROLL_WKS = floor(as.numeric((DIFFDAYS + GA_US_DAYS_1)/7)), #TODO Stacie had this as GA_US_DAYS_1
  #        GA_ENROLL_DAYS = floor(as.numeric(DIFFDAYS + GA_US_DAYS_1))) #TODO Stacie had this as GA_US_DAYS_1

```

***TIME BETWEEN SPHB AND CBC COLLECTION***
```{r}
# M06_FORMCOMPLTIM_MNH06
# Do we have a time in MNH08? 
```

*********************************
********************************
*********************************

************************
******* FIGURES ********
************************
```{r}
ggplot(data = merged_df5) +
  geom_point(aes(x=M08_CBC_HB_LBORRES, y=M06_SPHB_LBORRES, 
                 color=SITE), 
             alpha = 0.4, size=1) + 
  geom_abline(slope = 1) +
  ylim(6,17) +
  xlim(7,17)

ggplot(data = merged_df5) +
  geom_hex(aes(x=M08_CBC_HB_LBORRES, y=M06_SPHB_LBORRES)) + 
  geom_abline(slope = 1) +
  ylim(0,25)
```

```{r}
mean_hb <- merged_df5 %>%
  group_by(TYPE_VISIT, SITE) %>%
  summarise(mean_cbc = mean(M08_CBC_HB_LBORRES, na.rm=TRUE),
            mean_sphb = mean(M06_SPHB_LBORRES, na.rm=TRUE))
```

```{r}
typevisit_analysis <- merged_df5 %>% 
  mutate(cbc_bin = cut(M08_CBC_HB_LBORRES, breaks = seq(0,23, by = 0.5)))

table(typevisit_analysis$cbc_bin)

mean_cbc_bin <- typevisit_analysis %>%
  group_by(cbc_bin) %>%
  summarise(mean_diff = mean(M06_SPHB_LBORRES - M08_CBC_HB_LBORRES, na.rm=TRUE))
```

Box Plots:
```{r}
# CBC: 
merged_df5 %>% ggplot() +
  geom_boxplot(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES)) + 
  geom_point(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES), alpha=0.2) + 
    theme_bw() +
  ylim(0,25)
  
# Stratified by site
merged_df5 %>% ggplot() +
  geom_boxplot(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES)) + 
  geom_point(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES), alpha=0.2) + 
    theme_bw() +
  ylim(0,25) + 
  facet_grid(vars(SITE), scales = "free") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  theme(legend.position = "right") 


#######################################

# SpHB:
merged_df5 %>% ggplot() +
  geom_boxplot(aes(x=TYPE_VISIT, y = M06_SPHB_LBORRES)) + 
  geom_point(aes(x=TYPE_VISIT, y = M06_SPHB_LBORRES), alpha=0.2) +
  ylim(5,20)

# Stratified by Site
merged_df5 %>% ggplot() +
  geom_boxplot(aes(x=TYPE_VISIT, y = M06_SPHB_LBORRES)) + 
  geom_point(aes(x=TYPE_VISIT, y = M06_SPHB_LBORRES), alpha=0.2) +
  ylim(5,20) +
  theme_bw() +
  facet_grid(vars(SITE), scales = "free") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  theme(legend.position = "right") 
```

************************
******* MODELS ********
************************

Linear Mixed Modeling
# Specify random intercepts for MOMID and SITE (allows for individual variations withing MOMID and different intercepts for each SITE)
```{r}
# IMPACT OF TYPE_VISIT - I DON'T THINK THIS MODEL MAKES SENSE. 
# mixed_model <- lmer(diff_hb ~ TYPE_VISIT + (1 | MOMID) + (1 | SITE), data = merged_df5)

# IMPACT OF SITE: 
mixed_model <- lmer(diff_hb ~ (1| SITE) + (1 | MOMID), data = merged_df5)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)
extract_eq(mixed_model)
```

MATERNAL AGE < 18 OR >=18
```{r}
# IMPACT OF MATERNAL AGE: 
mixed_model <- lmer(diff_hb ~ age_lt_18 + (1 | MOMID) + (1 | SITE), data = merged_df5)


# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)


extract_eq(mixed_model)
```

***TOBACCO USE:***
```{r}
# IMPACT OF Tobacco use: 
mixed_model <- lmer(diff_hb ~ tobacco_use + (1 | MOMID) + (1 | SITE), data = merged_df5)


# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)


extract_eq(mixed_model)
```

BMI: 
```{r}
# IMPACT OF MATERNAL BMI AT ENROLLMENT: 
mixed_model <- lmer(diff_hb ~ bmi_enroll_cat + (1 | MOMID) + (1 | SITE), data = merged_df5)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
print(round(results, 3))


extract_eq(mixed_model)

```

```{r}
# IMPACT OF MATERNAL MUAC
mixed_model <- lmer(diff_hb ~ MUAC + (1 | MOMID) + (1 | SITE), data = merged_df5)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)

extract_eq(mixed_model)
```

STANDARDIZING PV FIRST: 
```{r}
# Qing comment: 
# The PV coefficient is 0.001058 with a SE on the scale of e-5. It is very small in the mixed model below.
# Try standardized PV instead (center at 0 with variance=1)? The interpretation would be for one SD change in PV values.

# This new variable will now have a mean of 0 and variance of 1.
merged_df5$PV_standardized <- scale(merged_df5$PV)
# merged_df5$PV_standardized

```

```{r}
# IMPACT OF MATERNAL PLASMA EXPANSION VOLUME: 
mixed_model <- lmer(diff_hb ~ PV + (1 | MOMID) + (1 | SITE), data = merged_df5)

# STANDARDIZED PV
mixed_model <- lmer(diff_hb ~ PV_standardized + (1 | MOMID) + (1 | SITE), data = merged_df5)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))
SE
# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)

extract_eq(mixed_model)
```

PV ggplot:
```{r}
ggplot(merged_df5, aes(x=PV)) +
  geom_histogram(color="lightblue")+
  geom_density(color="darkblue", size=1) +
  labs(title = "Distribution of Plasma Expansion Volume across all 3 sites", x= "PV", Y = "Density")
  

ggplot(merged_df5, aes(x=PV)) +
  geom_histogram(color="lightblue")+
  geom_density(color="darkblue", size=1) +
  labs(title = "Distribution of Plasma Expansion Volume per site", x= "PV", Y = "Density") + 
  theme_bw() +
  ylim(0,750) + 
  facet_grid(vars(SITE), scales = "free") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) + 
  theme(legend.position = "right") 

```

***ANEMIA SEVERITY***
```{r}

# IMPACT OF MATERNAL ANEMIA SEVERITY ACROSS 5 TIMEPOINTS: 
mixed_model <- lmer(diff_hb ~ MAT_ANEMIA_MEAS + (1 | MOMID) + (1 | SITE), data = merged_df5)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))
SE
# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
round(results, 3)

extract_eq(mixed_model)

```

```{r}
ggplot(data = merged_df5) +
  geom_point(aes(x=diff_hb, y=M08_CBC_HB_LBORRES, 
                 color=SITE), 
             alpha = 0.4, size=1) 


ggplot(data = merged_df5) +
  geom_hex(aes(x=M08_CBC_HB_LBORRES, y=M06_SPHB_LBORRES)) + 
  geom_abline(slope = 1) +
  ylim(0,25)

```


