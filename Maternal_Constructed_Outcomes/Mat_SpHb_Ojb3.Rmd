---
title: "Mat_Sphb_Obj3"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, echo=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
library(haven)
library(lme4)
library(Matrix) # dependency for lme4
library(tableone)
library(kableExtra)
```

Import data: 
```{r}
path_to_data <-  'D:/Users/fouziafarooq/Documents/PRISMA_constructed-outcomes/data/2023-12-15/'# - for AWS data

UploadDate = "2023-12-15"
uploadDate <- as.Date(UploadDate, format = "%Y-%m-%d")
```

Pulling CSV files from AWS into a list:
```{r}
########################################################################################
recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
tic <- Sys.time()
if(recreate_mnh_list == TRUE){
  mnh_names <- c()
  list_mnh <- dir(path = path_to_data, pattern = "*.csv", full.names = TRUE) #creates a list of all the csv files in the directory
  for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
    form_name <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
    #basename() pulls out just the name of the file from the entire directory/path.
    print(paste("Reading", form_name))
    assign(form_name, read.csv(data_file))
    mnh_names <- c(mnh_names, form_name) # it's buidling up a vector of obj names.
  }
  save(list=mnh_names, file = paste0("MNH_dfs_", basename(path_to_data), ".RDS"))
} else{
  load(file = paste0('MNH_dfs_',  basename(path_to_data), ".RDS"))
}

toc <- Sys.time()
print(toc - tic)
```


### Hard code TYPE_VISIT for M00=1, M02=1, M03=1, M09=6, M10=6, M11=6, M17=6, M18=12 ***
```{r echo=FALSE}

if (exists("mnh00")) {
  mnh00 <- mnh00 %>% 
    mutate(M00_TYPE_VISIT = 1)
} else{
  "MNH00 dataframe doesn't exist"
}

if (exists("mnh02")) {
  mnh02 <- mnh02 %>% 
    mutate(M02_TYPE_VISIT = 1)
} else{
  "MNH02 dataframe doesn't exist"
}

if (exists("mnh03")) {
  mnh03 <- mnh03 %>% 
    mutate(M03_TYPE_VISIT = 1)
} else{
  "MNH03 dataframe doesn't exist"
}

if (exists("mnh09")) {
  mnh09 <- mnh09 %>% 
    mutate(M09_TYPE_VISIT = 6)
} else{
  "MNH09 dataframe doesn't exist"
}

if (exists("mnh10")) {
  mnh10 <- mnh10 %>% 
    mutate(M10_TYPE_VISIT = 6)
} else{
  "MNH10 dataframe doesn't exist"
}

if (exists("mnh11")) {
  mnh11 <- mnh11 %>% 
    mutate(M11_TYPE_VISIT = 6)
} else{
  "MNH11 dataframe doesn't exist"
}

if (exists("mnh16")) {
  mnh16 <- mnh16 %>% 
    mutate(M16_TYPE_VISIT = 5)
} else{
  "MNH16 dataframe doesn't exist"
}

if (exists("mnh17")) {
  mnh17 <- mnh17 %>% 
    mutate(M17_TYPE_VISIT = 6)
} else{
  "MNH17 dataframe doesn't exist"
}

if (exists("mnh18")) {
  mnh18 <- mnh18 %>% 
    mutate(M18_TYPE_VISIT = 12)
} else{
  "MNH18 dataframe doesn't exist"
}

if (exists("mnh19")) {
  mnh19 <- mnh19 %>% 
    mutate(M19_TYPE_VISIT = 13)
} else{
  "MNH19 dataframe doesn't exist"
}
```

Create a vector of women who are enrolled. 
```{r}
mnh02 <- mnh02 %>% 
  mutate(ENROLLED_FF = ifelse(M02_AGE_IEORRES==1 & M02_PC_IEORRES==1 & 
                                M02_CATCHMENT_IEORRES==1 & M02_CATCH_REMAIN_IEORRES==1 & 
                                M02_CONSENT_IEORRES==1, 1,0)) %>% filter(ENROLLED_FF ==1) # THIS DOES DROP SOME WOMEN!

unique <- mnh02 %>% group_by(SITE, PREGID) %>% unique()

enrolled_ids_vec <- as.vector(mnh02$PREGID)
```

Rename TYPE_VISIT variables:
```{r}
mnh02 <- mnh02 %>% rename(TYPE_VISIT = M02_TYPE_VISIT)
mnh05 <- mnh05 %>% rename(TYPE_VISIT = M05_TYPE_VISIT)
mnh06 <- mnh06 %>% rename(TYPE_VISIT = M06_TYPE_VISIT)
mnh08 <- mnh08 %>% rename(TYPE_VISIT = M08_TYPE_VISIT)
```

Clean up the data frames: 
```{r}
mnh02 <- mnh02 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)


mnh06 <- mnh06 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)

mnh08 <- mnh08 %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, TYPE_VISIT, .keep_all = TRUE)
```

Drop TYPE_VISIT in MNH02 (b/c  TYPE_VISIT=1 for all)
```{r}
mnh02 <- mnh02 %>% select(-TYPE_VISIT)
```

1. Arranging Based on Dates and Scheduled/Unscheduled visits:
This I might have to do for each MNH that is included.  FOr this analysis, I need MNH08 and MNH06 for now.  No need to worry about organizing other ones for now. 
```{r}
# mnh08_temp
mnh08 <- mnh08 %>% 
  # select(MOMID, PREGID, SITE, M08_LBSTDAT, TYPE_VISIT) %>%
 # filter(SITE=="Pakistan") %>%
  group_by(MOMID, PREGID) %>%
  arrange(M08_LBSTDAT) %>%
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M08_LBSTDAT)

temp_df <- mnh08 %>% select(SITE, MOMID, PREGID, M08_LBSTDAT, TYPE_VISIT) %>% 
  group_by(SITE, MOMID, PREGID)
temp_df <- mnh08 %>% select(SITE, MOMID, PREGID, M08_LBSTDAT, TYPE_VISIT, scheduled, visit_seq, prior_scheduled_visit_type, next_scheduled_visit_type) %>% 
  filter(TYPE_VISIT %in% c(13, 14))
```

Arrange Scheduled/Unscheduled visits for MNH06:
```{r}
mnh06 <- mnh06 %>% 
   # select(MOMID, PREGID, SITE, M06_DIAG_VSDAT, TYPE_VISIT) %>%
   # filter(SITE=="Pakistan") %>%
  group_by(MOMID, PREGID) %>%
  arrange(M06_DIAG_VSDAT) %>%
  mutate(visit_seq = row_number(),
         scheduled=if_else(TYPE_VISIT %in% c(13,14), "unscheduled", "scheduled"),
         prior_scheduled_visit_type = if_else(scheduled == 'scheduled', visit_seq, as.numeric(NA)),
         next_scheduled_visit_type = prior_scheduled_visit_type) %>% 
  fill(prior_scheduled_visit_type, .direction = "down") %>%
  fill(next_scheduled_visit_type, .direction = "up") %>% 
  mutate(prior_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), prior_scheduled_visit_type),
         next_scheduled_visit_type = if_else(scheduled == 'scheduled', as.numeric(NA), next_scheduled_visit_type)) %>% 
  arrange(MOMID, PREGID, M06_DIAG_VSDAT)
```

Merge MNH02, MNH08, MNH06 together:
```{r}
merged_df <- left_join(mnh02, mnh00, by = c("SITE", "SCRNID"))
merged_df <- left_join(merged_df, mnh08, by = c("SITE", "MOMID", "PREGID"))
merged_df2 <- left_join(merged_df, mnh05, by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT"))
temp_df <- merged_df %>% select(SITE, MOMID, PREGID, TYPE_VISIT, M08_LBSTDAT, M02_SCRN_OBSSTDAT, 
                                scheduled, visit_seq, prior_scheduled_visit_type, next_scheduled_visit_type)

merged_df3 <- full_join(merged_df2, mnh06, by = c("SITE", "MOMID", "PREGID", "TYPE_VISIT",
                                                 "scheduled", "visit_seq", "prior_scheduled_visit_type", "next_scheduled_visit_type"))

temp_df <- merged_df3 %>% select(SITE, MOMID, PREGID, TYPE_VISIT, M08_LBSTDAT, M02_SCRN_OBSSTDAT, M06_DIAG_VSDAT, 
                                 M08_CBC_LBPERF_1, M06_SPHB_LBORRES, 
                                 scheduled, visit_seq,
                                 prior_scheduled_visit_type,next_scheduled_visit_type) %>% 
  filter(MOMID == 'AZ-4173')

# temp_df <- merged_df2 %>% select(SITE, MOMID, PREGID, TYPE_VISIT, M08_LBSTDAT, M02_SCRN_OBSSTDAT, M06_DIAG_VSDAT, 
#                                  M08_CBC_LBPERF_1, M06_SPHB_LBORRES, 
#                                  scheduled.x, scheduled.y, visit_seq.x, visit_seq.y,
#                                  prior_scheduled_visit_type.x, prior_scheduled_visit_type.y,
#                                  next_scheduled_visit_type.x, next_scheduled_visit_type.y) %>% filter(MOMID == 'AZ-4173')
```

Count number of participants who have completed week 6 postpartum (VISIT 10)
```{r}
participant_count <- merged_df3 %>% 
  filter(TYPE_VISIT==10) %>% 
  group_by(SITE) %>%
  distinct(MOMID) %>%
  summarise(total_count_6wkPP = n())
 # summarise(count = n_distinct(MOMID))
```

```{r}
merged_df4 <- merged_df3 %>%
  filter(SITE %in% c("Pakistan", "Kenya", "Zambia"))
```

Since I only am doing analysis on a few time points (<20, 20, 28, 36 and 6 wk PP (only Pak had week 32 data also)) --> I can just filter this first. 
For now, I can leave UNSCHEDULED VISITS out.

```{r}
merged_df4 <- merged_df3 %>% filter(TYPE_VISIT %in% c(1,2,3,5,6))
temp_df <- merged_df4 %>% select(SITE, MOMID, TYPE_VISIT, M06_SPHB_LBORRES, M08_CBC_HB_LBORRES)
```

Set all -7, 77, -5, 55, etc to NA
```{r echo=FALSE}
CONVERT_NA <- TRUE
if(CONVERT_NA ==TRUE){
  tic <- Sys.time()
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1907-07-07", NA, d)
    })
  
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==-7, NA, d)
    })
  
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==77, NA, d)
    })
  
  # -5 IS MISSING FOR CONTINUOUS
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==-5, NA, d) 
    })
  
  # 55 IS MISSING FOR CATEGORICAL
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==55, NA, d) 
    })
  
  # 55:55 IS MISSING FOR TIME
  merged_df4 <- merged_df4 %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d=='55:55', NA, d)
    })
  
  toc <- Sys.time()
}
time_diff <- toc-tic
time_diff
```

Compute difference between SphB and CBC at each time point
```{r}
merged_df4 <- merged_df4 %>% 
  mutate(diff_hb = M06_SPHB_LBORRES - M08_CBC_HB_LBORRES)

temp_df <- merged_df4 %>% select(SITE, MOMID, TYPE_VISIT, M06_SPHB_LBORRES, M08_CBC_HB_LBORRES, diff_hb)
```

FACTORIZE TYPE_VISIT VARIABLE:
```{r}
merged_df4$TYPE_VISIT <- factor(merged_df4$TYPE_VISIT)
merged_df4$TYPE_VISIT <- relevel(merged_df4$TYPE_VISIT, ref = "1")
levels(merged_df4$TYPE_VISIT)
```

COMPUTE MATERNAL AGE CATEGORIES:
```{r}
merged_df4$M00_BRTHDAT <- as.Date(merged_df4$M00_BRTHDAT)
merged_df4$M02_SCRN_OBSSTDAT <- as.Date(merged_df4$M02_SCRN_OBSSTDAT)

#Age
merged_df4 <- merged_df4 %>% 
  mutate(
    mom_age_enroll = if_else(
      (!is.na(M02_SCRN_OBSSTDAT) & !is.na(M00_BRTHDAT)), ((as.numeric(M02_SCRN_OBSSTDAT) - as.numeric(M00_BRTHDAT)) %/% 365),
      if_else(!is.na(M00_ESTIMATED_AGE), M00_ESTIMATED_AGE, as.numeric(NA))))

merged_df4 <- merged_df4 %>% 
  mutate(
    #age below 18
    age_lt_18 = case_when(
      mom_age_enroll > 0 & mom_age_enroll < 18 ~ 1, 
      mom_age_enroll >= 18 ~ 0,
      TRUE ~ NA_real_
    ))

temp.df <- merged_df4 %>% select(SITE, MOMID, M02_SCRN_OBSSTDAT, M00_BRTHDAT, M00_ESTIMATED_AGE, mom_age_enroll, age_lt_18)
```

CALCULATE BMI:
```{r}
temp.df <- merged_df4 %>% filter(MOMID == 'AA-4424') %>% select(SITE, MOMID, TYPE_VISIT, M05_WEIGHT_PERES, M05_HEIGHT_PERES, mat_bmi_enroll)

merged_df4 <- merged_df4 %>% 
  group_by(MOMID) %>%
  mutate(mat_bmi_enroll = ifelse(
    TYPE_VISIT==1,
    ifelse(complete.cases(M05_WEIGHT_PERES, M05_HEIGHT_PERES),
           (M05_WEIGHT_PERES/((M05_HEIGHT_PERES/100)^2)), 
           as.numeric(NA)),
    NA_real_ # Default value if TYPE_VISIT!=1
    ))

merged_df4 <- merged_df4 %>%
  mutate(bmi_enroll_cat = case_when(
      mat_bmi_enroll < 18.5 ~ 1, #UNDERWEIGHT
      mat_bmi_enroll >= 18.5 & mat_bmi_enroll < 25 ~ 2, # NORMAL WEIGHT
      mat_bmi_enroll >= 25 & mat_bmi_enroll < 30 ~ 3, # OVERWEIGHT
      mat_bmi_enroll >= 30 ~ 4, # OBESE
      TRUE ~ NA_real_ # DEFAULT VALUE 
      ))

temp.df <- merged_df4 %>% 
  select(SITE, MOMID, TYPE_VISIT, M05_WEIGHT_PERES, M05_HEIGHT_PERES, mat_bmi_enroll, bmi_enroll_cat)

```

CALCULATE PLASMA EXPANSION VOLUME
Kaplan-Hakim formula:
PV (cPV) = (1-hematocrit)*[a +(b*weight in kg)] 
a=1,530 in males; a=864 in females
b=41 in males; b=47.9 in females
```{r}
merged_df4$pv_a <- 864 # a=1,530 in males; a=864 in females
merged_df4$pv_b <- 47.9 # b=41 in males; b=47.9 in females

merged_df4 <- merged_df4 %>% 
  mutate(
    (PV = (1-M08_CBC_HCT_LBORRES)*(pv_a + (pv_b * M05_WEIGHT_PERES)))
    )
```

```{r}
ggplot(data = merged_df4) +
  geom_point(aes(x=M08_CBC_HB_LBORRES, y=M06_SPHB_LBORRES, 
                 color=SITE), 
             alpha = 0.4, size=1) + 
  geom_abline(slope = 1) +
  ylim(6,17) +
  xlim(7,17)

ggplot(data = merged_df4) +
  geom_hex(aes(x=M08_CBC_HB_LBORRES, y=M06_SPHB_LBORRES)) + 
  geom_abline(slope = 1) +
  ylim(0,25)
```

```{r}
mean_cbc <- merged_df4 %>%
  group_by(TYPE_VISIT, SITE) %>%
  summarise(mean_cbc = mean(M08_CBC_HB_LBORRES, na.rm=TRUE))
```

```{r}
typevisit_analysis <- merged_df4 %>% 
  mutate(cbc_bin = cut(M08_CBC_HB_LBORRES, breaks = seq(0,23, by = 0.5)))

table(typevisit_analysis$cbc_bin)

mean_cbc_bin <- typevisit_analysis %>%
  group_by(cbc_bin) %>%
  summarise(mean_diff = mean(M06_SPHB_LBORRES - M08_CBC_HB_LBORRES, na.rm=TRUE))
```

```{r}
merged_df4 %>% ggplot() +
  geom_boxplot(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES)) + 
  geom_point(aes(x=TYPE_VISIT, y = M08_CBC_HB_LBORRES), alpha=0.2) 
```

Linear Mixed Modeling
```{r}
# Fit a linear mixed model
# specify random intercepts for MOMID and SITE (allows for individual variations withing MOMID and different intercepts for each SITE)
mixed_model <- lmer(diff_hb ~ TYPE_VISIT + (1 | MOMID) + (1 | SITE), data = merged_df4)

# LOOKING AT THE IMPACT OF SITE: 
mixed_model <- lmer(diff_hb ~ SITE + (1 | MOMID), data = merged_df4)

# LOOKING AT THE IMPACT OF MATERNAL AGE: 
mixed_model <- lmer(diff_hb ~ M00_ESTIMATED_AGE + (1 | MOMID) + (1 | SITE), data = merged_df4)

# LOOKING AT THE IMPACT OF MATERNAL BMI AT ENROLLMENT: 
mixed_model <- lmer(diff_hb ~ Mat_BMI_enroll + (1 | MOMID) + (1 | SITE), data = merged_df4)

# Get the model summary
summary(mixed_model)

# Extract fixed effects coefficients
fixed_effects <- fixef(mixed_model)
fixed_effects

# Compute Relative Risk
RR <- exp(fixed_effects)

# Get the standard errors of the fixed effects
SE <- sqrt(diag(vcov(mixed_model)))

# Compute 95% Confidence Interval for RR
lower_CI <- exp(fixed_effects - 1.96 * SE)
upper_CI <- exp(fixed_effects + 1.96 * SE)

# Display the Relative Risk and 95% CI
results <- data.frame(Relative_Risk = RR, Lower_CI = lower_CI, Upper_CI = upper_CI)
results
```

