---
title: "Mat_gHTN_tables"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output: html_document
---

---
title: "<span style='font-size: 18px'> <span style='text-align: center'> PRISMA-Maternal-Outcomes (Issued: `r Sys.Date()`)"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 4
  word_document:
    toc: yes
    toc_depth: '4'
  pdf_document:
    toc: yes
    toc_depth: '4'
    df_print: kable
always_allow_html: true

# knit: (function(inputFile, encoding) { 
#       out_dir <- 'output';
#       rmarkdown::render(inputFile,
#                         encoding=encoding, 
#                         output_file=file.path(dirname(inputFile), out_dir, 'PRISMA-Maternal-Outcomes-Report')) })
---

&nbsp;
&nbsp;
&nbsp;
&nbsp;


##### **Includes data from synapse last updated:** {.unlisted .unnumbered}
#####  2023-09-15 {.unlisted .unnumbered}


```{css, echo=FALSE}
.table caption {
  color: black;
  font-weight: bold;
}
```


```{r, data setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(knitr)
library(tidyverse)
library(reshape2)
library(lubridate)
library(kableExtra)
library(emo)
library(naniar)
library(dplyr)
library(RColorBrewer)
```

```{r}
# AMONG WOMEN WHO HAVE DELIVERED
htn_df <- read.csv('data_out/mat_htn_tables.csv', header = TRUE)
df <- htn_df # the file that is generated in 'Mat_gHTN_analysis.Rmd' -- run that first but make sure to subset on VISIT 3.
```
\newpage

### Chronic Hypertension
**Definition:** â‰¥140/90 mm Hg before pregnancy or <20th week of gestation or use of antihypertensive medication before pregnancy OR History of hypertension OR Taking antihypertensive medications

<br>
<br>

**Denominator:** Enrolled women who have a delivery date
<br>
<br>

Table 1: Prevalence of Chronic Hypertension
```{r}

temp.df <- df %>% select(MOMID, SITE, DELIVERED_FF, M06_BP_SYS_VSORRES_1_2, M06_BP_SYS_VSORRES_2_2, M06_BP_SYS_VSORRES_3_2,
                             M06_BP_DIA_VSORRES_1_2, M06_BP_DIA_VSORRES_2_2, M06_BP_DIA_VSORRES_3_2, meanSBP_ANC20, meanDBP_ANC20) %>% 
  filter(SITE=="Pakistan")

htn_table <- df %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    # SBP at enrollment (ANC LT20)
    "Missing SBP Enrollment, n (%)" =
      paste0(sum(is.na(meanSBP_ANC_LT20)),
             " (",
             format(round(sum(is.na(meanSBP_ANC_LT20))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP at enrollment (ANC LT20)
    "Missing DBP Enrollment, n (%)" =
      paste0(sum(is.na(meanDBP_ANC_LT20)),
             " (",
             format(round(sum(is.na(meanDBP_ANC_LT20))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # SBP AT ANC20
    "Missing SBP ANC20, n (%)" =
      paste0(sum(is.na(meanSBP_ANC20)),
             " (",
             format(round(sum(is.na(meanSBP_ANC20))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP AT ANC20
    "Missing DBP ANC20, n (%)" =
      paste0(sum(is.na(meanDBP_ANC20)),
             " (",
             format(round(sum(is.na(meanDBP_ANC20))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # SBP AT ANC28
    "Missing SBP ANC28, n (%)" =
      paste0(sum(is.na(meanSBP_ANC28)),
             " (",
             format(round(sum(is.na(meanSBP_ANC28))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP AT ANC28
    "Missing DBP ANC28, n (%)" =
      paste0(sum(is.na(meanDBP_ANC28)),
             " (",
             format(round(sum(is.na(meanDBP_ANC28))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # SBP AT ANC32
    "Missing SBP ANC32, n (%)" =
      paste0(sum(is.na(meanSBP_ANC32)),
             " (",
             format(round(sum(is.na(meanSBP_ANC32))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP AT ANC32
    "Missing DBP ANC32, n (%)" =
      paste0(sum(is.na(meanDBP_ANC32)),
             " (",
             format(round(sum(is.na(meanDBP_ANC32))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # SBP AT ANC36
    "Missing SBP ANC36, n (%)" =
      paste0(sum(is.na(meanSBP_ANC36)),
             " (",
             format(round(sum(is.na(meanSBP_ANC36))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP AT ANC36
    "Missing DBP ANC36, n (%)" =
      paste0(sum(is.na(meanDBP_ANC36)),
             " (",
             format(round(sum(is.na(meanDBP_ANC36))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # SBP AT IPC
    "Missing SBP IPC, n (%)" =
      paste0(sum(is.na(meanSBP_IPC)),
             " (",
             format(round(sum(is.na(meanSBP_IPC))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # DBP AT IPC
    "Missing DBP IPC, n (%)" =
      paste0(sum(is.na(meanDBP_IPC)),
             " (",
             format(round(sum(is.na(meanDBP_IPC))/n()*100, 2),nsmall=2, digits=3),
             ")"),
    
    # AT HOSPITALIZATION ALL ARE MISSING - DON'T SHOW.
    # # SBP AT ANC HOSP
    # "Missing SBP ANC Hospitalization, n (%)" =
    #   paste0(sum(is.na(meanSBP_Hosp_ANC)),
    #          " (",
    #          format(round(sum(is.na(meanSBP_Hosp_ANC))/n()*100, 2),nsmall=2, digits=3),
    #          ")"),
    # 
    # # DBP AT ANC HOSP
    # "Missing DBP ANC Hospitalization, n (%)" =
    #   paste0(sum(is.na(meanDBP_Hosp_ANC)),
    #          " (",
    #          format(round(sum(is.na(meanDBP_Hosp_ANC))/n()*100, 2),nsmall=2, digits=3),
    #          ")"),
    
    
    # OVERALL 
    # CHRONIC HYPERTENSION CATEGORIES:
    "cHTN = Yes " = 
      paste0(sum(CHRON_HYPER == 1, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN = No " = 
      paste0(sum(CHRON_HYPER == 0, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN = Missing " = 
      paste0(sum(is.na(CHRON_HYPER)),
             " (",
             format(round(sum(is.na(CHRON_HYPER))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    # CHRON_HYPER_MEAS
    "cHTN Measured = Yes " = 
      paste0(sum(CHRON_HYPER_MEAS == 1, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_MEAS == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Measured = No " = 
      paste0(sum(CHRON_HYPER_MEAS == 0, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_MEAS == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Measured = Missing " = 
      paste0(sum(is.na(CHRON_HYPER_MEAS)),
             " (",
             format(round(sum(is.na(CHRON_HYPER_MEAS))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    # CHRON_HYPER_TREAT
    "cHTN Treatment = Yes " = 
      paste0(sum(CHRON_HYPER_TREAT == 1, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_TREAT == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Treatment = No " = 
      paste0(sum(CHRON_HYPER_TREAT == 0, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_TREAT == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Treatment = Missing " = 
      paste0(sum(is.na(CHRON_HYPER_MEAS)),
             " (",
             format(round(sum(is.na(CHRON_HYPER_TREAT))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    # CHRON_HYPER_DIAG
    "cHTN Clinical Diagnosis = Yes " = 
      paste0(sum(CHRON_HYPER_DIAG == 1, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_DIAG == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Clinical Diagnosis = No " = 
      paste0(sum(CHRON_HYPER_DIAG == 0, na.rm = TRUE),
             " (",
             format(round(sum(CHRON_HYPER_DIAG == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "cHTN Clinical Diagnosis = Missing " = 
      paste0(sum(is.na(CHRON_HYPER_DIAG)),
             " (",
             format(round(sum(is.na(CHRON_HYPER_DIAG))/n()*100,2), nsmall=2, digits=3),
             ")")) %>%
  
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1)
    
```


```{r}
htn_table  %>% 
  `rownames<-` (c(
    "Missing SBP Enrollment, n (%)",
    "Missing DBP Enrollment, n (%)",
    "Missing SBP ANC20, n (%)",
    "Missing DBP ANC20, n (%)",
    "Missing SBP ANC28, n (%)",
    "Missing DBP ANC28, n (%)",
    "Missing SBP ANC32, n (%)",
    "Missing DBP ANC32, n (%)",
    "Missing SBP ANC36, n (%)",
    "Missing DBP ANC36, n (%)",
    "Missing SBP IPC, n (%)",
    "Missing DBP IPC, n (%)",
    "Yes, n (%)", # CHRON_HYPER DIAG + MEASURED + TREAT
    "No, n (%)", # 
    "Missing (Measured & Treatment & Clinical Diagnosis), n (%)",
    " Measured Yes, n (%)", # MEASURED
    "Measured No, n (%)",
    "Measured Missing, n (%)",
    "Treatment Yes, n (%)", # TREATMENT
    "Treatment No, n (%)",
    "Treatment Missing, n (%)",
    "Diagnosed Yes, n (%)", # diagnosed
    "Diagnosed No, n (%)",
    "Diagnosed Missing, n (%)")) %>%
  
  
  mutate_all(funs(str_replace(., "NaN", "0"))) %>% 
  kbl(caption = "", booktabs = TRUE) %>%
  kable_paper(bootstrap_options = "striped", 
              full_width = T, html_font = "Cambria", position = "left",
              latex_options = c("repeat_header", "HOLD_position")) %>% 
  kable_styling(font_size = 14) %>%
  row_spec(0, extra_css = "border-bottom: 0px white;") %>%
  
  pack_rows("Missing SBP and DBP variables (average of 3), n (%)", 1, 12, label_row_css = "color: steelblue;") %>%
  pack_rows("Chronic Hypertension at Category, n (%)", 13, 15, label_row_css = "color: steelblue;") %>% # WHAT DOES 5,6 HERE SAY? 
  pack_rows("Measured Chronic Hypertension at Enrollment Category, n (%)", 16, 18, label_row_css = "color: steelblue;") %>%
  pack_rows("On Treatment for Chronic Hypertension at Enrollment, n (%)", 19, 21, label_row_css = "color: steelblue;") %>%
  pack_rows("Clinical Diagnosis at Enrollment, n (%)", 22, 24, label_row_css = "color: steelblue;") 
  


 #"Missing M08_CBC_HB_LBORRES_1 = NA, n (%)",#%>% 
 # pack_rows("PRISMA measured birthweight (categorical), n (%)", 5, 8, label_row_css = "color: steelblue;") %>% 
  # pack_rows("Any method measured birthweight (categorical), n (%)", 9, 12, label_row_css = "color: steelblue;") 
```

\newpage

### Gestational Hypertension
**Definition:** A systolic blood pressure >140 mm Hg on two occasions at least 1 hour apart or diastolic blood pressure >90 mm Hg on two occasions at least 1 hour apart or among participants without chronic hypertension OR 
<br>
SBP>140 mmHg or DBP>90 mmHg at one occasion after 20 weeks gestation and treatment with medication. 


<br>
<br>

**Denominator:** Enrolled women who have a delivery date
<br>
<br>

Table 1: Prevalence of Chronic Hypertension
```{r}
htn_table <- df %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
 # OVERALL 
    # GESTATIONAL HYPERTENSION CATEGORIES:
    "gHTN = Yes " = 
      paste0(sum(GEST_HYPER == 1, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "gHTN = No " = 
      paste0(sum(GEST_HYPER == 0, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        "gHTN = Missing " = 
      paste0(sum(is.na(GEST_HYPER)),
             " (",
             format(round(sum(is.na(GEST_HYPER))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        # gHNT MEASURED 2+  CATEGORIES:
    #Measured gHTN at 2 visits after 20 weeks gestation, at ANC hosp. and at L&D
    " Gestational Hypertension (Measured 2+) = Yes " = 
      paste0(sum(GEST_HYPER_MEAS_ANY2 == 1, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS_ANY2 == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "Gestational Hypertension (Measured 2+) = No " = 
      paste0(sum(GEST_HYPER_MEAS_ANY2 == 0, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS_ANY2 == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        "Gestational Hypertension (Measured 2+) = Missing " = 
      paste0(sum(is.na(GEST_HYPER_MEAS_ANY2)),
             " (",
             format(round(sum(is.na(GEST_HYPER_MEAS_ANY2))/n()*100,2), nsmall=2, digits=3),
             ")"),

        # gHNT MEASURED 1 CATEGORIES:
    #Measured gHTN at 1 visit after 20 weeks gestation, at ANC hosp. and at L&D
    " Gestational Hypertension (Measured 1+) = Yes " = 
      paste0(sum(GEST_HYPER_MEAS_ANY1 == 1, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS_ANY1 == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "Gestational Hypertension (Measured 1+) = No " = 
      paste0(sum(GEST_HYPER_MEAS_ANY1 == 0, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS_ANY1 == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        "Gestational Hypertension (Measured 1+) = Missing " = 
      paste0(sum(is.na(GEST_HYPER_MEAS_ANY1)),
             " (",
             format(round(sum(is.na(GEST_HYPER_MEAS_ANY1))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
            # gHTN TREATED CATEGORIES:
    #Treatment assessed after 20 weeks gestation, at ANC hosp. and at L&D
   
     " Gestational Hypertension (Treatment) = Yes " = 
      paste0(sum(GEST_HYPER_TREAT == 1, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_TREAT == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "Gestational Hypertension (Treatment) = No " = 
      paste0(sum(GEST_HYPER_TREAT == 0, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_TREAT == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        "Gestational Hypertension (Treatment) = Missing " = 
      paste0(sum(is.na(GEST_HYPER_TREAT)),
             " (",
             format(round(sum(is.na(GEST_HYPER_TREAT))/n()*100,2), nsmall=2, digits=3),
             ")"),
    
                # gHTN MEASURED 1 + TREATED CATEGORIES:
    #Treatment assessed after 20 weeks gestation, at ANC hosp. and at L&D
    " Gestational Hypertension (Measured 1 + Treatment) = Yes " = 
      paste0(sum(GEST_HYPER_MEAS1_TREAT == 1, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS1_TREAT == 1, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
    "Gestational Hypertension (Measured 1 + Treatment) = No " = 
      paste0(sum(GEST_HYPER_MEAS1_TREAT == 0, na.rm = TRUE),
             " (",
             format(round(sum(GEST_HYPER_MEAS1_TREAT == 0, na.rm = TRUE)/n()*100,2), nsmall=2, digits=3),
             ")"),
    
        "Gestational Hypertension (Measured 1 + Treatment) = Missing " = 
      paste0(sum(is.na(GEST_HYPER_MEAS1_TREAT)),
             " (",
             format(round(sum(is.na(GEST_HYPER_MEAS1_TREAT))/n()*100,2), nsmall=2, digits=3),
             ")")) %>%

  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1)
    
```

    